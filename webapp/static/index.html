<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yandex Eda MiniApp (MVP)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/static/styles.v23.css?v=77" />
  <script src="/static/page-transitions.js"></script>
</head>
<body>
  <div class="container">
    <h2>–ì–ª–∞–≤–Ω–∞—è</h2>
    <div id="selections"></div>
    <div id="restaurants"></div>
    <div class="nav-container">
      <a id="navHome" href="#" class="nav-item active">
        <span class="nav-icon nav-icon-home"></span>
        <span>–ì–ª–∞–≤–Ω–æ–µ</span>
      </a>
      <span class="nav-item disabled">
        <span class="nav-icon nav-icon-promo"></span>
        <span>–ê–∫—Ü–∏–∏</span>
      </span>
      <a id="navCart" href="#" class="nav-item">
        <span class="nav-icon nav-icon-cart"></span>
        <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
      </a>
      <a id="navProfile" href="#" class="nav-item">
        <span class="nav-icon nav-icon-profile"></span>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
      </a>
    </div>
  </div>

  <script>
    const api = location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    const q = new URLSearchParams(location.search);
    const uid = (q.get('uid') && Number(q.get('uid'))) || tg?.initDataUnsafe?.user?.id || 0;
    const headers = uid ? { 'X-Telegram-User-Id': String(uid) } : {};
    const uidQ = uid ? ('?uid=' + encodeURIComponent(String(uid))) : '';
    
    // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
    function createCard(it) {
      const card = document.createElement('div');
      card.className = 'mini-card';
      
      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–±–æ—Ä–æ–∫
      let cardImage = it.image || 'https://via.placeholder.com/300x200?text=No+Image';
      let cardTitle = it.title;
      let cardSubtitle = '';
      
      // –ü–†–ò–û–†–ò–¢–ï–¢ –£ –ë–õ–Æ–î–ê: –µ—Å–ª–∏ –µ—Å—Ç—å dish, —Ç–æ —ç—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–ª—é–¥–∞
      if (it.dish) {
        cardImage = it.dish.image || it.image || '/static/placeholder-dish.jpg';
        cardTitle = it.title || it.dish.name;
        cardSubtitle = `${it.dish.price} ‚ÇΩ`;
        card.className = 'mini-card dish-card';
        console.log('Applied dish-card class to:', cardTitle);
      } else if (it.restaurant) {
        cardImage = it.restaurant.image || it.image || '/static/placeholder-restaurant.jpg';
        cardTitle = it.title || it.restaurant.name;
        cardSubtitle = `‚òÖ ${it.restaurant.rating ? it.restaurant.rating.toFixed(1) : '--'} ¬∑ ${it.restaurant.delivery_time_minutes || '--'} –º–∏–Ω`;
      }
      
      // –†–∞–∑–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –±–ª—é–¥ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
      if (it.dish) {
        card.innerHTML = `
          <img src="${cardImage}" alt="${cardTitle}" onerror="this.src='/static/placeholder-dish.jpg'"/>
          <div class="cap">${cardTitle}</div>
          <div class="subtitle">
            <span class="price">${it.dish.price} ‚ÇΩ</span>
          </div>
          <div class="restaurant-info">
            <span class="restaurant-name">${it.restaurant ? it.restaurant.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω'}</span>
          </div>
        `;
      } else {
        card.innerHTML = `
          <img src="${cardImage}" alt="${cardTitle}"/>
          <div class="cap">${cardTitle}</div>
          ${cardSubtitle ? `<div class="subtitle">${cardSubtitle}</div>` : ''}
        `;
      }
      
      return card;
    }
    
    async function loadSelections() {
      console.log('=== loadSelections started ===');
      const fallback = [
        { id: 1, title: '–í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', kind: 'dishes', items: [
          { title: '–ë—É—Ä–≥–µ—Ä', image: '/static/placeholder-dish.jpg', dish_id: 102, restaurant_id: 1 },
          { title: '–ú–∞—Ä–≥–∞—Ä–∏—Ç–∞', image: '/static/placeholder-dish.jpg', dish_id: 201, restaurant_id: 2 },
          { title: '–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', image: '/static/placeholder-dish.jpg', dish_id: 401, restaurant_id: 4 },
          { title: '–ü–µ–ø–ø–µ—Ä–æ–Ω–∏', image: '/static/placeholder-dish.jpg', dish_id: 301, restaurant_id: 3 },
        ]},
        { id: 2, title: '–¢–æ–ø-—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã', kind: 'restaurants', items: [
          { title: '–í–∫—É—Å–Ω–æ –∏ —Ç–æ—á–∫–∞', image: '/static/placeholder-restaurant.jpg', restaurant_id: 1 },
          { title: '–ß–∏–±–±–∏—Å', image: '/static/placeholder-restaurant.jpg', restaurant_id: 2 },
          { title: '–ü–∏—Ü—Ü–µ—Ä–∏—è –ë—Ä–∞–≤–æ', image: '/static/placeholder-restaurant.jpg', restaurant_id: 3 },
          { title: '–°—É—à–∏–ú–∞–Ω–∏—è', image: '/static/placeholder-restaurant.jpg', restaurant_id: 4 },
        ]}
      ];
      try {
        // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫–∏ –∏–∑ –Ω–æ–≤–æ–≥–æ API
        console.log('Fetching collections from:', api + '/public/collections');
        const collectionsRes = await fetch(api + '/public/collections');
        console.log('Collections response:', collectionsRes.status, collectionsRes.ok);
        let data = [];
        
        if (collectionsRes.ok) {
          const collections = await collectionsRes.json();
          console.log('Collections data:', collections);
          if (collections && collections.length > 0) {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–¥–±–æ—Ä–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            data = collections.map(collection => ({
              id: collection.id,
              title: collection.name,
              description: collection.description,
              image: collection.image,
              kind: 'mixed', // –°–º–µ—à–∞–Ω–Ω—ã–π —Ç–∏–ø (—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –±–ª—é–¥–∞)
              items: collection.items.map(item => ({
                id: item.id,
                title: item.title,
                subtitle: item.subtitle,
                image: item.image,
                type: item.type,
                item_id: item.item_id,
                restaurant: item.restaurant,
                dish: item.dish
              }))
            }));
          }
        }
        
        // –ï—Å–ª–∏ –ø–æ–¥–±–æ—Ä–æ–∫ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π API –∏–ª–∏ fallback
        if (data.length === 0) {
          console.log('No collections found, trying old API');
          const res = await fetch(api + '/selections');
          let oldData = await res.json();
          console.log('Old API data:', oldData);
          if (!Array.isArray(oldData) || oldData.length === 0) {
            console.log('Using fallback data');
            data = fallback;
          } else {
            console.log('Using old API data');
            data = oldData;
          }
        }
        console.log('Final data to render:', data);
        const root = document.getElementById('selections');
        root.innerHTML = '';
        data.forEach(block => {
          console.log('Rendering block:', block);
          const sec = document.createElement('div');
          sec.className = 'section';
          
          // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
          sec.innerHTML = `<div class="title">${block.title}</div>`;
          
          const row = document.createElement('div');
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤–º–µ—Å—Ç–æ –∫–∞—Ä—É—Å–µ–ª–∏
          const isCarousel = false;
          if (isCarousel) {
            row.className = 'carousel';
            const track = document.createElement('div');
            track.className = 'carousel-track';
            let currentIndex = 0;
            const items = block.items;
            
            if (items.length === 0) {
              // –ï—Å–ª–∏ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
              row.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ø–æ–¥–±–æ—Ä–∫–µ</div>';
              return;
            }
            
            const goToSlide = (index) => {
              currentIndex = index;
              track.style.transform = `translateX(-${index * 100}%)`;
            };
            
            const nextSlide = () => {
              currentIndex = (currentIndex + 1) % items.length;
              goToSlide(currentIndex);
            };
            
            const prevSlide = () => {
              currentIndex = (currentIndex - 1 + items.length) % items.length;
              goToSlide(currentIndex);
            };
            
            const prev = document.createElement('button');
            prev.className = 'carousel-btn prev';
            prev.textContent = '‚Äπ';
            prev.onclick = prevSlide;
            
            const next = document.createElement('button');
            next.className = 'carousel-btn next';
            next.textContent = '‚Ä∫';
            next.onclick = nextSlide;
            
            row.appendChild(track);
            row.appendChild(prev);
            row.appendChild(next);
            
            items.forEach((it, idx) => {
               const card = createCard(it);
               card.onclick = () => {
                 const p = new URLSearchParams(location.search);
                 if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
                 
                 // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–±–æ—Ä–æ–∫
                 if (it.type === 'dish' && it.item_id) {
                   location.href = '/static/dish.html?id=' + it.item_id + '&' + p.toString();
                 } else if (it.type === 'restaurant' && it.item_id) {
                   location.href = '/static/restaurant.html?id=' + it.item_id + '&' + p.toString();
                 } else if (block.kind === 'dishes' && it.dish_id) {
                   location.href = '/static/dish.html?id=' + it.dish_id + '&' + p.toString();
                 } else if (it.restaurant_id) {
                   location.href = '/static/restaurant.html?id=' + it.restaurant_id + '&' + p.toString();
                 }
               };
               track.appendChild(card);
             });
            // swipe support
            let startX = 0; let dx = 0; let dragging = false;
            row.addEventListener('touchstart', (e) => { 
              dragging = true; 
              startX = e.touches[0].clientX; 
              dx = 0; 
            }, {passive:true});
            
            row.addEventListener('touchmove', (e) => { 
              if (!dragging) return; 
              dx = e.touches[0].clientX - startX; 
              track.style.transform = `translateX(-${currentIndex * 100 + dx / row.clientWidth * 100}%)`; 
            }, {passive:true});
            
            row.addEventListener('touchend', () => { 
              dragging = false; 
              if (Math.abs(dx) > row.clientWidth * 0.2) { 
                if (dx < 0) {
                  nextSlide();
                } else {
                  prevSlide();
                }
              } else { 
                goToSlide(currentIndex);
              } 
            });
            
            // init - –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            goToSlide(0);
          } else {
            row.className = 'hscroll';
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            console.log('Processing block:', block.title, 'items:', block.items);
            block.items.forEach((it, index) => {
              console.log(`Item ${index}:`, it);
              
              // –ü–†–ò–û–†–ò–¢–ï–¢ –£ –ë–õ–Æ–î–ê: –µ—Å–ª–∏ –µ—Å—Ç—å dish, —Ç–æ —ç—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–ª—é–¥–∞
              if (it.dish || it.type === 'dish') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é createCard –¥–ª—è –±–ª—é–¥
                const card = createCard(it);
                card.onclick = () => {
                  const p = new URLSearchParams(location.search);
                  if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
                  
                  if (it.type === 'dish' && it.item_id) {
                    location.href = '/static/dish.html?id=' + it.item_id + '&' + p.toString();
                  } else if (block.kind === 'dishes' && it.dish_id) {
                    location.href = '/static/dish.html?id=' + it.dish_id + '&' + p.toString();
                  }
                };
                row.appendChild(card);
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –±–ª—é–¥
              }
              
              // –î–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
              const card = document.createElement('div');
              card.className = 'restaurant-card';
              
              // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
              let restaurantData = null;
              console.log('Checking item conditions:', {
                hasRestaurant: !!it.restaurant,
                type: it.type,
                item_id: it.item_id,
                restaurant_id: it.restaurant_id
              });
              
              if ((it.type === 'restaurant' && it.item_id) || it.restaurant_id) {
                const restaurantId = it.item_id || it.restaurant_id;
                console.log('Loading restaurant data from API for ID:', restaurantId);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ it.restaurant –∏–ª–∏ it, –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                const baseData = it.restaurant || it;
                restaurantData = { 
                  id: restaurantId, 
                  name: baseData.name || it.title, 
                  image: baseData.image || it.image, 
                  rating_agg: null, 
                  delivery_time_minutes: null 
                };
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
                console.log('Loading restaurant data for ID:', restaurantId);
                fetch(api + '/restaurants/' + restaurantId + (uid ? ('?uid=' + uid) : ''), { headers })
                  .then(res => {
                    console.log('Restaurant API response:', res.status, res.ok);
                    return res.ok ? res.json() : null;
                  })
                  .then(data => {
                    console.log('Restaurant data loaded:', data);
                    if (data) {
                      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                      const ratingElement = card.querySelector('.rating-value');
                      const deliveryElement = card.querySelector('.delivery-time');
                      const imageElement = card.querySelector('img');
                      
                      if (ratingElement) {
                        ratingElement.textContent = data.rating_agg ? data.rating_agg.toFixed(1) : '--';
                        console.log('Updated rating:', data.rating_agg);
                      }
                      if (deliveryElement) {
                        deliveryElement.textContent = `${data.delivery_time_minutes || '--'} –º–∏–Ω`;
                        console.log('Updated delivery time:', data.delivery_time_minutes);
                      }
                      if (imageElement && data.image) {
                        imageElement.src = data.image;
                        console.log('Updated image:', data.image);
                      }
                      
                    }
                  })
                  .catch(error => console.error('Error loading restaurant data:', error));
              }
              
              if (restaurantData) {
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –≤ —Å—Ç–∏–ª–µ –Ø–Ω–¥–µ–∫—Å –ï–¥–∞
                card.innerHTML = `
                  <div class="restaurant-image">
                    <img src="${restaurantData.image || '/static/placeholder-restaurant.jpg'}" alt="${restaurantData.name}"/>
                  </div>
                  <div class="restaurant-info">
                    <div class="restaurant-details">
                      <h4 class="restaurant-name">${restaurantData.name}</h4>
                      <div class="delivery-info">
                        <span class="delivery-icon">üöö</span>
                        <span class="delivery-time">${restaurantData.delivery_time_minutes || '--'} –º–∏–Ω</span>
                      </div>
                    </div>
                    <div class="restaurant-rating">
                      <span class="rating-stars">‚òÖ</span>
                      <span class="rating-value">${restaurantData.rating_agg ? restaurantData.rating_agg.toFixed(1) : '--'}</span>
                    </div>
                  </div>
                `;
                
                card.onclick = () => {
                  const p = new URLSearchParams(location.search);
                  if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
                  location.href = '/static/restaurant.html?id=' + restaurantData.id + '&' + p.toString();
                };
              }
              
              row.appendChild(card);
            });
          }
          sec.appendChild(row);
          root.appendChild(sec);
        });
      } catch {
        const root = document.getElementById('selections');
        root.innerHTML = '';
        fallback.forEach(block => {
          const sec = document.createElement('div');
          sec.className = 'section';
          sec.innerHTML = `<div class="title">${block.title}</div>`;
          const row = document.createElement('div');
          row.className = 'hscroll';
          block.items.forEach(it => {
            const card = document.createElement('div');
            card.className = 'restaurant-card';
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è fallback
            card.innerHTML = `
              <div class="restaurant-image">
                <img src="${it.image || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${it.title}"/>
              </div>
              <div class="restaurant-info">
                <div class="restaurant-details">
                  <h4 class="restaurant-name">${it.title}</h4>
                  <div class="delivery-info">
                    <span class="delivery-icon">üöö</span>
                    <span class="delivery-time">30 –º–∏–Ω</span>
                  </div>
                </div>
                <div class="restaurant-rating">
                  <span class="rating-stars">‚òÖ</span>
                  <span class="rating-value">4.5</span>
                </div>
              </div>
            `;
            
            card.onclick = () => {
              const p = new URLSearchParams(location.search);
              if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
              
              if (it.dish_id) {
                location.href = '/static/dish.html?id=' + it.dish_id + '&' + p.toString();
              } else if (it.restaurant_id) {
                location.href = '/static/restaurant.html?id=' + it.restaurant_id + '&' + p.toString();
              }
            };
            row.appendChild(card);
          });
          sec.appendChild(row);
          root.appendChild(sec);
        });
      }
    }
    async function loadRestaurants() {
      const res = await fetch(api + '/restaurants', { headers });
      const data = await res.json();
      const root = document.getElementById('restaurants');
      root.innerHTML = '';
      data.forEach(r => {
        const el = document.createElement('div');
        el.className = 'rest-card';
        el.innerHTML = `
          <div class="thumb"><img src="${r.image || '/static/placeholder-restaurant.jpg'}" alt="${r.name}"/></div>
          <div class="desc">
            <div class="title">${r.name}</div>
            <div class="meta">‚âà ${r.delivery_time_minutes || '--'} –º–∏–Ω ¬∑ ‚òÖ ${r.rating_agg ? r.rating_agg.toFixed(1) : '--'}</div>
          </div>`;
        el.onclick = () => openMenu(r.id);
        root.appendChild(el);
      });
    }

    async function openMenu(restaurantId) {
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      location.href = `/static/restaurant.html?id=${restaurantId}&${p.toString()}`;
    }

    loadSelections();
    loadRestaurants();
    

    document.getElementById('navHome').onclick = (e) => { e.preventDefault(); const p = new URLSearchParams(location.search); if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); location.href = '/static/index.html?' + p.toString(); };
    document.getElementById('navCart').onclick = (e) => { e.preventDefault(); const p = new URLSearchParams(location.search); if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); location.href = '/static/cart.html?' + p.toString(); };
    document.getElementById('navProfile').onclick = (e) => { e.preventDefault(); const p = new URLSearchParams(location.search); if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); location.href = '/static/profile.html?' + p.toString(); };

    
  </script>
</body>
</html>

