<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Yandex Eda MiniApp (MVP)</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/static/styles.v23.css?v=82" />
  <script src="/static/page-transitions.js"></script>
  <script src="/static/loading-system.js"></script>
  <script src="/static/preload-system.js"></script>
  <script src="/static/micro-animations.js"></script>
  <script src="/static/toast-system.js"></script>
</head>
<body>
  <div class="container">
    <h2>–ì–ª–∞–≤–Ω–∞—è</h2>
    <div id="selections"></div>
    <div id="restaurants"></div>
    <div class="nav-container">
      <a id="navHome" href="#" class="nav-item active">
        <span class="nav-icon nav-icon-home"></span>
        <span>–ì–ª–∞–≤–Ω–æ–µ</span>
      </a>
      <span class="nav-item disabled">
        <span class="nav-icon nav-icon-promo"></span>
        <span>–ê–∫—Ü–∏–∏</span>
      </span>
      <a id="navCart" href="#" class="nav-item">
        <span class="nav-icon nav-icon-cart"></span>
        <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
      </a>
      <a id="navProfile" href="#" class="nav-item">
        <span class="nav-icon nav-icon-profile"></span>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
      </a>
    </div>
  </div>

  <script>
    const api = location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    const q = new URLSearchParams(location.search);
    const uid = (q.get('uid') && Number(q.get('uid'))) || tg?.initDataUnsafe?.user?.id || 0;
    const headers = uid ? { 'X-Telegram-User-Id': String(uid) } : {};
    const uidQ = uid ? ('?uid=' + encodeURIComponent(String(uid))) : '';
    
    // –ö—ç—à –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const imageCache = new Map();
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å retry
    function preloadImage(src, retries = 3) {
      if (imageCache.has(src)) {
        return Promise.resolve(imageCache.get(src));
      }
      
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
          imageCache.set(src, img);
          resolve(img);
        };
        img.onerror = () => {
          if (retries > 0) {
            console.log(`Retrying image load: ${src}, attempts left: ${retries}`);
            setTimeout(() => {
              preloadImage(src, retries - 1).then(resolve).catch(reject);
            }, 1000);
          } else {
            console.warn(`Failed to load image after all retries: ${src}`);
            reject(new Error(`Failed to load image: ${src}`));
          }
        };
        img.src = src;
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function safeImageLoad(imgElement, src) {
      if (!src) {
        imgElement.style.display = 'none';
        return;
      }
      
      imgElement.onload = () => {
        imgElement.style.display = '';
      };
      
      imgElement.onerror = () => {
        console.warn(`Image failed to load: ${src}`);
        imgElement.style.display = 'none';
      };
      
      imgElement.src = src;
    }
    
    // –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
    function createCard(it) {
      const card = document.createElement('div');
      card.className = 'mini-card';
      
      // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–±–æ—Ä–æ–∫
      let cardImage = it.image;
      let cardTitle = it.title;
      let cardSubtitle = '';
      
      // –ü–†–ò–û–†–ò–¢–ï–¢ –£ –ë–õ–Æ–î–ê: –µ—Å–ª–∏ –µ—Å—Ç—å dish, —Ç–æ —ç—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–ª—é–¥–∞
      if (it.dish) {
        cardImage = it.image; // –¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏
        cardTitle = it.title || it.dish.name;
        cardSubtitle = `${it.dish.price} ‚ÇΩ`;
        card.className = 'mini-card dish-card';
        console.log('Applied dish-card class to:', cardTitle);
      } else if (it.restaurant) {
        cardImage = it.image; // –¢–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏
        cardTitle = it.title || it.restaurant.name;
        console.log('Restaurant data:', it.restaurant.name, 'rating:', it.restaurant.rating);
        cardSubtitle = `‚òÖ ${it.restaurant.rating ? it.restaurant.rating.toFixed(1) : '--'} ¬∑ ${it.restaurant.delivery_time_minutes || '--'} –º–∏–Ω`;
      }
      
      // –†–∞–∑–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –±–ª—é–¥ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
      if (it.dish) {
        card.innerHTML = `
          ${cardImage ? `<img alt="${cardTitle}"/>` : ''}
          <div class="cap">${cardTitle}</div>
          <div class="subtitle">
            <span class="price">${it.dish.price} ‚ÇΩ</span>
          </div>
          <div class="restaurant-info">
            <span class="restaurant-name">${it.restaurant ? it.restaurant.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω'}</span>
          </div>
        `;
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (cardImage) {
          const img = card.querySelector('img');
          safeImageLoad(img, cardImage);
        }
      } else {
        card.innerHTML = `
          ${cardImage ? `<img alt="${cardTitle}"/>` : ''}
          <div class="cap">${cardTitle}</div>
          ${cardSubtitle ? `<div class="subtitle">${cardSubtitle}</div>` : ''}
        `;
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (cardImage) {
          const img = card.querySelector('img');
          safeImageLoad(img, cardImage);
        }
      }
      
      return card;
    }
    
    async function loadSelections() {
      console.log('=== loadSelections started ===');
      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º skeleton –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
        LoadingSystem.showSkeleton('selections', 'grid', 4);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–±–æ—Ä–∫–∏ –∏–∑ API
        const collectionsRes = await fetch(api + '/public/collections');
        console.log('Collections response:', collectionsRes.status, collectionsRes.ok);
        let data = [];
        
        if (collectionsRes.ok) {
          const collections = await collectionsRes.json();
          console.log('Collections data:', collections);
          if (collections && collections.length > 0) {
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–π—Ç–∏–Ω–≥–∞—Ö
            collections.forEach(collection => {
              console.log(`Collection: ${collection.name}`);
              collection.items.forEach(item => {
                if (item.restaurant) {
                  console.log(`  Restaurant: ${item.restaurant.name} - Rating: ${item.restaurant.rating}`);
                }
              });
            });
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –ø–æ–¥–±–æ—Ä–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            data = collections.map(collection => ({
              id: collection.id,
              title: collection.name,
              description: collection.description,
              image: collection.image,
              kind: 'mixed', // –°–º–µ—à–∞–Ω–Ω—ã–π —Ç–∏–ø (—Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –±–ª—é–¥–∞)
              items: collection.items.map(item => ({
                id: item.id,
                title: item.title,
                subtitle: item.subtitle,
                image: item.image,
                type: item.type,
                item_id: item.item_id,
                restaurant: item.restaurant,
                dish: item.dish
              }))
            }));
          }
        }
        
        // –ï—Å–ª–∏ –ø–æ–¥–±–æ—Ä–æ–∫ –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º empty state
        if (data.length === 0) {
          console.log('No collections found - showing empty');
          LoadingSystem.showEmpty('selections', '–ü–æ–¥–±–æ—Ä–∫–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã', 'üìã');
          return;
        }
        
        console.log('Final data to render:', data);
        const root = document.getElementById('selections');
        root.innerHTML = '';
        data.forEach(block => {
          console.log('Rendering block:', block);
          const sec = document.createElement('div');
          sec.className = 'section';
          
          // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
          sec.innerHTML = `<div class="title">${block.title}</div>`;
          
          const row = document.createElement('div');
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –≤–º–µ—Å—Ç–æ –∫–∞—Ä—É—Å–µ–ª–∏
          const isCarousel = false;
          if (isCarousel) {
            row.className = 'carousel';
            const track = document.createElement('div');
            track.className = 'carousel-track';
            let currentIndex = 0;
            const items = block.items;
            
            if (items.length === 0) {
              // –ï—Å–ª–∏ –Ω–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
              row.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ø–æ–¥–±–æ—Ä–∫–µ</div>';
              return;
            }
            
            const goToSlide = (index) => {
              currentIndex = index;
              track.style.transform = `translateX(-${index * 100}%)`;
            };
            
            const nextSlide = () => {
              currentIndex = (currentIndex + 1) % items.length;
              goToSlide(currentIndex);
            };
            
            const prevSlide = () => {
              currentIndex = (currentIndex - 1 + items.length) % items.length;
              goToSlide(currentIndex);
            };
            
            const prev = document.createElement('button');
            prev.className = 'carousel-btn prev';
            prev.textContent = '‚Äπ';
            prev.onclick = prevSlide;
            
            const next = document.createElement('button');
            next.className = 'carousel-btn next';
            next.textContent = '‚Ä∫';
            next.onclick = nextSlide;
            
            row.appendChild(track);
            row.appendChild(prev);
            row.appendChild(next);
            
            items.forEach((it, idx) => {
               const card = createCard(it);
               card.onclick = () => {
                 const p = new URLSearchParams(location.search);
                 if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
                 
                 // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤—ã—Ö —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–¥–±–æ—Ä–æ–∫
                 if (it.type === 'dish' && it.item_id) {
                   location.href = '/static/dish.html?id=' + it.item_id + '&' + p.toString();
                 } else if (it.type === 'restaurant' && it.item_id) {
                   console.log('=== Block item clicked (restaurant) ===');
                   console.log('Restaurant ID:', it.item_id);
                   console.log('Current scroll position before click:', window.pageYOffset || document.documentElement.scrollTop);
                   goToRestaurant(it.item_id);
                 } else if (block.kind === 'dishes' && it.dish_id) {
                   location.href = '/static/dish.html?id=' + it.dish_id + '&' + p.toString();
                 } else if (it.restaurant_id) {
                   console.log('=== Block item clicked (restaurant by restaurant_id) ===');
                   console.log('Restaurant ID:', it.restaurant_id);
                   console.log('Current scroll position before click:', window.pageYOffset || document.documentElement.scrollTop);
                   goToRestaurant(it.restaurant_id);
                 }
                 
                 // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≤—è–∑–∫–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
                 console.log('Block item onclick handler bound for:', it.title || it.name || 'unknown');
               };
               track.appendChild(card);
             });
            // swipe support
            let startX = 0; let dx = 0; let dragging = false;
            row.addEventListener('touchstart', (e) => { 
              dragging = true; 
              startX = e.touches[0].clientX; 
              dx = 0; 
            }, {passive:true});
            
            row.addEventListener('touchmove', (e) => { 
              if (!dragging) return; 
              dx = e.touches[0].clientX - startX; 
              track.style.transform = `translateX(-${currentIndex * 100 + dx / row.clientWidth * 100}%)`; 
            }, {passive:true});
            
            row.addEventListener('touchend', () => { 
              dragging = false; 
              if (Math.abs(dx) > row.clientWidth * 0.2) { 
                if (dx < 0) {
                  nextSlide();
                } else {
                  prevSlide();
                }
              } else { 
                goToSlide(currentIndex);
              } 
            });
            
            // init - –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            goToSlide(0);
          } else {
            row.className = 'hscroll';
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
            console.log('Processing block:', block.title, 'items:', block.items);
            block.items.forEach((it, index) => {
              console.log(`Item ${index}:`, it);
              
              // –ü–†–ò–û–†–ò–¢–ï–¢ –£ –ë–õ–Æ–î–ê: –µ—Å–ª–∏ –µ—Å—Ç—å dish, —Ç–æ —ç—Ç–æ –∫–∞—Ä—Ç–æ—á–∫–∞ –±–ª—é–¥–∞
              if (it.dish || it.type === 'dish') {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é createCard –¥–ª—è –±–ª—é–¥
                const card = createCard(it);
                card.onclick = () => {
                  const p = new URLSearchParams(location.search);
                  if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
                  
                  if (it.type === 'dish' && it.item_id) {
                    location.href = '/static/dish.html?id=' + it.item_id + '&' + p.toString();
                  } else if (block.kind === 'dishes' && it.dish_id) {
                    location.href = '/static/dish.html?id=' + it.dish_id + '&' + p.toString();
                  }
                };
                row.appendChild(card);
                return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –¥–ª—è –±–ª—é–¥
              }
              
              // –î–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ —Å–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
              const card = document.createElement('div');
              card.className = 'restaurant-card';
              
              // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
              let restaurantData = null;
              console.log('Checking item conditions:', {
                hasRestaurant: !!it.restaurant,
                type: it.type,
                item_id: it.item_id,
                restaurant_id: it.restaurant_id
              });
              
              if ((it.type === 'restaurant' && it.item_id) || it.restaurant_id) {
                const restaurantId = it.item_id || it.restaurant_id;
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ it.restaurant –∏–ª–∏ it
                const baseData = it.restaurant || it;
                restaurantData = { 
                  id: restaurantId, 
                  name: baseData.name || it.title, 
                  image: baseData.image || it.image, 
                  rating: baseData.rating || null, 
                  delivery_time_minutes: baseData.delivery_time_minutes || null 
                };
              }
              
              if (restaurantData) {
                // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –≤ —Å—Ç–∏–ª–µ –Ø–Ω–¥–µ–∫—Å –ï–¥–∞
                card.innerHTML = `
                  <div class="restaurant-image">
                    ${restaurantData.image ? `<img alt="${restaurantData.name}"/>` : ''}
                  </div>
                  <div class="restaurant-info">
                    <div class="restaurant-details">
                      <h4 class="restaurant-name">${restaurantData.name}</h4>
                      <div class="delivery-info">
                        <span class="delivery-icon">üöö</span>
                        <span class="delivery-time">${restaurantData.delivery_time_minutes || '--'} –º–∏–Ω</span>
                      </div>
                    </div>
                    <div class="restaurant-rating">
                      <span class="rating-stars">‚òÖ</span>
                      <span class="rating-value">${restaurantData.rating ? restaurantData.rating.toFixed(1) : '--'}</span>
                    </div>
                  </div>
                `;
                
                // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                if (restaurantData.image) {
                  const img = card.querySelector('img');
                  safeImageLoad(img, restaurantData.image);
                }
                
                card.onclick = () => {
                  console.log('=== Restaurant card clicked ===');
                  console.log('Restaurant ID:', restaurantData.id);
                  console.log('Current scroll position before click:', window.pageYOffset || document.documentElement.scrollTop);
                  goToRestaurant(restaurantData.id);
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≤—è–∑–∫–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
                console.log('Restaurant card onclick handler bound for ID:', restaurantData.id);
              }
              
              row.appendChild(card);
            });
          }
          sec.appendChild(row);
          root.appendChild(sec);
        });
      } catch (error) {
        console.error('Error loading selections:', error);
        LoadingSystem.showError('selections', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–±–æ—Ä–æ–∫', loadSelections);
      }
    }
    async function loadRestaurants() {
      console.log('=== loadRestaurants() called ===');
      try {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º skeleton –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
        LoadingSystem.showSkeleton('restaurants', 'restaurant', 6);
        
        // console.log('Fetching restaurants from:', api + '/restaurants');
        const res = await fetch(api + '/restaurants', { headers });
        console.log('Restaurants API response:', res.status, res.ok);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        console.log('Restaurants data:', data);
        
        if (data.length === 0) {
          LoadingSystem.showEmpty('restaurants', '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'üçΩÔ∏è');
          return;
        }
        
        const root = document.getElementById('restaurants');
        root.innerHTML = '';
        // console.log('Rendering restaurants, count:', data.length);
        
        data.forEach(r => {
          const el = document.createElement('div');
          el.className = 'rest-card';
          el.innerHTML = `
            <div class="thumb">${r.image ? `<img alt="${r.name}"/>` : ''}</div>
            <div class="desc">
              <div class="title">${r.name}</div>
              <div class="meta">‚âà ${r.delivery_time_minutes || '--'} –º–∏–Ω ¬∑ ‚òÖ ${r.rating_agg ? r.rating_agg.toFixed(1) : '--'}</div>
            </div>`;
          
          // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          if (r.image) {
            const img = el.querySelector('img');
            safeImageLoad(img, r.image);
          }
          
          // –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º goToRestaurant –≤–º–µ—Å—Ç–æ openMenu
          el.onclick = () => {
            console.log('=== Restaurant card clicked ===');
            console.log('Restaurant ID:', r.id);
            console.log('Current scroll position before click:', window.pageYOffset || document.documentElement.scrollTop);
            goToRestaurant(r.id);
          };
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–∏–≤—è–∑–∫–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞
          console.log('Restaurant card onclick handler bound for ID:', r.id);
          
          root.appendChild(el);
        });
        
        console.log('=== loadRestaurants() completed successfully ===');
      } catch (error) {
        console.error('Error loading restaurants:', error);
        console.log('=== loadRestaurants() failed ===');
        LoadingSystem.showError('restaurants', '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤', loadRestaurants);
      }
    }

    async function openMenu(restaurantId) {
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      location.href = `/static/restaurant.html?id=${restaurantId}&${p.toString()}`;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    function goToRestaurant(restaurantId) {
      const currentScrollPosition = window.pageYOffset || document.documentElement.scrollTop;
      console.log('=== goToRestaurant called ===');
      console.log('Restaurant ID:', restaurantId);
      console.log('Current scroll position:', currentScrollPosition);
      console.log('Document scroll height:', document.documentElement.scrollHeight);
      console.log('Window height:', window.innerHeight);
      
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      p.set('scroll_position', currentScrollPosition.toString());
      p.set('from', 'index'); // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ —Å –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      
      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã id –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
      p.delete('id');
      p.set('id', restaurantId.toString());
      
      const finalUrl = `/static/restaurant.html?${p.toString()}`;
      console.log('Final URL:', finalUrl);
      console.log('URL params:', p.toString());
      
      location.href = finalUrl;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    async function initialize() {
      await loadSelections();
      await loadRestaurants();
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
      const urlParams = new URLSearchParams(location.search);
      const scrollPosition = Number(urlParams.get('scroll_position')) || 0;
      console.log('=== initialize() called ===');
      console.log('Scroll position from URL:', scrollPosition);
      
      if (scrollPosition > 0) {
        console.log('Restoring scroll position:', scrollPosition);
        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ–∑–∏—Ü–∏–∏
        const waitForContent = () => {
          return new Promise((resolve) => {
            let attempts = 0;
            const maxAttempts = 20; // –ú–∞–∫—Å–∏–º—É–º 2 —Å–µ–∫—É–Ω–¥—ã –æ–∂–∏–¥–∞–Ω–∏—è
            
            const checkContent = () => {
              attempts++;
              const documentHeight = document.documentElement.scrollHeight;
              const windowHeight = window.innerHeight;
              
              console.log(`Attempt ${attempts}: Document height: ${documentHeight}, Window height: ${windowHeight}`);
              
              // –ï—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –±–æ–ª—å—à–µ –≤—ã—Å–æ—Ç—ã –æ–∫–Ω–∞, –∑–Ω–∞—á–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∏–ª—Å—è
              if (documentHeight > windowHeight || attempts >= maxAttempts) {
                console.log('Content loaded, height:', documentHeight);
                resolve();
              } else {
                console.log('Content not loaded yet, waiting...');
                setTimeout(checkContent, 100);
              }
            };
            checkContent();
          });
        };
        
        // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∑–∞—Ç–µ–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é
        waitForContent().then(() => {
          setTimeout(() => {
            window.scrollTo(0, scrollPosition);
            console.log('Restored scroll position:', scrollPosition);
          }, 200);
        });
      }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
    initialize();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    console.log('=== Page loaded ===');
    console.log('Initial scroll position:', window.pageYOffset || document.documentElement.scrollTop);
    console.log('Document height:', document.documentElement.scrollHeight);
    console.log('Window height:', window.innerHeight);
    console.log('URL:', location.href);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(() => {
        console.log('Scroll position changed to:', window.pageYOffset || document.documentElement.scrollTop);
      }, 100);
    });
    

    document.getElementById('navHome').onclick = (e) => { e.preventDefault(); const p = new URLSearchParams(location.search); if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); location.href = '/static/index.html?' + p.toString(); };
    document.getElementById('navCart').onclick = (e) => { e.preventDefault(); const p = new URLSearchParams(location.search); if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); location.href = '/static/cart.html?' + p.toString(); };
    document.getElementById('navProfile').onclick = (e) => { e.preventDefault(); const p = new URLSearchParams(location.search); if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); location.href = '/static/profile.html?' + p.toString(); };

    
  </script>
</body>
</html>

