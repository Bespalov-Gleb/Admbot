<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <link rel="stylesheet" href="/static/admin.css?v=23" />
  <style>
    .menu-admin-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .restaurant-selector {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .restaurant-selector h2 {
      margin: 0 0 16px 0;
      color: #333;
    }
    
    .restaurant-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    
    .restaurant-card {
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .restaurant-card:hover {
      border-color: #dc2626;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .restaurant-card.selected {
      border-color: #dc2626;
      background-color: #fef2f2;
    }
    
    .restaurant-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 8px;
      color: #333;
    }
    
    .restaurant-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .menu-editor {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: none;
    }
    
    .menu-editor.active {
      display: block;
    }
    
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .menu-title {
      font-size: 24px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    
    .menu-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }
    
    .btn-primary {
      background: #dc2626;
      color: white;
    }
    
    .btn-primary:hover {
      background: #b91c1c;
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    
    .categories-section {
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .category-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
    }
    
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .category-name {
      font-weight: 600;
      color: #333;
    }
    
    .category-actions {
      display: flex;
      gap: 8px;
    }
    
    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
    }
    
    .dishes-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
    }
    
    .dish-item {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 12px;
    }
    
    .dish-name {
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }
    
    .dish-price {
      color: #dc2626;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .dish-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .dish-actions {
      display: flex;
      gap: 4px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .empty-state h3 {
      margin: 0 0 8px 0;
      color: #333;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 0;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .close-modal:hover {
      color: #333;
    }
    
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    
    .retry-btn {
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      cursor: pointer;
      margin-top: 12px;
    }
    
    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #dc2626;
    }
    
    .error h3 {
      margin: 0 0 12px 0;
      color: #dc2626;
    }
    
    .error p {
      margin: 8px 0;
      font-size: 14px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    .image-preview {
      position: relative;
      margin-top: 12px;
      display: inline-block;
    }
    
    .image-preview img {
      max-width: 200px;
      max-height: 150px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    
    .remove-image-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–ø—Ü–∏–π */
    .options-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 14px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    
    .btn-small:hover {
      background: #2563eb;
    }
    
    .option-groups {
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      background: #f9fafb;
    }
    
    .option-group {
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .option-group:last-child {
      margin-bottom: 0;
    }
    
    .option-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .option-group-title {
      font-weight: 600;
      color: #374151;
    }
    
    .option-group-controls {
      display: flex;
      gap: 8px;
    }
    
    .option-group-fields {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .option-group-fields input, .option-group-fields select {
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }
    
    .option-list {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
    }
    
    .option-item {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 12px;
      margin-bottom: 8px;
      align-items: center;
    }
    
    .option-item:last-child {
      margin-bottom: 0;
    }
    
    .option-item input {
      padding: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
  </style>
</head>
<body>
  <div class="menu-admin-container">
    <!-- –í—ã–±–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ -->
    <div class="restaurant-selector">
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é</h2>
      <div class="restaurant-list" id="restaurantList">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤...</div>
      </div>
    </div>
    
    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –º–µ–Ω—é -->
    <div class="menu-editor" id="menuEditor">
      <div class="menu-header">
        <h2 class="menu-title" id="menuTitle">–ú–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</h2>
        <div class="menu-actions">
          <button class="btn btn-secondary" onclick="goBack()">‚Üê –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É</button>
          <button class="btn btn-primary" onclick="addCategory()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        </div>
      </div>
      
      <div class="categories-section">
        <div class="section-title">
          –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
        </div>
        <div id="categoriesList">
          <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π...</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
  <div class="modal" id="categoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="categoryModalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
        <button class="close-modal" onclick="closeCategoryModal()">√ó</button>
      </div>
      <form id="categoryForm">
        <div class="form-group">
          <label for="categoryName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</label>
          <input type="text" id="categoryName" required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –±–ª—é–¥–∞ -->
  <div class="modal" id="dishModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="dishModalTitle">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</h3>
        <button class="close-modal" onclick="closeDishModal()">√ó</button>
      </div>
      <form id="dishForm">
        <div class="form-group">
          <label for="dishName">–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞</label>
          <input type="text" id="dishName" required>
        </div>
        <div class="form-group">
          <label for="dishDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="dishDescription"></textarea>
        </div>
        <div class="form-group">
          <label for="dishPrice">–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input type="number" id="dishPrice" min="0" step="1" required>
        </div>
        <div class="form-group">
          <label for="dishImage">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
          <input type="url" id="dishImage">
        </div>
        
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
        <div class="form-group">
          <label for="dishImageFile">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
          <input type="file" id="dishImageFile" accept="image/*" onchange="previewImage(this)">
          <div id="imagePreview" class="image-preview" style="display: none;">
            <img id="previewImg" src="" alt="–ü—Ä–µ–≤—å—é">
            <button type="button" onclick="removeImagePreview()" class="remove-image-btn">√ó</button>
          </div>
        </div>
        
        <!-- –û–ø—Ü–∏–∏ –±–ª—é–¥–∞ -->
        <div class="form-group">
          <div class="options-header">
            <label>–û–ø—Ü–∏–∏ –±–ª—é–¥–∞</label>
            <button type="button" class="btn btn-small" onclick="addOptionGroup()">+ –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–ø–ø—É –æ–ø—Ü–∏–π</button>
          </div>
          <div id="optionGroups" class="option-groups">
            <!-- –ì—Ä—É–ø–ø—ã –æ–ø—Ü–∏–π –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeDishModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    const api = location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    const q = new URLSearchParams(location.search);
    const uid = tg?.initDataUnsafe?.user?.id || Number(q.get('uid')) || 0;
    const headers = uid ? { 'X-Telegram-User-Id': String(uid), 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    console.log('DEBUG: uid =', uid);
    console.log('DEBUG: tg?.initDataUnsafe?.user?.id =', tg?.initDataUnsafe?.user?.id);
    console.log('DEBUG: q.get("uid") =', q.get('uid'));
    console.log('DEBUG: headers =', headers);
    
    let currentRestaurant = null;
    let categories = [];
    let dishes = [];
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
    async function loadRestaurants() {
      try {
        console.log('DEBUG: Making request to', api + '/admin/restaurants');
        console.log('DEBUG: With headers', headers);
        
        const response = await fetch(api + '/admin/restaurants', { headers });
        console.log('DEBUG: Response status', response.status);
        console.log('DEBUG: Response ok', response.ok);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const restaurants = await response.json();
        console.log('DEBUG: Restaurants data', restaurants);
        
        const restaurantList = document.getElementById('restaurantList');
        restaurantList.innerHTML = '';
        
        restaurants.forEach(restaurant => {
          const card = document.createElement('div');
          card.className = 'restaurant-card';
          card.onclick = () => selectRestaurant(restaurant);
          
          card.innerHTML = `
            <div class="restaurant-name">${restaurant.name}</div>
            <div class="restaurant-info">ID: ${restaurant.id}</div>
            <div class="restaurant-info">–ê–¥—Ä–µ—Å: ${restaurant.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
            <div class="restaurant-info">–°—Ç–∞—Ç—É—Å: ${restaurant.is_enabled ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω'}</div>
          `;
          
          restaurantList.appendChild(card);
        });
      } catch (error) {
        console.error('Error loading restaurants:', error);
        const errorMessage = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        document.getElementById('restaurantList').innerHTML = `
          <div class="error">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</h3>
            <p>${errorMessage}</p>
            <p>UID: ${uid}</p>
            <p>Headers: ${JSON.stringify(headers)}</p>
            <button onclick="loadRestaurants()" class="retry-btn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
          </div>
        `;
      }
    }
    
    // –í—ã–±–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    function selectRestaurant(restaurant) {
      currentRestaurant = restaurant;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º UI
      document.querySelectorAll('.restaurant-card').forEach(card => {
        card.classList.remove('selected');
      });
      event.target.closest('.restaurant-card').classList.add('selected');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–µ–Ω—é
      document.getElementById('menuTitle').textContent = `–ú–µ–Ω—é: ${restaurant.name}`;
      document.getElementById('menuEditor').classList.add('active');
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é
      loadMenu();
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    async function loadMenu() {
      if (!currentRestaurant) return;
      
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        const categoriesUrl = api + `/categories?restaurant_id=${currentRestaurant.id}`;
        console.log('DEBUG: Loading categories from', categoriesUrl);
        const categoriesResponse = await fetch(categoriesUrl, { headers });
        console.log('DEBUG: Categories response status', categoriesResponse.status);
        
        if (!categoriesResponse.ok) {
          throw new Error(`HTTP ${categoriesResponse.status}: ${categoriesResponse.statusText}`);
        }
        
        categories = await categoriesResponse.json();
        console.log('DEBUG: Categories data', categories);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª—é–¥–∞
        const dishesUrl = api + `/dishes?restaurant_id=${currentRestaurant.id}`;
        console.log('DEBUG: Loading dishes from', dishesUrl);
        const dishesResponse = await fetch(dishesUrl, { headers });
        console.log('DEBUG: Dishes response status', dishesResponse.status);
        
        if (!dishesResponse.ok) {
          throw new Error(`HTTP ${dishesResponse.status}: ${dishesResponse.statusText}`);
        }
        
        dishes = await dishesResponse.json();
        console.log('DEBUG: Dishes data', dishes);
        
        renderCategories();
      } catch (error) {
        console.error('Error loading menu:', error);
        const errorMessage = error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        document.getElementById('categoriesList').innerHTML = `
          <div class="error">
            <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é</h3>
            <p>${errorMessage}</p>
            <p>–†–µ—Å—Ç–æ—Ä–∞–Ω ID: ${currentRestaurant?.id}</p>
            <button onclick="loadMenu()" class="retry-btn">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
          </div>
        `;
      }
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    function renderCategories() {
      const categoriesList = document.getElementById('categoriesList');
      categoriesList.innerHTML = '';
      
      if (categories.length === 0) {
        categoriesList.innerHTML = '<div class="empty-state"><h3>–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h3><p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –º–µ–Ω—é</p></div>';
        return;
      }
      
      categories.forEach(category => {
        const categoryDishes = dishes.filter(dish => dish.category_id === category.id);
        
        const categoryElement = document.createElement('div');
        categoryElement.className = 'category-item';
        categoryElement.innerHTML = `
          <div class="category-header">
            <div class="category-name">${category.name}</div>
            <div class="category-actions">
              <button class="btn btn-small btn-secondary" onclick="editCategory(${category.id})">‚úèÔ∏è</button>
              <button class="btn btn-small btn-primary" onclick="addDish(${category.id})">+ –ë–ª—é–¥–æ</button>
              <button class="btn btn-small btn-secondary" onclick="deleteCategory(${category.id})">üóëÔ∏è</button>
            </div>
          </div>
          <div class="dishes-list">
            ${categoryDishes.map(dish => `
              <div class="dish-item">
                <div class="dish-name">${dish.name}</div>
                <div class="dish-price">${dish.price} ‚ÇΩ</div>
                <div class="dish-description">${dish.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</div>
                <div class="dish-actions">
                  <button class="btn btn-small btn-secondary" onclick="editDish(${dish.id})">‚úèÔ∏è</button>
                  <button class="btn btn-small btn-secondary" onclick="deleteDish(${dish.id})">üóëÔ∏è</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        
        categoriesList.appendChild(categoryElement);
      });
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function addCategory() {
      document.getElementById('categoryModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
      document.getElementById('categoryForm').reset();
      document.getElementById('categoryModal').classList.add('active');
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function editCategory(categoryId) {
      const category = categories.find(c => c.id === categoryId);
      if (!category) return;
      
      document.getElementById('categoryModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
      document.getElementById('categoryName').value = category.name;
      document.getElementById('categoryModal').classList.add('active');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      document.getElementById('categoryForm').dataset.categoryId = categoryId;
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    function closeCategoryModal() {
      document.getElementById('categoryModal').classList.remove('active');
      document.getElementById('categoryForm').dataset.categoryId = '';
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.getElementById('categoryForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('categoryName').value;
      const categoryId = document.getElementById('categoryForm').dataset.categoryId;
      
      try {
        if (categoryId) {
          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          await fetch(api + `/admin/categories/${categoryId}`, {
            method: 'PATCH',
            headers,
            body: JSON.stringify({ name })
          });
        } else {
          // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
          await fetch(api + `/admin/categories`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ 
              name, 
              restaurant_id: currentRestaurant.id 
            })
          });
        }
        
        closeCategoryModal();
        loadMenu(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é
      } catch (error) {
        console.error('Error saving category:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
      }
    };
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    async function deleteCategory(categoryId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –í—Å–µ –±–ª—é–¥–∞ –≤ –Ω–µ–π —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
      
      try {
        await fetch(api + `/admin/categories/${categoryId}`, {
          method: 'DELETE',
          headers
        });
        loadMenu(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é
      } catch (error) {
        console.error('Error deleting category:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
      }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞
    function addDish(categoryId) {
      document.getElementById('dishModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ';
      document.getElementById('dishForm').reset();
      document.getElementById('dishForm').dataset.categoryId = categoryId;
      document.getElementById('dishModal').classList.add('active');
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª—é–¥–∞
    async function editDish(dishId) {
      const dish = dishes.find(d => d.id === dishId);
      if (!dish) return;
      
      document.getElementById('dishModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª—é–¥–æ';
      document.getElementById('dishName').value = dish.name;
      document.getElementById('dishDescription').value = dish.description || '';
      document.getElementById('dishPrice').value = dish.price;
      
      // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
      document.getElementById('dishImage').value = '';
      
      document.getElementById('dishForm').dataset.dishId = dishId;
      document.getElementById('dishForm').dataset.categoryId = dish.category_id;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      if (dish.image) {
        showImagePreview(dish.image);
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ –±–ª—é–¥–∞
      await loadDishOptions(dishId);
      
      document.getElementById('dishModal').classList.add('active');
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –±–ª—é–¥–∞
    function closeDishModal() {
      document.getElementById('dishModal').classList.remove('active');
      document.getElementById('dishForm').dataset.dishId = '';
      document.getElementById('dishForm').dataset.categoryId = '';
      
      // –û—á–∏—â–∞–µ–º –ø—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('dishImageFile').value = '';
      
      // –û—á–∏—â–∞–µ–º –æ–ø—Ü–∏–∏
      document.getElementById('optionGroups').innerHTML = '';
      optionGroupCounter = 0;
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–ª—é–¥–∞
    document.getElementById('dishForm').onsubmit = async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('dishName').value;
      const description = document.getElementById('dishDescription').value;
      const price = parseInt(document.getElementById('dishPrice').value);
      const imageUrl = document.getElementById('dishImage').value;
      const imageFile = document.getElementById('dishImageFile').files[0];
      const categoryId = document.getElementById('dishForm').dataset.categoryId;
      const dishId = document.getElementById('dishForm').dataset.dishId;
      
      try {
        let image = ''; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
        
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∞–π–ª, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ
        if (imageFile) {
          console.log('Uploading image file:', imageFile.name);
          const formData = new FormData();
          formData.append('file', imageFile);
          
          const uploadResponse = await fetch(api + '/admin/upload-dish-image', {
            method: 'POST',
            headers: {
              'X-Telegram-User-Id': uid
            },
            body: formData
          });
          
          if (!uploadResponse.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          }
          
          const uploadResult = await uploadResponse.json();
          image = uploadResult.path;
          console.log('Image uploaded successfully:', image);
        } else if (imageUrl && imageUrl.trim() !== '') {
          // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω, –Ω–æ –µ—Å—Ç—å URL, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
          image = imageUrl;
        } else if (dishId) {
          // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏, –µ—Å–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ñ–∞–π–ª –∏ –Ω–µ—Ç URL, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
          const currentDish = dishes.find(d => d.id == dishId);
          if (currentDish && currentDish.image) {
            image = currentDish.image;
          }
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–π
        const optionGroups = getOptionGroupsData();
        
        if (dishId) {
          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–ª—é–¥–∞
          await fetch(api + `/admin/dishes/${dishId}`, {
            method: 'PATCH',
            headers,
            body: JSON.stringify({ name, description, price, image, option_groups: optionGroups })
          });
        } else {
          // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –±–ª—é–¥–∞
          await fetch(api + `/admin/dishes`, {
            method: 'POST',
            headers,
            body: JSON.stringify({ 
              name, 
              description, 
              price, 
              image,
              category_id: categoryId,
              restaurant_id: currentRestaurant.id,
              option_groups: optionGroups
            })
          });
        }
        
        closeDishModal();
        loadMenu(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é
      } catch (error) {
        console.error('Error saving dish:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–ª—é–¥–∞: ' + error.message);
      }
    };
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –±–ª—é–¥–∞
    async function deleteDish(dishId) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ?')) return;
      
      try {
        await fetch(api + `/admin/dishes/${dishId}`, {
          method: 'DELETE'
        });
        loadMenu(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é
      } catch (error) {
        console.error('Error deleting dish:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª—é–¥–∞');
      }
    }
    
    // –í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    function goBack() {
      currentRestaurant = null;
      document.getElementById('menuEditor').classList.remove('active');
      document.querySelectorAll('.restaurant-card').forEach(card => {
        card.classList.remove('selected');
      });
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏
    function previewImage(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const preview = document.getElementById('imagePreview');
          const img = document.getElementById('previewImg');
          img.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    
    function removeImagePreview() {
      document.getElementById('imagePreview').style.display = 'none';
      document.getElementById('dishImageFile').value = '';
    }
    
    function showImagePreview(imageUrl) {
      const preview = document.getElementById('imagePreview');
      const img = document.getElementById('previewImg');
      img.src = imageUrl;
      preview.style.display = 'block';
    }
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–ø—Ü–∏—è–º–∏
    let optionGroupCounter = 0;
    
    async function loadDishOptions(dishId) {
      try {
        console.log(`Loading options for dish ${dishId}`);
        
        // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø—Ü–∏–∏
        document.getElementById('optionGroups').innerHTML = '';
        optionGroupCounter = 0;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≥—Ä—É–ø–ø—ã –æ–ø—Ü–∏–π
        const groupsResponse = await fetch(api + `/ra/option-groups?dish_id=${dishId}`, { headers });
        if (!groupsResponse.ok) {
          console.log('No option groups found or error:', groupsResponse.status);
          return;
        }
        
        const groups = await groupsResponse.json();
        console.log('Loaded option groups:', groups);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã
        for (const group of groups) {
          const optionsResponse = await fetch(api + `/ra/options?group_id=${group.id}`, { headers });
          if (optionsResponse.ok) {
            const options = await optionsResponse.json();
            console.log(`Loaded options for group ${group.id}:`, options);
            addOptionGroupWithData(group, options);
          }
        }
        
      } catch (error) {
        console.error('Error loading dish options:', error);
      }
    }
    
    function addOptionGroupWithData(group, options = []) {
      const container = document.getElementById('optionGroups');
      const groupId = `group_${++optionGroupCounter}`;
      
      const groupHtml = `
        <div class="option-group" data-group-id="${groupId}" data-group-db-id="${group.id}">
          <div class="option-group-header">
            <span class="option-group-title">${group.name}</span>
            <div class="option-group-controls">
              <button type="button" class="btn-small" onclick="addOption('${groupId}')">+ –û–ø—Ü–∏—è</button>
              <button type="button" class="btn-danger" onclick="removeOptionGroup('${groupId}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
          <div class="option-group-fields">
            <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" class="group-name" value="${group.name}">
            <input type="number" placeholder="–ú–∏–Ω. –≤—ã–±–æ—Ä" class="group-min" value="${group.min_select}" min="0">
            <input type="number" placeholder="–ú–∞–∫—Å. –≤—ã–±–æ—Ä" class="group-max" value="${group.max_select}" min="1">
            <label>
              <input type="checkbox" class="group-required" ${group.required ? 'checked' : ''}> –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            </label>
          </div>
          <div class="option-list" id="options_${groupId}">
            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', groupHtml);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏
      options.forEach(option => {
        addOptionWithData(groupId, option);
      });
    }
    
    function addOptionWithData(groupId, option) {
      const container = document.getElementById(`options_${groupId}`);
      const optionId = `option_${Date.now()}`;
      
      const optionHtml = `
        <div class="option-item" data-option-id="${optionId}" data-option-db-id="${option.id}">
          <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏" class="option-name" value="${option.name}">
          <input type="number" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" class="option-price" value="${option.price_delta}" min="0">
          <button type="button" class="btn-danger" onclick="removeOption('${optionId}')">√ó</button>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', optionHtml);
    }
    
    function addOptionGroup() {
      const container = document.getElementById('optionGroups');
      const groupId = `group_${++optionGroupCounter}`;
      
      const groupHtml = `
        <div class="option-group" data-group-id="${groupId}">
          <div class="option-group-header">
            <span class="option-group-title">–ì—Ä—É–ø–ø–∞ –æ–ø—Ü–∏–π ${optionGroupCounter}</span>
            <div class="option-group-controls">
              <button type="button" class="btn-small" onclick="addOption('${groupId}')">+ –û–ø—Ü–∏—è</button>
              <button type="button" class="btn-danger" onclick="removeOptionGroup('${groupId}')">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
          <div class="option-group-fields">
            <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" class="group-name" value="–ì—Ä—É–ø–ø–∞ –æ–ø—Ü–∏–π ${optionGroupCounter}">
            <input type="number" placeholder="–ú–∏–Ω. –≤—ã–±–æ—Ä" class="group-min" value="0" min="0">
            <input type="number" placeholder="–ú–∞–∫—Å. –≤—ã–±–æ—Ä" class="group-max" value="1" min="1">
            <label>
              <input type="checkbox" class="group-required"> –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
            </label>
          </div>
          <div class="option-list" id="options_${groupId}">
            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
          </div>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', groupHtml);
    }
    
    function addOption(groupId) {
      const container = document.getElementById(`options_${groupId}`);
      const optionId = `option_${Date.now()}`;
      
      const optionHtml = `
        <div class="option-item" data-option-id="${optionId}">
          <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–ø—Ü–∏–∏" class="option-name" value="">
          <input type="number" placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" class="option-price" value="0" min="0">
          <button type="button" class="btn-danger" onclick="removeOption('${optionId}')">√ó</button>
        </div>
      `;
      
      container.insertAdjacentHTML('beforeend', optionHtml);
    }
    
    function removeOption(optionId) {
      document.querySelector(`[data-option-id="${optionId}"]`).remove();
    }
    
    function removeOptionGroup(groupId) {
      document.querySelector(`[data-group-id="${groupId}"]`).remove();
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ–ø—Ü–∏–π
    function getOptionGroupsData() {
      const groups = [];
      const groupElements = document.querySelectorAll('.option-group');
      
      groupElements.forEach((groupEl, index) => {
        const name = groupEl.querySelector('.group-name').value;
        const minSelect = parseInt(groupEl.querySelector('.group-min').value) || 0;
        const maxSelect = parseInt(groupEl.querySelector('.group-max').value) || 1;
        const required = groupEl.querySelector('.group-required').checked;
        
        const options = [];
        const optionElements = groupEl.querySelectorAll('.option-item');
        optionElements.forEach(optionEl => {
          const optionName = optionEl.querySelector('.option-name').value;
          const optionPrice = parseInt(optionEl.querySelector('.option-price').value) || 0;
          
          if (optionName.trim()) {
            options.push({
              name: optionName.trim(),
              price_delta: optionPrice
            });
          }
        });
        
        if (name.trim() && options.length > 0) {
          groups.push({
            name: name.trim(),
            min_select: minSelect,
            max_select: maxSelect,
            required: required,
            options: options
          });
        }
      });
      
      return groups;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    loadRestaurants();
  </script>
</body>
</html>