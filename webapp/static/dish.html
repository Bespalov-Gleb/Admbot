<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ë–ª—é–¥–æ</title>
  <link rel="stylesheet" href="/static/styles.v23.css?v=50" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="/static/page-transitions.js"></script>
</head>
<body>
  <div class="container" style="padding-bottom: 120px;">
    <div style="margin-bottom:8px"><a id="back" href="#">–ù–∞–∑–∞–¥</a></div>
    <div class="dish-hero"><img id="heroImg" src="" alt=""/></div>
    <div id="header"></div>
    <div id="desc" class="meta"></div>
    <div id="opt"></div>
    <div class="buy-bar">
      <div class="qty">
        <button id="minus">‚àí</button>
        <span id="qty" style="min-width:24px;text-align:center">1</span>
        <button id="plus">+</button>
      </div>
      <button id="add" class="primary">–í –∫–æ—Ä–∑–∏–Ω—É <span id="sumBtn"></span></button>
    </div>
    <div class="nav-container">
      <a id="navHome" href="#" class="nav-item">
        <span class="nav-icon nav-icon-home"></span>
        <span>–ì–ª–∞–≤–Ω–æ–µ</span>
      </a>
      <span class="nav-item disabled">
        <span class="nav-icon nav-icon-promo"></span>
        <span>–ê–∫—Ü–∏–∏</span>
      </span>
      <a id="navCart" href="#" class="nav-item">
        <span class="nav-icon nav-icon-cart"></span>
        <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
      </a>
      <a id="navMenu" href="#" class="nav-item">
        <span class="nav-icon nav-icon-menu"></span>
        <span>–ú–µ–Ω—é</span>
      </a>
      <a id="navProfile" href="#" class="nav-item">
        <span class="nav-icon nav-icon-profile"></span>
        <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
      </a>
    </div>
  </div>
  <script>
    console.log('Script started');
    
    const api = location.origin + '/api';
    console.log('API URL:', api);
    
    const url = new URL(location.href);
    const dishId = Number(url.searchParams.get('id'));
    console.log('Dish ID from URL:', dishId);
    
    const p = new URLSearchParams(location.search);
    const tg = window.Telegram?.WebApp;
    const uid = (p.get('uid') && Number(p.get('uid'))) || tg?.initDataUnsafe?.user?.id || 0;
    console.log('User ID:', uid);
    
    const headers = uid ? { 'X-Telegram-User-Id': String(uid), 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
    console.log('Headers:', headers);
    
    if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
    let dish = null;
    let qty = 1;
    let groups = [];
    let options = [];
    const selected = new Map(); // group_id -> Set<option_id>

    async function load() {
      console.log('Load function called');
      try {
        const [dRes, oRes] = await Promise.all([
          fetch(api + '/dishes/' + dishId, { headers }),
          fetch(api + '/dishes/' + dishId + '/options', { headers }),
        ]);
        console.log('Fetch responses received');
        
        dish = await dRes.json();
        console.log('Loaded dish:', dish);
        console.log('Dish restaurant_id:', dish.restaurant_id);
        console.log('Dish id:', dish.id);
        
        const data = await oRes.json();
        groups = data.groups || [];
        options = data.options || [];
        console.log('Loaded options data:', data);
        console.log('Groups loaded:', groups);
        console.log('Options loaded:', options);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≥—Ä—É–ø–ø—ã
        const requiredGroups = groups.filter(g => g.required);
        console.log('Required groups found:', requiredGroups);
        
        renderHeader();
        renderOptions();
        bindNav();
        updateValidity();
        console.log('Load function completed successfully');
      } catch (error) {
        console.error('Error in load function:', error);
      }
    }

    function calcTotal() {
      let total = dish.price * qty;
      for (const [gid, set] of selected.entries()) {
        for (const oid of set.values()) {
          const opt = options.find(o => o.id === oid);
          if (opt) total += (opt.price_delta || 0) * qty;
        }
      }
      return total;
    }

    function renderHeader() {
      const h = document.getElementById('header');
      const img = document.getElementById('heroImg');
      img.src = dish.image;
      img.alt = dish.name;
      h.innerHTML = `<h2>${dish.name}</h2>`;
      document.getElementById('desc').textContent = dish.description || '';
      document.getElementById('sumBtn').textContent = calcTotal() + ' —Ä';
    }

    function renderOptions() {
      const root = document.getElementById('opt');
      root.innerHTML = '';
      groups.forEach(g => {
        const block = document.createElement('div');
        block.className = 'option-group';
        
        const title = document.createElement('div');
        title.className = 'title';
        if (g.required) title.classList.add('required');
        title.textContent = g.name;
        block.appendChild(title);
        
        const list = document.createElement('div');
        options.filter(o => o.group_id === g.id).forEach(o => {
          const id = `g${g.id}_o${o.id}`;
          const input = document.createElement('input');
          input.type = (g.max_select === 1 && g.min_select <= 1) ? 'radio' : 'checkbox';
          input.name = 'g' + g.id;
          input.id = id;
          input.value = o.id;
          const set = selected.get(g.id);
          if (set && set.has(o.id)) input.checked = true;
          input.onchange = () => toggleOption(g, o, input.checked);
          
          const label = document.createElement('label');
          label.htmlFor = id;
          
          const labelText = document.createElement('span');
          labelText.textContent = o.name;
          
          const priceSpan = document.createElement('span');
          if (o.price_delta) {
            priceSpan.className = 'option-price';
            priceSpan.textContent = o.price_delta + ' ‚ÇΩ';
          }
          
          label.appendChild(labelText);
          label.appendChild(priceSpan);
          
          const row = document.createElement('div');
          row.className = 'option-item';
          row.appendChild(input);
          row.appendChild(label);
          list.appendChild(row);
        });
        block.appendChild(list);
        root.appendChild(block);
      });
    }

    function updateValidity() {
      let ok = true;
      for (const g of groups) {
        const set = selected.get(g.id) || new Set();
        const count = set.size;
        if (count < (g.required ? Math.max(1, g.min_select) : g.min_select)) ok = false;
        if (g.max_select > 0 && count > g.max_select) ok = false;
      }
      
      // –ù–ï –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É - –ø–æ–∑–≤–æ–ª—è–µ–º –∫–ª–∏–∫ –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      // document.getElementById('add').disabled = !ok;
      
      const sumEl = document.getElementById('sumBtn');
      if (sumEl) sumEl.textContent = calcTotal() + ' —Ä';
      
      // –í–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ–ø—Ü–∏–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã
      const addBtn = document.getElementById('add');
      if (ok) {
        addBtn.style.opacity = '1';
        addBtn.style.cursor = 'pointer';
      } else {
        addBtn.style.opacity = '0.7';
        addBtn.style.cursor = 'not-allowed';
      }
    }

    function toggleOption(group, option, checked) {
      if (!selected.has(group.id)) selected.set(group.id, new Set());
      const set = selected.get(group.id);
      if (group.max_select === 1) set.clear();
      if (checked) set.add(option.id); else set.delete(option.id);
      updateValidity();
    }

    document.getElementById('minus').onclick = () => { qty = Math.max(1, qty-1); document.getElementById('qty').textContent = String(qty); updateValidity(); };
    document.getElementById('plus').onclick = () => { qty = qty+1; document.getElementById('qty').textContent = String(qty); updateValidity(); };
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏–π
    function checkRequiredOptions() {
      const missingRequired = [];
      
      console.log('Checking required options...');
      console.log('Groups:', groups);
      console.log('Selected:', selected);
      
      groups.forEach(g => {
        console.log(`Group ${g.id} (${g.name}): required=${g.required}`);
        if (g.required) {
          const selectedInGroup = selected.get(g.id);
          console.log(`Selected in group ${g.id}:`, selectedInGroup);
          if (!selectedInGroup || selectedInGroup.size === 0) {
            missingRequired.push(g.name);
            console.log(`Missing required option: ${g.name}`);
          }
        }
      });
      
      console.log('Missing required options:', missingRequired);
      return missingRequired;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –æ–ø—Ü–∏—è—Ö
    function showRequiredOptionsNotification(missingOptions) {
      console.log('Showing notification for missing options:', missingOptions);
      
      // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      const notification = document.createElement('div');
      notification.className = 'required-options-notification';
      notification.innerHTML = `
        <div class="notification-content">
          <div class="notification-icon">‚ö†Ô∏è</div>
          <div class="notification-text">
            <div class="notification-title">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏–∏:</div>
            <div class="notification-list">
              ${missingOptions.map(option => `<div class="notification-item">‚Ä¢ ${option}</div>`).join('')}
            </div>
          </div>
        </div>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
        max-width: 90%;
        animation: slideDown 0.3s ease-out;
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideDown {
          from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
          to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .notification-content {
          display: flex;
          align-items: flex-start;
          gap: 12px;
        }
        .notification-icon {
          font-size: 20px;
          flex-shrink: 0;
        }
        .notification-text {
          flex: 1;
        }
        .notification-title {
          font-weight: 600;
          color: #856404;
          margin-bottom: 8px;
        }
        .notification-list {
          color: #856404;
        }
        .notification-item {
          margin-bottom: 4px;
        }
      `;
      document.head.appendChild(style);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
      document.body.appendChild(notification);
      
      // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
      setTimeout(() => {
        notification.style.animation = 'slideDown 0.3s ease-out reverse';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
          if (style.parentNode) {
            style.parentNode.removeChild(style);
          }
        }, 300);
      }, 4000);
    }

    document.getElementById('add').onclick = async () => {
      console.log('Add button clicked');
      
      const addBtn = document.getElementById('add');
      const sumBtn = document.getElementById('sumBtn');
      
      // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ —É–∂–µ –≤ —Ä–µ–∂–∏–º–µ "–î–∞–ª–µ–µ", –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–∑–∏–Ω—É
      if (addBtn.textContent.includes('–î–∞–ª–µ–µ')) {
        console.log('Button is in "–î–∞–ª–µ–µ" mode, redirecting to cart');
        const q = new URLSearchParams(location.search);
        if (!q.get('ngrok-skip-browser-warning')) q.set('ngrok-skip-browser-warning','1');
        location.href = '/static/cart.html?' + q.toString();
        return;
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏
      console.log('Checking required options before adding to cart...');
      const missingRequired = checkRequiredOptions();
      console.log('Missing required options result:', missingRequired);
      if (missingRequired.length > 0) {
        console.log('Found missing required options, showing notification');
        showRequiredOptionsNotification(missingRequired);
        return;
      } else {
        console.log('All required options are selected, proceeding with add to cart');
      }
      
      console.log('Processing add to cart...');
      const qty = parseInt(document.getElementById('qty').textContent);
      const chosen = [];
      
      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø—Ü–∏–∏ (–∏ —á–µ–∫–±–æ–∫—Å—ã, –∏ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏)
      document.querySelectorAll('input[type="checkbox"]:checked, input[type="radio"]:checked').forEach(cb => {
        chosen.push(parseInt(cb.value));
      });
      
      console.log('Quantity:', qty);
      console.log('Chosen options:', chosen);
      
      try {
        console.log('Adding to cart:', { restaurant_id: dish.restaurant_id, dish_id: dish.id, qty, chosen_options: chosen });
        console.log('Dish object:', dish);
        console.log('Dish restaurant_id:', dish.restaurant_id);
        console.log('Dish id:', dish.id);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å
        if (!dish.restaurant_id) {
          console.error('restaurant_id is missing or undefined');
          alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω');
          return;
        }
        
        if (!dish.id) {
          console.error('dish.id is missing or undefined');
          alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –±–ª—é–¥–æ');
          return;
        }
        
        const cartData = { 
          restaurant_id: dish.restaurant_id, 
          dish_id: dish.id, 
          qty, 
          chosen_options: chosen 
        };
        
        console.log('Sending cart data:', cartData);
        
        const res = await fetch(api + '/cart/items' + (uid ? ('?uid=' + uid) : ''), {
          method: 'POST',
          headers: {
            ...headers,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(cartData)
        });
        
        console.log('Response status:', res.status);
        
        if (!res.ok) {
          const errorText = await res.text();
          console.error('Error response:', errorText);
          throw new Error(`HTTP ${res.status}: ${errorText}`);
        }
        
        const data = await res.json();
        console.log('Response data:', data);
        
        if (data.status === 'ok') {
          // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
          addBtn.textContent = '–î–∞–ª–µ–µ';
          addBtn.style.background = '#28a745';
          addBtn.style.borderColor = '#28a745';
          addBtn.classList.add('success-animation');
          
          // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ 600ms
          setTimeout(() => {
            addBtn.classList.remove('success-animation');
          }, 600);
          return;
        }
        if (data && data.status === 'too_many_restaurants') {
          showTooManyModal(data.current_restaurant_ids || [], async () => {
            await fetch(api + '/cart/items?force=true' + (uid ? ('&uid=' + uid) : ''), {
              method: 'POST', 
              headers: {
                ...headers,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(cartData)
            });
          });
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
      }
    };

    console.log('About to call load() function');
    load();
    console.log('load() function called');

    function bindNav() {
      const toUrl = (path) => { const q = new URLSearchParams(location.search); if (!q.get('ngrok-skip-browser-warning')) q.set('ngrok-skip-browser-warning','1'); return path + '?' + q.toString(); };
      document.getElementById('navHome').onclick = (e) => { e.preventDefault(); location.href = toUrl('/static/index.html'); };
      document.getElementById('navCart').onclick = (e) => { e.preventDefault(); location.href = toUrl('/static/cart.html'); };
      document.getElementById('navProfile').onclick = (e) => { e.preventDefault(); location.href = toUrl('/static/profile.html'); };
      document.getElementById('navMenu').onclick = (e) => { e.preventDefault(); const q = new URLSearchParams(location.search); if (!q.get('ngrok-skip-browser-warning')) q.set('ngrok-skip-browser-warning','1'); location.href = '/static/restaurant.html?id=' + (dish?.restaurant_id || 0) + '&' + q.toString(); };
      document.getElementById('back').onclick = (e) => { e.preventDefault(); const q = new URLSearchParams(location.search); if (!q.get('ngrok-skip-browser-warning')) q.set('ngrok-skip-browser-warning','1'); location.href = '/static/restaurant.html?id=' + (dish?.restaurant_id || 0) + '&' + q.toString(); };
    }
    
    
    
    

    // overlay utils (shared styles already exist)
    function ensureOverlay() {
      let ov = document.getElementById('ov');
      if (!ov) {
        ov = document.createElement('div');
        ov.id = 'ov';
        ov.className = 'overlay';
        ov.innerHTML = '<div class="modal"><h3>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ—Ä–∑–∏–Ω</h3><div class="muted">–£–¥–∞–ª–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –Ω–æ–≤—É—é</div><div id="ovList"></div><div style="margin-top:10px;text-align:right"><button id="ovDone" class="primary">–ì–æ—Ç–æ–≤–æ</button></div></div>';
        document.body.appendChild(ov);
      }
      return ov;
    }

    async function showTooManyModal(restIds, onDone) {
      const ov = ensureOverlay();
      const list = ov.querySelector('#ovList');
      list.innerHTML = '';
      const resR = await fetch(api + '/restaurants/_bulk?ids=' + encodeURIComponent(restIds.join(',')) + (uid ? ('&uid=' + uid) : '')); 
      const rests = resR.ok ? await resR.json() : [];
      rests.forEach(r => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `<div>${r.name}</div><button class="trash">üóë</button>`;
        row.querySelector('.trash').onclick = async () => {
          await fetch(api + '/cart/clear?restaurant_id=' + r.id + (uid ? ('&uid=' + uid) : ''), { method: 'POST' });
          row.remove();
        };
        list.appendChild(row);
      });
      ov.style.display = 'flex';
      ov.querySelector('#ovDone').onclick = async () => { ov.style.display = 'none'; if (onDone) await onDone(); };
    }
  </script>
</body>
</html>

