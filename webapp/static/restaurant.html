<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ресторан</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/static/styles.v23.css?v=78" />
  <script src="/static/page-transitions.js"></script>
  <style>
    /* Улучшенные стили для горизонтального скролла категорий */
    .cat-row {
      display: flex !important;
      overflow-x: auto !important;
      gap: 12px !important;
      padding: 16px 16px !important;
      position: sticky !important;
      top: 60px !important; /* Сдвигаем ниже кнопки "Назад" */
      background: #fff !important;
      border-bottom: 1px solid #f0f0f0 !important;
      z-index: 150 !important; /* Меньше чем у кнопки "Назад" */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
      scrollbar-width: none !important; /* Firefox */
      -ms-overflow-style: none !important; /* IE/Edge */
    }
    
    .cat-row::-webkit-scrollbar {
      display: none; /* Chrome/Safari/Opera */
    }
    
    .cat-row button {
      padding: 10px 20px !important;
      border-radius: 20px !important;
      border: 1px solid #e5e5e5 !important;
      background: #fff !important;
      color: #333 !important;
      font-weight: 500 !important;
      font-size: 14px !important;
      white-space: nowrap !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
    }
    
    .cat-row button:hover {
      border-color: #d0d0d0;
      background: #f8f8f8;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Анимация свайпа влево */
    .swipe-animation {
      transition: transform 0.3s ease-out;
    }
    
    .swipe-closing {
      transform: translateX(-100%);
    }
    
    /* Скрываем скроллбар во время анимации */
    .swipe-animation body {
      overflow: hidden;
    }
    
    /* Стили для кликабельного рейтинга */
    .clickable-rating {
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 8px;
      padding: 4px 8px;
    }
    
    .clickable-rating:hover {
      background-color: #f5f5f5;
      transform: scale(1.02);
    }
    
    .reviews-arrow {
      margin-left: 8px;
      color: #666;
      font-size: 14px;
      transition: transform 0.2s ease;
    }
    
    .clickable-rating:hover .reviews-arrow {
      transform: translateX(2px);
    }
    
    /* Стили для отзывов */
    .review-item {
      border-bottom: 1px solid #f0f0f0;
      padding: 16px 0;
    }
    
    .review-item:last-child {
      border-bottom: none;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .review-rating {
      color: #ffa500;
      font-size: 16px;
    }
    
    .review-date {
      color: #666;
      font-size: 12px;
    }
    
    .review-comment {
      color: #333;
      line-height: 1.5;
      margin-top: 8px;
    }
    
    .no-reviews {
      text-align: center;
      color: #666;
      padding: 40px 20px;
    }
    
    .loading-text {
      text-align: center;
      color: #666;
      padding: 20px;
    }
    
    .cat-row button.active {
      background: #dc2626 !important;
      border-color: #dc2626 !important;
      color: #fff !important;
      box-shadow: 0 4px 12px rgba(220,38,38,0.3) !important;
    }
    
    /* Плавный скролл для категорий */
    .cat-row {
      scroll-behavior: smooth;
    }
    
    /* Стили для модального окна с информацией о ресторане */
    .restaurant-info-modal {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: rgba(0, 0, 0, 0.5) !important;
      z-index: 1001 !important;
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .restaurant-info-modal.show {
      display: block !important;
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    .modal-content {
      position: fixed !important;
      bottom: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 80vh !important;
      background: #fff !important;
      border-radius: 20px 20px 0 0 !important;
      transform: translateY(100%) !important;
      transition: transform 0.3s ease !important;
      overflow-y: auto !important;
      z-index: 1002 !important;
      min-height: 400px !important;
    }
    
      .restaurant-info-modal.show .modal-content {
        transform: translateY(0) !important;
      }
      
      /* Стили для нового заголовка модального окна */
      .modal-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 16px 20px !important;
        border-bottom: 1px solid #e0e0e0 !important;
        background: #fff !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 10 !important;
      }
      
      .back-button {
        background: none !important;
        border: none !important;
        font-size: 24px !important;
        color: #333 !important;
        cursor: pointer !important;
        padding: 8px !important;
        border-radius: 50% !important;
        transition: background-color 0.2s !important;
      }
      
      .back-button:hover {
        background-color: #f5f5f5 !important;
      }
      
      .modal-title {
        font-size: 18px !important;
        font-weight: 600 !important;
        color: #333 !important;
        margin: 0 !important;
        text-align: center !important;
        flex: 1 !important;
      }
      
      .header-spacer {
        width: 40px !important;
        height: 40px !important;
      }
      
      /* Стили для элементов отзывов */
      .review-item {
        padding: 16px 20px !important;
        border-bottom: 1px solid #f0f0f0 !important;
        background: #fff !important;
      }
      
      .review-item:last-child {
        border-bottom: none !important;
      }
      
      .review-header {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 8px !important;
      }
      
      .reviewer-info {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
      }
      
      .thumbs-up-icon {
        width: 28px !important;
        height: 28px !important;
        background: #4CAF50 !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        position: relative !important;
        flex-shrink: 0 !important;
      }
      
      .thumbs-up-icon::before {
        content: '' !important;
        width: 12px !important;
        height: 12px !important;
        background: #fff !important;
        border-radius: 2px 2px 0 0 !important;
        position: relative !important;
        transform: rotate(-45deg) !important;
        margin-top: 2px !important;
      }
      
      .thumbs-up-icon::after {
        content: '' !important;
        width: 8px !important;
        height: 8px !important;
        background: #fff !important;
        border-radius: 0 0 2px 2px !important;
        position: absolute !important;
        bottom: 6px !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
      }
      
      .reviewer-name {
        font-weight: 600 !important;
        font-size: 16px !important;
        color: #333 !important;
      }
      
      .review-date {
        font-size: 14px !important;
        color: #666 !important;
      }
      
      .review-text {
        font-size: 15px !important;
        color: #333 !important;
        line-height: 1.4 !important;
        margin-bottom: 8px !important;
      }
      
      .ordered-items {
        font-size: 13px !important;
        color: #888 !important;
        line-height: 1.3 !important;
        font-style: italic !important;
      }
      
      .no-reviews {
        text-align: center !important;
        padding: 40px 20px !important;
        color: #666 !important;
        font-size: 16px !important;
      }
      
      /* Улучшенные стили для свайпа */
      body {
        transition: transform 0.2s ease-out, opacity 0.2s ease-out !important;
        cursor: grab !important;
      }
      
      body:active {
        cursor: grabbing !important;
      }
      
      .swipe-animation {
        transition: transform 0.25s ease-in, opacity 0.25s ease-in !important;
      }
      
      .swipe-closing {
        transform: translateX(-100%) !important;
        opacity: 0 !important;
      }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }
    
    .close-modal {
      background: none;
      border: none;
      font-size: 24px;
      color: #666;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }
    
    .close-modal:hover {
      background-color: #f0f0f0;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    .info-section {
      margin-bottom: 24px;
    }
    
    .info-section h3 {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
    }
    
    .info-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .info-icon {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      color: #666;
    }
    
    .info-text {
      color: #333;
      font-size: 14px;
    }
    
    .cuisine-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }
    
    .cuisine-tag {
      background: #e9ecef;
      color: #495057;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .legal-info {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .legal-info h4 {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .legal-info p {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
      line-height: 1.4;
    }
    
    /* Стили для нижней плашки заказа */
    .checkout-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      z-index: 1000;
      display: none;
    }
    
    .checkout-content {
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    
    .cart-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .cart-count {
      background: #dc2626;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }
    
    .total-price {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    
    .min-order-note {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    .checkout-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .checkout-btn:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    .checkout-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Стили для блюд */
    .dish-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .dish-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    
    .dish-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
    
    .dish-content {
      padding: 16px;
    }
    
    .dish-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .dish-description {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .dish-price {
      font-size: 20px;
      font-weight: 700;
      color: #dc2626;
      margin-bottom: 16px;
    }
    
    .dish-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .add-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .add-btn:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .qty-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 50%;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .qty-btn:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    .qty-display {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      min-width: 30px;
      text-align: center;
    }
    
    /* Стили для категорий блюд */
    .category-section {
      margin-bottom: 32px;
    }
    
    .category-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin: 24px 12px 16px;
      padding-left: 8px;
      border-left: 4px solid #dc2626;
    }
    
    .dishes-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 0 12px;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Адаптивность для мобильных устройств - всегда 2 карточки в строке */
    @media (max-width: 600px) {
      .dishes-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        padding: 0 8px;
      }
    }
    
    @media (max-width: 480px) {
      .dishes-grid {
        grid-template-columns: repeat(2, 1fr); /* Всегда 2 карточки */
        gap: 6px;
        padding: 0 6px;
      }
      
      .dish-card {
        border-radius: 8px;
      }
      
      .dish-content {
        padding: 8px;
      }
      
      .dish-name {
        font-size: 14px;
        line-height: 1.2;
      }
      
      .dish-description {
        font-size: 12px;
        margin-bottom: 8px;
      }
      
      .dish-price {
        font-size: 16px;
        margin-bottom: 8px;
      }
      
      .add-btn {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .qty-btn {
        width: 28px;
        height: 28px;
        font-size: 16px;
      }
      
      .qty-display {
        font-size: 16px;
      }
    }
    
    /* Для очень маленьких экранов */
    @media (max-width: 360px) {
      .dishes-grid {
        gap: 4px;
        padding: 0 4px;
      }
      
      .dish-content {
        padding: 6px;
      }
      
      .dish-name {
        font-size: 13px;
      }
      
      .dish-description {
        font-size: 11px;
        margin-bottom: 6px;
      }
      
      .dish-price {
        font-size: 14px;
        margin-bottom: 6px;
      }
      
      .add-btn {
        padding: 6px 10px;
        font-size: 11px;
      }
    }
    
    /* Стили для кнопки назад */
    .back-button-container {
      position: sticky;
      top: 0;
      z-index: 200;
      background: #f8fafc;
      padding: 16px 16px 8px;
      margin-bottom: 0;
    }
    
    .back-btn {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      color: #333;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .back-btn:hover {
      background: #f8f8f8;
      border-color: #d0d0d0;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Стили для заголовка ресторана */
    .restaurant-header {
      padding: 16px 16px 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      position: relative;
      z-index: 100;
    }
    
    .restaurant-info {
      flex: 1;
      display: block !important;
    }
    
    .restaurant-info h1 {
      font-size: 24px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .restaurant-details-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      width: 100%;
    }
    
    .rating-section {
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .rating-section span:first-child {
      font-weight: 600;
      color: #333;
    }
    
    .rating-section span:last-child {
      color: #666;
      font-size: 14px;
    }
    
    .delivery-section {
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .delivery-icon {
      font-size: 16px;
    }
    
    .delivery-section span:last-child {
      color: #666;
      font-size: 14px;
    }
    
    .info-btn {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid #e5e5e5;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 250;
      position: relative;
    }
    
    .info-btn:hover {
      background-color: #f8f8f8;
      border-color: #d0d0d0;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    /* Стили для контейнера с блюдами */
    #dishesGrid {
      padding-top: 8px; /* Небольшой отступ от плашки категорий */
    }
    
    /* Стили для спейсера внизу */
    .bottom-spacer {
      height: 80px;
      transition: height 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Кнопка назад -->
    <div class="back-button-container">
      <button class="back-btn" onclick="goBack()">← Назад</button>
    </div>
    
    <!-- Заголовок ресторана -->
    <div class="restaurant-header">
      <div class="restaurant-info">
        <h1 id="restaurantName">Загрузка...</h1>
        <div class="restaurant-details-row">
          <div class="rating-section clickable-rating" onclick="showReviewsModal()">
            <span id="restaurantRating">★ --</span>
      <span class="reviews-arrow">→</span>
            <span id="restaurantReviews">-- отзывов</span>
          </div>
          <div class="delivery-section">
            <span class="delivery-icon">🚚</span>
            <span id="restaurantDelivery">-- мин</span>
          </div>
        </div>
      </div>
      <button class="info-btn" onclick="showRestaurantInfo()">ℹ️</button>
    </div>
    
    <!-- Категории блюд -->
    <div class="cat-row" id="categoriesRow"></div>
    
    <!-- Сетка блюд -->
    <div id="dishesGrid"></div>
    
    <!-- Спейсер для нижней плашки -->
    <div id="bottomSpacer" class="bottom-spacer"></div>
    
    <!-- Нижняя плашка заказа -->
    <div class="checkout-bar" id="checkoutBar">
      <div class="checkout-content">
        <div class="cart-info">
          <div class="cart-count" id="cartCount">0</div>
          <div>
            <div class="total-price" id="totalPriceBottom">0 ₽</div>
            <div class="min-order-note" id="minOrderText"></div>
          </div>
        </div>
        <button class="checkout-btn" id="goCheckout" onclick="proceedToCheckout()">Оформить заказ</button>
      </div>
    </div>
  </div>
  
  <!-- Модальное окно с информацией о ресторане -->
  <div class="restaurant-info-modal" id="restaurantInfoModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Информация о ресторане</h2>
        <button class="close-modal" id="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div class="info-section">
          <h3>Основная информация</h3>
          <div class="info-item">
            <span class="info-icon">📍</span>
            <span class="info-text" id="modalAddress">Адрес загружается...</span>
          </div>
          <div class="info-item">
            <span class="info-icon">📞</span>
            <span class="info-text" id="modalPhone">Телефон загружается...</span>
          </div>
          <div class="info-item">
            <span class="info-icon">🕒</span>
            <span class="info-text" id="modalWorkingHours">Режим работы загружается...</span>
          </div>
          <div class="info-item">
            <span class="info-icon">⭐</span>
            <span class="info-text" id="modalRating">Рейтинг загружается...</span>
          </div>
        </div>
        
        <div class="info-section">
          <h3>Кухня</h3>
          <div class="cuisine-tags" id="modalCuisine">
            <!-- Теги кухни будут добавлены динамически -->
          </div>
        </div>
        
        <div class="legal-info">
          <h4>Юридическая информация</h4>
          <p id="modalLegalName">Название компании загружается...</p>
          <p id="modalLegalAddress">Юридический адрес загружается...</p>
      <p id="modalLegalDetails">Реквизиты загружаются...</p>
    </div>
  </div>
</div>

<!-- Модальное окно для отзывов -->
<div class="restaurant-info-modal" id="reviewsModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Отзывы о ресторане</h2>
      <button class="close-modal" id="closeReviewsModal">×</button>
    </div>
    <div class="modal-body">
      <div id="reviewsList">
        <div class="loading-text">Загрузка отзывов...</div>
      </div>
    </div>
  </div>
</div>
  </div>
  
  <!-- Навигация -->
  <div class="nav-container">
    <a id="navHome" href="#" class="nav-item">
      <span class="nav-icon nav-icon-home"></span>
      <span>Главное</span>
    </a>
    <span class="nav-item disabled">
      <span class="nav-icon nav-icon-promo"></span>
      <span>Акции</span>
    </span>
    <a id="navCart" href="#" class="nav-item">
      <span class="nav-icon nav-icon-cart"></span>
      <span>Корзина</span>
    </a>
    <a id="navMenu" href="#" class="nav-item">
      <span class="nav-icon nav-icon-menu"></span>
      <span>Меню</span>
    </a>
    <a id="navProfile" href="#" class="nav-item">
      <span class="nav-icon nav-icon-profile"></span>
      <span>Профиль</span>
    </a>
  </div>
  
  <script>
    const api = location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    const q = new URLSearchParams(location.search);
    const uid = (q.get('uid') && Number(q.get('uid'))) || tg?.initDataUnsafe?.user?.id || 0;
    const headers = uid ? { 'X-Telegram-User-Id': String(uid) } : {};
    
    let restaurantId = Number(q.get('id')) || 0;
    let categories = [];
    let dishes = [];
    let cart = { items: [] };
    let dishesMap = new Map();
    let restaurantsMap = new Map();
    let activeCategory = null;
    let scrollPosition = 0; // Позиция прокрутки для навигации внутри страницы ресторана
    
    async function loadMenu() {
      try {
        const [catRes, dishRes, restRes] = await Promise.all([
          fetch(api + '/categories?restaurant_id=' + restaurantId + (uid ? ('&uid=' + uid) : ''), { headers }),
          fetch(api + '/dishes?restaurant_id=' + restaurantId + (uid ? ('&uid=' + uid) : ''), { headers }),
          fetch(api + '/restaurants/' + restaurantId + (uid ? ('?uid=' + uid) : ''), { headers })
        ]);
        
        categories = await catRes.json();
        dishes = await dishRes.json();
        const restaurant = await restRes.json();
        
        restaurantsMap.set(restaurant.id, restaurant);
        
        // Заполняем карту блюд
        dishes.forEach(dish => {
          dishesMap.set(dish.id, dish);
        });
        
        await renderRestaurantHeader(restaurant);
        renderCategories();
        renderDishes();
        
      } catch (error) {
        console.error('Error loading menu:', error);
      }
    }
    
    async function renderRestaurantHeader(restaurant) {
      document.getElementById('restaurantName').textContent = restaurant.name;
      
      // Формируем рейтинг
      const rating = restaurant.rating_agg 
        ? `★ ${Number(restaurant.rating_agg).toFixed(1)}`
        : '★ --';
      document.getElementById('restaurantRating').textContent = rating;
      
      // Загружаем количество отзывов из API
      try {
        // console.log('Loading reviews for restaurant ID:', restaurant.id);
        const reviewsRes = await fetch(api + '/reviews/restaurant/' + restaurant.id);
        // console.log('Reviews API response:', reviewsRes.status, reviewsRes.ok);
        if (reviewsRes.ok) {
          const reviewsData = await reviewsRes.json();
          // console.log('Reviews data:', reviewsData);
          const reviewsCount = reviewsData.total_reviews || 0;
          // console.log('Reviews count:', reviewsCount);
          document.getElementById('restaurantReviews').textContent = `${reviewsCount} отзывов`;
        } else {
          // console.log('Reviews API failed, using fallback');
          document.getElementById('restaurantReviews').textContent = '0 отзывов';
        }
      } catch (error) {
        console.error('Error loading reviews count:', error);
        document.getElementById('restaurantReviews').textContent = '0 отзывов';
      }
      
      // Формируем время доставки
      const deliveryTime = restaurant.delivery_time_min && restaurant.delivery_time_max
        ? `${restaurant.delivery_time_min}–${restaurant.delivery_time_max} мин`
        : restaurant.delivery_time_minutes 
          ? `${restaurant.delivery_time_minutes} мин`
          : '-- мин';
      document.getElementById('restaurantDelivery').textContent = deliveryTime;
    }
    
    function renderCategories() {
      const row = document.getElementById('categoriesRow');
      row.innerHTML = '';
      
      categories.forEach(category => {
        const button = document.createElement('button');
        button.textContent = category.name;
        button.onclick = () => {
          activeCategory = category.id;
          updateActiveCategory();
          scrollToCategory(category.id);
        };
        row.appendChild(button);
      });
      
      // Активируем первую категорию по умолчанию
      if (categories.length > 0) {
        activeCategory = categories[0].id;
        updateActiveCategory();
      }
    }
    
    function updateActiveCategory() {
      // Обновляем активную категорию в кнопках
      document.querySelectorAll('.cat-row button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      if (activeCategory) {
        const activeBtn = Array.from(document.querySelectorAll('.cat-row button')).find(btn => {
          const category = categories.find(c => c.name === btn.textContent);
          return category && category.id === activeCategory;
        });
        if (activeBtn) activeBtn.classList.add('active');
      }
    }
    
    function scrollToCategory(categoryId) {
      const categoryElement = document.querySelector(`[data-category="${categoryId}"]`);
      if (categoryElement) {
        categoryElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    function renderDishes() {
      const grid = document.getElementById('dishesGrid');
      grid.innerHTML = '';
      
      // Группируем блюда по категориям
      const dishesByCategory = {};
      dishes.forEach(dish => {
        if (!dishesByCategory[dish.category_id]) {
          dishesByCategory[dish.category_id] = [];
        }
        dishesByCategory[dish.category_id].push(dish);
      });
      
      // Рендерим каждую категорию
      categories.forEach(category => {
        const categoryDishes = dishesByCategory[category.id] || [];
        if (categoryDishes.length === 0) return;
        
        const categoryContainer = document.createElement('div');
        categoryContainer.className = 'category-section';
        categoryContainer.setAttribute('data-category', category.id);
        
        const categoryTitle = document.createElement('h2');
        categoryTitle.className = 'category-title';
        categoryTitle.textContent = category.name;
        categoryContainer.appendChild(categoryTitle);
        
        const dishesGrid = document.createElement('div');
        dishesGrid.className = 'dishes-grid';
        
        categoryDishes.forEach((dish, index) => {
          const card = document.createElement('div');
          card.className = 'dish-card';
          
          // Добавляем задержку для анимации появления
          card.style.animationDelay = `${index * 0.1}s`;
          
          card.innerHTML = `
            ${dish.image ? `<img src="${dish.image}" alt="${dish.name}" class="dish-image" />` : ''}
            <div class="dish-content">
              <h3 class="dish-name">${dish.name}</h3>
              <p class="dish-description">${dish.description || 'Описание отсутствует'}</p>
              <div class="dish-price">${dish.price || 0} ₽</div>
              <div class="dish-controls">
                <div class="controls" data-dish="${dish.id}" data-category="${dish.category_id}">
                  <button class="add-btn">+</button>
                </div>
              </div>
            </div>
          `;
          
          // Делаем всю карточку кликабельной для перехода к блюду
          card.onclick = (e) => {
            // Если кликнули на кнопку добавления или управления количеством, не переходим к блюду
            if (e.target.closest('.add-btn') || e.target.closest('.qty-btn')) {
              return;
            }
            
            // Сохраняем позицию прокрутки перед переходом к блюду
            saveScrollPosition();
            
            const p = new URLSearchParams(location.search);
            if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning','1');
            p.set('category_id', dish.category_id);
            p.set('scroll_position', scrollPosition.toString());
            location.href = '/static/dish.html?id=' + dish.id + '&' + p.toString();
          };
          
          const controls = card.querySelector('.controls');
          // Обработчик будет установлен в renderQtyControls
          dishesGrid.appendChild(card);
        });
        
        categoryContainer.appendChild(dishesGrid);
        grid.appendChild(categoryContainer);
      });
      
      loadCartAndSync();
      
      // Восстанавливаем позицию прокрутки после загрузки контента только при переходе из блюда
      const urlParams = new URLSearchParams(location.search);
      const savedScrollPosition = Number(urlParams.get('scroll_position')) || 0;
      const fromPage = urlParams.get('from');
      
      if (savedScrollPosition > 0 && fromPage === 'dish') {
        // Небольшая задержка для завершения рендеринга
        setTimeout(() => {
          window.scrollTo(0, savedScrollPosition);
          console.log('Restored scroll position after content load:', savedScrollPosition);
        }, 100);
      }
    }
    
    async function addToCart(dishId, deltaQty) {
      const dish = dishesMap.get(dishId);
      
      const cartData = { 
        restaurant_id: dish.restaurant_id, 
        dish_id: dish.id, 
        qty: deltaQty,
        chosen_options: [] // Пустой массив для блюд без опций
      };
      
      const res = await fetch(location.origin + '/api/cart/items' + (uid ? ('?uid=' + uid) : ''), {
        method: 'POST',
        headers: {
          ...headers,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(cartData)
      });
      
      // console.log('Response status:', res.status);
      
      if (!res.ok) {
        const errorText = await res.text();
        console.error('Error response:', errorText);
        throw new Error(`HTTP ${res.status}: ${errorText}`);
      }
      
      const data = await res.json();
      // console.log('Response data:', data);
      
      if (data.status === 'too_many_restaurants') {
        showTooManyModal(data.current_restaurant_ids || [], async () => {
          await fetch(location.origin + '/api/cart/items?force=true' + (uid ? ('&uid=' + uid) : ''), { 
            method: 'POST', 
            headers: {
              ...headers,
              'Content-Type': 'application/json'
            }, 
            body: JSON.stringify(cartData) 
          });
          await loadCartAndSync();
        });
      } else {
        await loadCartAndSync();
      }
    }
    
    async function loadCartAndSync() {
      const res = await fetch(api + '/cart' + (uid ? ('?uid=' + uid) : ''), { headers });
      cart = await res.json();
      clearQtyCache(); // Очищаем кэш перед обновлением
      renderQtyControls();
      updateOrderSummary(); // Обновляем информацию в нижней плашке
    }
    
    // Кэш для количеств блюд
    let qtyCache = new Map();
    
    function getQtyForDish(dishId) {
      // Проверяем кэш
      if (qtyCache.has(dishId)) {
        return qtyCache.get(dishId);
      }
      
      const qty = cart.items.filter(i => i.dish_id === dishId && dishesMap.get(i.dish_id)?.restaurant_id === restaurantId)
        .reduce((s, i) => s + i.qty, 0);
      
      // Сохраняем в кэш
      qtyCache.set(dishId, qty);
      return qty;
    }
    
    // Очищаем кэш при обновлении корзины
    function clearQtyCache() {
      qtyCache.clear();
    }
    
    function renderQtyControls() {
      // Кэшируем элементы для оптимизации
      const controls = document.querySelectorAll('.controls');
      if (controls.length === 0) return; // Если нет элементов, выходим
      
      controls.forEach(c => {
        const dishId = Number(c.getAttribute('data-dish'));
        const dish = dishesMap.get(dishId);
        const qty = getQtyForDish(dishId);
        // console.log('DEBUG: renderQtyControls - dishId:', dishId, 'dish:', dish, 'has_options:', dish?.has_options, 'qty:', qty);
        
        if (qty <= 0) {
          // Кнопка "+" для добавления блюда
          c.innerHTML = '<button class="add-btn">+</button>';
          const addBtn = c.querySelector('.add-btn');
          addBtn.onclick = () => {
            // Если у блюда есть опции, переходим к странице блюда
            if (dish?.has_options) {
              // Сохраняем позицию прокрутки перед переходом к блюду
              saveScrollPosition();
              
              const p = new URLSearchParams(location.search);
              if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning','1');
              const categoryId = c.getAttribute('data-category');
        p.set('category_id', categoryId);
        p.set('scroll_position', scrollPosition.toString());
        location.href = '/static/dish.html?id=' + dishId + '&' + p.toString();
              return;
            }
            // Если опций нет, добавляем в корзину с анимацией
            addBtn.classList.add('success-animation');
            setTimeout(() => {
              addBtn.classList.remove('success-animation');
            }, 600);
            updateQtyClient(dishId, 1);
          };
        } else {
          // Контролы с количеством: "-" количество "+"
          c.innerHTML = `
            <div class="qty-controls">
              <button class="qty-btn" data-act="dec" title="Уменьшить количество">−</button>
              <span class="qty-display">${qty}</span>
              <button class="qty-btn" data-act="inc" title="Увеличить количество">+</button>
            </div>
          `;
          
          // Добавляем анимацию появления контролов
          c.style.animation = 'fadeInUp 0.3s ease-out';
          
          // Обработчик для кнопки "-"
          c.querySelector('[data-act="dec"]').onclick = () => updateQtyClient(dishId, -1);
          
          // Обработчик для кнопки "+"
          c.querySelector('[data-act="inc"]').onclick = () => {
            // console.log('DEBUG: renderQtyControls + button clicked - dishId:', dishId, 'dish:', dish, 'has_options:', dish?.has_options);
            // Если у блюда есть опции, переходим к странице блюда
            if (dish?.has_options) {
              // console.log('DEBUG: Redirecting to dish page for options');
              // Сохраняем позицию прокрутки перед переходом к блюду
              saveScrollPosition();
              
              const p = new URLSearchParams(location.search);
              if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning','1');
              const categoryId = c.getAttribute('data-category');
        p.set('category_id', categoryId);
        p.set('scroll_position', scrollPosition.toString());
        location.href = '/static/dish.html?id=' + dishId + '&' + p.toString();
              return;
            }
            // console.log('DEBUG: Adding to cart directly');
            // Если опций нет, добавляем в корзину
            updateQtyClient(dishId, 1);
          };
        }
      });
    }
    
    async function updateQtyClient(dishId, delta) {
      if (delta > 0) {
        // console.log('DEBUG: Adding to cart directly');
        await addToCart(dishId, 1);
      } else {
        const item = cart.items.find(i => i.dish_id === dishId && dishesMap.get(i.dish_id)?.restaurant_id === restaurantId);
        if (item) {
          const newQty = Math.max(0, item.qty - 1);
          if (newQty === 0) {
            await fetch(api + '/cart/items/' + item.id + (uid ? ('?uid=' + uid) : ''), { method: 'DELETE', headers });
          } else {
            await fetch(api + '/cart/items/' + item.id + '?qty=' + newQty + (uid ? ('&uid=' + uid) : ''), { method: 'PATCH', headers });
          }
          await loadCartAndSync();
        }
      }
    }
    
    function calcTotalForRestaurant() {
      return cart.items.reduce((sum, it) => {
        const d = dishesMap.get(it.dish_id);
        if (!d || d.restaurant_id !== restaurantId) return sum;
        return sum + (d.price || 0) * it.qty;
      }, 0);
    }
    
    function updateOrderSummary() {
      const sum = calcTotalForRestaurant();
      const totalItems = cart.items.filter(i => {
        const d = dishesMap.get(i.dish_id);
        return d && d.restaurant_id === restaurantId;
      }).reduce((s, i) => s + i.qty, 0);
      
      // Обновляем количество товаров
      document.getElementById('cartCount').textContent = totalItems;
      document.getElementById('totalPriceBottom').textContent = sum + ' ₽';
      
      // Минимальная сумма заказа из данных ресторана
      const r = restaurantsMap.get(restaurantId);
      const checkoutBtn = document.getElementById('goCheckout');
      
      if (r && r.delivery_min_sum && r.delivery_min_sum > 0) {
        const remaining = Math.max(0, r.delivery_min_sum - sum);
        if (remaining > 0) {
          document.getElementById('minOrderText').textContent = `Еще ${remaining} ₽ до минимального заказа`;
          checkoutBtn.disabled = true;
          checkoutBtn.textContent = `Добавьте еще на ${remaining} ₽`;
          checkoutBtn.className = 'checkout-btn disabled';
        } else {
          document.getElementById('minOrderText').textContent = 'Минимальная сумма заказа достигнута';
          checkoutBtn.disabled = false;
          checkoutBtn.textContent = 'Оформить заказ';
          checkoutBtn.className = 'checkout-btn';
        }
      } else {
        // Заглушка если нет данных о минимальной сумме
        const minOrder = 1000;
        const remaining = Math.max(0, minOrder - sum);
        if (remaining > 0) {
          document.getElementById('minOrderText').textContent = `Еще ${remaining} ₽ до минимального заказа`;
          checkoutBtn.disabled = true;
          checkoutBtn.textContent = `Добавьте еще на ${remaining} ₽`;
          checkoutBtn.className = 'checkout-btn disabled';
        } else {
          document.getElementById('minOrderText').textContent = 'Минимальная сумма заказа достигнута';
          checkoutBtn.disabled = false;
          checkoutBtn.textContent = 'Оформить заказ';
          checkoutBtn.className = 'checkout-btn';
        }
      }
      
      // Показываем/скрываем нижнюю плашку
      const checkoutBar = document.getElementById('checkoutBar');
      const bottomSpacer = document.getElementById('bottomSpacer');
      
      if (sum > 0) {
        checkoutBar.style.display = 'block';
        bottomSpacer.style.height = '80px';
      } else {
        checkoutBar.style.display = 'none';
        bottomSpacer.style.height = '0px';
      }
    }
    
    // Функция для перехода к оформлению заказа
    function proceedToCheckout() {
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      p.set('r', String(restaurantId));
      location.href = '/static/cart.html?' + p.toString();
    }
    
    // Функции для работы с модальным окном
    function showRestaurantInfo() {
      const restaurant = restaurantsMap.get(restaurantId);
      if (!restaurant) return;
      
      // Заполняем данные в модальном окне
      document.getElementById('modalAddress').textContent = restaurant.address || 'Адрес не указан';
      document.getElementById('modalPhone').textContent = restaurant.phone || 'Телефон не указан';
      
      // Формируем информацию о режиме работы
      const workingHours = restaurant.work_open_min !== undefined && restaurant.work_close_min !== undefined 
        ? `Работаем с ${formatTime(restaurant.work_open_min)} до ${formatTime(restaurant.work_close_min)}`
        : 'Режим работы: ежедневно';
      document.getElementById('modalWorkingHours').textContent = workingHours;
      
      // Формируем рейтинг
      const rating = restaurant.rating_agg 
        ? `★ ${Number(restaurant.rating_agg).toFixed(1)}`
        : '★ --';
      document.getElementById('modalRating').textContent = rating;
      
      // Формируем теги кухни (используем доступные данные)
      const cuisineTags = ['Американская', 'Бургеры', 'Завтраки', 'Кофе', 'Фастфуд', 'Десерты'];
      const cuisineContainer = document.getElementById('modalCuisine');
      cuisineContainer.innerHTML = '';
      cuisineTags.forEach(tag => {
        const tagElement = document.createElement('span');
        tagElement.className = 'cuisine-tag';
        tagElement.textContent = tag;
        cuisineContainer.appendChild(tagElement);
      });
      
      // Заполняем юридическую информацию (заглушки, так как у нас нет этих данных)
      document.getElementById('modalLegalName').textContent = 'ООО "Система ПБО"';
      document.getElementById('modalLegalAddress').textContent = '115054, Россия, г. Москва, Валовая, дом 26';
      document.getElementById('modalLegalDetails').textContent = 'ИНН 7710044140, рег. номер 1027700251754';
      
      // Показываем модальное окно
      const modal = document.getElementById('restaurantInfoModal');
      modal.classList.add('show');
      
      // Добавляем обработчик для закрытия по клику вне модального окна
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          hideRestaurantInfo();
        }
      });
    }
    
    function hideRestaurantInfo() {
      const modal = document.getElementById('restaurantInfoModal');
      modal.classList.remove('show');
    }
    
    function formatTime(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
    }
    
    // Modal for too many restaurants
    function ensureOverlay() {
      let ov = document.getElementById('ov');
      if (!ov) {
        ov = document.createElement('div');
        ov.id = 'ov';
        ov.className = 'overlay';
        ov.innerHTML = '<div class="modal"><h3>Слишком много корзин</h3><div class="muted">Удалите корзину, чтобы собрать новую</div><div id="ovList"></div><div style="margin-top:10px;text-align:right"><button id="ovDone" class="primary">Готово</button></div></div>';
        document.body.appendChild(ov);
      }
      return ov;
    }
    
    async function showTooManyModal(restIds, onDone) {
      const ov = ensureOverlay();
      const list = ov.querySelector('#ovList');
      list.innerHTML = '';
      
      // Load names
      const resR = await fetch(api + '/restaurants/_bulk?ids=' + encodeURIComponent(restIds.join(',')) + (uid ? ('&uid=' + uid) : ''), { headers });
      const rests = resR.ok ? await resR.json() : [];
      rests.forEach(r => {
        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `<div>${r.name}</div><button class="trash">🗑</button>`;
        row.querySelector('.trash').onclick = async () => {
          await fetch(api + '/cart/clear?restaurant_id=' + r.id + (uid ? ('&uid=' + uid) : ''), { method: 'POST', headers });
          row.remove();
        };
        list.appendChild(row);
      });
      ov.style.display = 'flex';
      ov.querySelector('#ovDone').onclick = async () => {
        ov.style.display = 'none';
        if (onDone) await onDone();
      };
    }
    
    // Navigation
    document.getElementById('navHome').onclick = (e) => { 
      e.preventDefault(); 
      const p = new URLSearchParams(location.search); 
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); 
      location.href = '/static/index.html?' + p.toString(); 
    };
    
    document.getElementById('navCart').onclick = (e) => { 
      e.preventDefault(); 
      const p = new URLSearchParams(location.search); 
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); 
      location.href = '/static/cart.html?' + p.toString(); 
    };
    
    document.getElementById('navProfile').onclick = (e) => { 
      e.preventDefault(); 
      const p = new URLSearchParams(location.search); 
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1'); 
      location.href = '/static/profile.html?' + p.toString(); 
    };
    
    // Функции для работы с позицией прокрутки
    function saveScrollPosition() {
      scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
      console.log('Saved scroll position:', scrollPosition);
    }
    
    function restoreScrollPosition() {
      if (scrollPosition > 0) {
        // Проверяем, что высота страницы достаточна для скролла
        const pageHeight = Math.max(
          document.body.scrollHeight,
          document.body.offsetHeight,
          document.documentElement.clientHeight,
          document.documentElement.scrollHeight,
          document.documentElement.offsetHeight
        );
        
        if (pageHeight > scrollPosition) {
          window.scrollTo(0, scrollPosition);
          console.log('Restored scroll position:', scrollPosition);
        } else {
          console.log('Page height too small for scroll position:', pageHeight, 'vs', scrollPosition);
        }
      }
    }
    
    // Функция для возврата назад
    function goBack() {
      console.log('=== goBack called ===');
      
      // Получаем оригинальную позицию прокрутки из URL (которая была на главной странице)
      const originalScrollPosition = Number(q.get('scroll_position')) || 0;
      console.log('Original scroll position from URL:', originalScrollPosition);
      
      // Ресторан → главная страница с оригинальной позицией прокрутки
      const params = new URLSearchParams(location.search);
      if (!params.get('ngrok-skip-browser-warning')) params.set('ngrok-skip-browser-warning', '1');
      params.set('scroll_position', originalScrollPosition.toString());
      
      // Очищаем параметры, которые не нужны на главной странице
      params.delete('id');
      params.delete('category_id');
      params.delete('scroll_to_category');
      
      const finalUrl = '/static/index.html?' + params.toString();
      console.log('Final URL:', finalUrl);
      console.log('URL params:', params.toString());
      console.log('Redirecting to index.html with original scroll_position:', originalScrollPosition);
      
      location.href = finalUrl;
    }
    
    // Проверяем, нужно ли скроллить к категории
    const urlParams = new URLSearchParams(location.search);
    
    // Восстанавливаем позицию прокрутки только при возврате со страницы блюда
    const savedScrollPosition = Number(urlParams.get('scroll_position')) || 0;
    const fromPage = urlParams.get('from');
    
    console.log('From page:', fromPage, 'Saved scroll position:', savedScrollPosition);
    
    if (savedScrollPosition > 0 && fromPage === 'dish') {
      // Устанавливаем позицию в переменную для использования в restoreScrollPosition
      scrollPosition = savedScrollPosition;
      console.log('Scroll position changed to:', savedScrollPosition);
      
      // Сразу устанавливаем позицию прокрутки
      window.scrollTo(0, savedScrollPosition);
      console.log('Immediate scroll to position:', savedScrollPosition);
    } else if (fromPage === 'index') {
      console.log('Transition from index page - no scroll restoration needed');
    }
    
    // Primary initialization
    loadMenu();
    
    const scrollToCategoryId = urlParams.get('scroll_to_category');
    if (scrollToCategoryId) {
      // Ждем загрузки меню и скроллим к категории
      setTimeout(() => {
        scrollToCategory(scrollToCategoryId);
      }, 100);
    }
    
    // Add scroll handler for updating active category
    window.addEventListener('scroll', updateActiveCategory);
    
    // Modal close handler
    document.getElementById('closeModal').onclick = hideRestaurantInfo;
    document.getElementById('closeReviewsModal').onclick = hideReviewsModal;
    // Инициализируем свайп при загрузке страницы
    initSwipe();
    
    // Функции для работы с отзывами
    async function showReviewsModal() {
      console.log('Opening reviews modal...');
      
      // Создаем модальное окно динамически
      const existingModal = document.getElementById('reviewsModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      const modal = document.createElement('div');
      modal.id = 'reviewsModal';
      modal.className = 'restaurant-info-modal show';
      modal.style.cssText = `
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: rgba(0, 0, 0, 0.5) !important;
        z-index: 1001 !important;
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.className = 'modal-content';
      modalContent.style.cssText = `
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 80vh !important;
        background: #fff !important;
        border-radius: 20px 20px 0 0 !important;
        transform: translateY(0) !important;
        transition: transform 0.3s ease !important;
        overflow-y: auto !important;
        z-index: 1002 !important;
        min-height: 400px !important;
      `;
      
      modalContent.innerHTML = `
        <div class="modal-header">
          <button class="back-button" onclick="hideReviewsModal()">←</button>
          <h2 class="modal-title">Отзывы</h2>
          <div class="header-spacer"></div>
        </div>
        <div class="modal-body">
          <div id="reviewsList">
            <div class="loading-text">Загрузка отзывов...</div>
          </div>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      console.log('Modal created and added to DOM');
      console.log('Modal dimensions:', modal.offsetWidth, 'x', modal.offsetHeight);
      console.log('Modal content dimensions:', modalContent.offsetWidth, 'x', modalContent.offsetHeight);
      
      // Загружаем отзывы
      try {
        const reviewsList = document.getElementById('reviewsList');
        reviewsList.innerHTML = '<div class="loading-text">Загрузка отзывов...</div>';
        
        const response = await fetch(api + '/reviews/restaurant/' + restaurantId);
        if (response.ok) {
          const data = await response.json();
          displayReviews(data.reviews || []);
        } else {
          reviewsList.innerHTML = '<div class="no-reviews">Ошибка загрузки отзывов</div>';
        }
      } catch (error) {
        console.error('Error loading reviews:', error);
        reviewsList.innerHTML = '<div class="no-reviews">Ошибка загрузки отзывов</div>';
      }
      
      // Обработчик клика вне модального окна
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          hideReviewsModal();
        }
      });
    }
    
    function hideReviewsModal() {
      const modal = document.getElementById('reviewsModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // Функция для форматирования даты
    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diffTime = Math.abs(now - date);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      if (diffDays === 1) {
        return `Вчера в ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
      } else if (diffDays === 2) {
        return `Позавчера в ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
      } else if (diffDays <= 7) {
        return `${diffDays} дн. назад в ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
      } else {
        return `${date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' })} в ${date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}`;
      }
    }
    
    function displayReviews(reviews) {
      const reviewsList = document.getElementById('reviewsList');
      
      if (reviews.length === 0) {
        reviewsList.innerHTML = '<div class="no-reviews">Пока нет отзывов о этом ресторане</div>';
        return;
      }
      
      reviewsList.innerHTML = reviews.map(review => `
        <div class="review-item">
          <div class="review-header">
            <div class="reviewer-info">
              <div class="thumbs-up-icon"></div>
              <span class="reviewer-name">${review.user_name || 'Аноним'}</span>
            </div>
            <span class="review-date">${formatDate(review.created_at)}</span>
          </div>
          <div class="review-text">${review.comment || 'Без комментария'}</div>
          ${review.ordered_items ? `<div class="ordered-items">${review.ordered_items}</div>` : ''}
        </div>
      `).join('');
    }
    
    // Функция для инициализации свайпа
    function initSwipe() {
      let startX = 0;
      let startY = 0;
      let currentX = 0;
      let isSwipeActive = false;
      let swipeThreshold = 0;
      const minSwipeDistance = 80; // Уменьшена минимальная дистанция
      const maxVerticalDistance = 80; // Увеличено вертикальное отклонение
      const swipeZone = 50; // Зона от края экрана для начала свайпа
      
      document.addEventListener('touchstart', (e) => {
        const touchX = e.touches[0].clientX;
        const touchY = e.touches[0].clientY;
        
        // Начинаем свайп только если касание в правой части экрана
        if (touchX > window.innerWidth - swipeZone) {
          startX = touchX;
          startY = touchY;
          isSwipeActive = true;
          swipeThreshold = 0;
        }
      }, { passive: true });
      
      document.addEventListener('touchmove', (e) => {
        if (!isSwipeActive) return;
        
        currentX = e.touches[0].clientX;
        const deltaX = currentX - startX;
        const deltaY = Math.abs(e.touches[0].clientY - startY);
        
        // Если свайп влево и вертикальное отклонение не слишком большое
        if (deltaX < 0 && deltaY < maxVerticalDistance) {
          const swipeDistance = Math.abs(deltaX);
          const progress = Math.min(swipeDistance / (window.innerWidth * 0.3), 1);
          
          // Более плавная анимация с лучшим откликом
          document.body.style.transform = `translateX(${deltaX * 0.4}px)`;
          document.body.style.opacity = Math.max(0.3, 1 - progress * 0.7);
          
          // Визуальная обратная связь - меняем курсор
          document.body.style.cursor = 'grabbing';
          
          // Устанавливаем порог для срабатывания
          swipeThreshold = progress;
        }
      }, { passive: true });
      
      document.addEventListener('touchend', (e) => {
        if (!isSwipeActive) return;
        
        const deltaX = currentX - startX;
        const deltaY = Math.abs(e.changedTouches[0].clientY - startY);
        
        // Сбрасываем стили
        document.body.style.transform = '';
        document.body.style.opacity = '';
        document.body.style.cursor = '';
        
        // Проверяем условия для закрытия
        if (deltaX < -minSwipeDistance && deltaY < maxVerticalDistance && swipeThreshold > 0.3) {
          // Добавляем класс для анимации
          document.body.classList.add('swipe-animation', 'swipe-closing');
          
          // Закрываем страницу после анимации
          setTimeout(() => {
            goBack();
          }, 250);
        }
        
        isSwipeActive = false;
        swipeThreshold = 0;
      }, { passive: true });
    }
  </script>
</body>
</html>