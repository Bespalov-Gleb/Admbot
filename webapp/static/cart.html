<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="/static/styles.v23.css?v=50" />
  <script src="/static/page-transitions.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #333;
    }
    
    .container {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
      position: relative;
      padding-bottom: 120px;
    }
    
    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      background: white;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .back-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    
    .header-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .clear-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    
    /* Restaurant Tabs */
    .restaurant-tabs {
      display: flex;
      gap: 8px;
      padding: 16px;
      overflow-x: auto;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .restaurant-tab {
      flex-shrink: 0;
      padding: 12px 20px;
      border: 2px solid transparent;
      border-radius: 12px;
      background: #f3f4f6;
      color: #666;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      min-width: 140px;
    }
    
    .restaurant-tab.active {
      border-color: #dc2626;
      background: #dc2626;
      color: white;
    }
    
    .restaurant-tab-info {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .restaurant-tab-name {
      font-weight: 600;
      text-align: center;
    }
    
    .restaurant-tab-price {
      color: inherit;
    }
    
    .restaurant-tab-time {
      color: inherit;
    }
    
    /* Cart Items */
    .cart-items {
      padding: 16px;
    }
    
    .cart-item {
      display: flex;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid #f3f4f6;
      align-items: flex-start;
    }
    
    .cart-item:last-child {
      border-bottom: none;
    }
    
    .cart-item-image {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .cart-item-content {
      flex: 1;
      min-width: 0;
    }
    
    .cart-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    
    .cart-item-name {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      flex-grow: 1;
      margin-right: 10px;
    }
    
    .cart-item-description {
      font-size: 14px;
      color: #666;
      margin-bottom: 4px;
      line-height: 1.4;
    }
    
    .cart-item-price {
      font-size: 16px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .cart-item-weight {
      font-size: 14px;
      color: #666;
      margin-bottom: 12px;
    }
    
    .cart-item-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .qty-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 50%;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }
    
    .qty-btn:hover {
      background: #f3f4f6;
    }
    
    .qty-btn.plus {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    
    .qty-btn.plus:hover {
      background: #b91c1c;
    }
    
    .qty-display {
      min-width: 30px;
      text-align: center;
      font-weight: 600;
      font-size: 16px;
    }
    
    /* Open Menu Button */
    .open-menu-btn {
      margin: 16px;
      width: calc(100% - 32px);
      padding: 16px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 12px;
      color: #666;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .open-menu-btn:hover {
      background: #f3f4f6;
      border-color: #d1d5db;
    }
    
    /* Bottom Checkout Bar */
    .checkout-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      z-index: 1000;
    }
    
    .checkout-content {
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 16px;
    }
    
    
    .checkout-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .total-sum {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }
    
    .checkout-btn {
      background: #dc2626;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .checkout-btn:hover {
      background: #b91c1c;
      transform: translateY(-1px);
    }
    
    .checkout-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    
    .checkout-btn.min-order-warning {
      background: #f3f4f6;
      color: #666;
      border: 1px solid #d1d5db;
      cursor: not-allowed;
      transform: none;
    }
    
    .checkout-btn.min-order-warning:hover {
      background: #f3f4f6;
      transform: none;
    }
    
    /* Empty cart */
    .empty-cart {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
    
    .empty-cart-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-cart-text {
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .empty-cart-subtext {
      font-size: 14px;
      opacity: 0.7;
    }

    /* Too many carts page */
    .too-many-carts {
      padding: 20px;
      text-align: center;
    }

    .too-many-header h2 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .too-many-header p {
      font-size: 14px;
      color: #666;
    }

    .carts-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .cart-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      background: #f3f4f6;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .cart-card-content {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .cart-card-name {
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .cart-card-items {
      display: flex;
      gap: 5px;
    }

    .cart-item-thumb {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
    }

    .cart-card-delete {
      width: 32px;
      height: 32px;
      border: none;
      background: none;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    
    .too-many-footer {
      margin-top: 30px;
      padding: 20px;
    }
    
    .done-btn {
      width: 100%;
      padding: 16px;
      background: #6b7280;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .done-btn:hover {
      background: #4b5563;
    }

    
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <button class="back-btn" onclick="goBack()">√ó</button>
        <div class="header-title">–ö–æ—Ä–∑–∏–Ω–∞</div>
      </div>
      <button class="clear-btn" onclick="clearCart()">üóëÔ∏è</button>
    </div>
    
    <!-- Restaurant Tabs -->
    <div class="restaurant-tabs" id="restaurantTabs"></div>
    
    <!-- Cart Items -->
    <div class="cart-items" id="cartItems"></div>
    
    <!-- Open Menu Button -->
    <button class="open-menu-btn" id="openMenuBtn" onclick="openMenu()">–û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é</button>
    
    <!-- Bottom Checkout Bar -->
    <div class="checkout-bar" id="checkout-bar">
      <div class="checkout-content">
        <div class="checkout-right">
          <div class="total-sum" id="totalSum">–ò—Ç–æ–≥–æ 0 ‚ÇΩ</div>
          <button class="checkout-btn" id="checkoutBtn" onclick="proceedToCheckout()" disabled>–î–∞–ª–µ–µ</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    const api = location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    const q = new URLSearchParams(location.search);
    const uid = (q.get('uid') && Number(q.get('uid'))) || tg?.initDataUnsafe?.user?.id || 0;
    const headers = uid ? { 'X-Telegram-User-Id': String(uid) } : {};
    
    let cart = null;
    let dishesMap = new Map();
    let restaurantsMap = new Map();
    let optionsMap = new Map();
    
    const url = new URL(location.href);
    let activeRestaurantId = Number(url.searchParams.get('r')) || 0;
    let restIdsCached = [];
    const orderId = url.searchParams.get('order_id');

    async function load() {
      // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω order_id, –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞ –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∫–æ—Ä–∑–∏–Ω—É
      if (orderId) {
        await loadOrderToCart(orderId);
        return;
      }
      try {
        console.log('Loading cart...');
      const res = await fetch(api + '/cart' + (uid ? ('?uid=' + uid) : ''), { headers });
        console.log('Cart response status:', res.status);
        
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
      cart = await res.json();
        console.log('Cart data:', cart);
        console.log('Cart items count:', cart.items?.length || 0);
        
        if (!cart.items || !cart.items.length) {
          console.log('Cart is empty, showing empty state');
          showEmptyCart();
        return;
      }
        
      const ids = [...new Set(cart.items.map(i => i.dish_id))];
        console.log('Dish IDs to fetch:', ids);
        
      const dishes = await (await fetch(api + '/dishes?ids=' + ids.join(',') + (uid ? ('&uid=' + uid) : ''), { headers })).json();
        console.log('Dishes loaded:', dishes.length);
      dishesMap = new Map(dishes.map(d => [d.id, d]));
        
      const optionIds = [...new Set(cart.items.flatMap(i => (i.chosen_options || [])))];
      if (optionIds.length) {
        const opts = await (await fetch(api + '/options/lookup?ids=' + optionIds.join(','))).json();
        optionsMap = new Map(opts.map(o => [o.id, o]));
      }
        
      const restIds = [...new Set(cart.items.map(i => dishesMap.get(i.dish_id)?.restaurant_id))].filter(Boolean);
        console.log('Restaurant IDs:', restIds);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
        if (restIds.length > 4) {
          showTooManyRestaurants(restIds);
          return;
        }
        
      const resR = await fetch(api + '/restaurants/_bulk?ids=' + encodeURIComponent(restIds.join(',')) + (uid ? ('&uid=' + uid) : ''), { headers });
      const rests = resR.ok ? await resR.json() : await (await fetch(api + '/restaurants/_by-ids?ids=' + encodeURIComponent(restIds.join(',')) + (uid ? ('&uid=' + uid) : ''), { headers })).json();
      restaurantsMap = new Map(rests.map(r => [r.id, r]));
        
      if (!activeRestaurantId) activeRestaurantId = restIds[0];
      restIdsCached = restIds;
        
        console.log('Rendering restaurant tabs and cart items...');
        renderRestaurantTabs();
        renderCartItems();
        
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º checkout-bar –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã
        document.getElementById('checkout-bar').style.display = 'block';
        updateCheckoutBar();
        
      } catch (error) {
        console.error('Error loading cart:', error);
        console.log('Showing empty cart due to error');
        showEmptyCart();
      }
    }

    async function loadOrderToCart(orderId) {
      try {
        console.log('Loading order to cart, order ID:', orderId);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
        const orderRes = await fetch(api + '/orders/' + orderId, { headers });
        if (!orderRes.ok) {
          throw new Error(`Failed to load order: ${orderRes.status}`);
        }
        
        const order = await orderRes.json();
        console.log('Order loaded:', order);
        
        // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â—É—é –∫–æ—Ä–∑–∏–Ω—É
        await fetch(api + '/cart/clear', { 
          method: 'POST', 
          headers: { ...headers, 'Content-Type': 'application/json' }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –∏–∑ –∑–∞–∫–∞–∑–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
        for (const item of order.items) {
          const addItemPayload = {
            dish_id: item.dish_id,
            qty: item.qty,
            chosen_options: item.chosen_options || []
          };
          
          await fetch(api + '/cart/add', {
            method: 'POST',
            headers: { ...headers, 'Content-Type': 'application/json' },
            body: JSON.stringify(addItemPayload)
          });
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É
        await load();
        
      } catch (error) {
        console.error('Error loading order to cart:', error);
        showEmptyCart();
      }
    }

    function showEmptyCart() {
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
      document.getElementById('restaurantTabs').style.display = 'flex';
      document.getElementById('openMenuBtn').style.display = 'block';
      document.getElementById('checkout-bar').style.display = 'block';
      
      document.getElementById('cartItems').innerHTML = `
        <div class="empty-cart">
          <div class="empty-cart-icon">üõí</div>
          <div class="empty-cart-text">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
          <div class="empty-cart-subtext">–î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –∏–∑ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</div>
        </div>
      `;
      document.getElementById('restaurantTabs').innerHTML = '';
      updateCheckoutBar();
    }

    function redirectToRestaurants() {
      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ø–∏—Å–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –ø—Ä–∏ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ
      const params = new URLSearchParams(location.search);
      if (!params.get('ngrok-skip-browser-warning')) params.set('ngrok-skip-browser-warning', '1');
      location.href = '/static/index.html?' + params.toString();
    }
    
    function redirectToRestaurant(restaurantId) {
      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
      const params = new URLSearchParams(location.search);
      if (!params.get('ngrok-skip-browser-warning')) params.set('ngrok-skip-browser-warning', '1');
      location.href = `/static/restaurant.html?id=${restaurantId}&${params.toString()}`;
    }

    function showTooManyRestaurants(restIds) {
      // –°–∫—Ä—ã–≤–∞–µ–º –æ–±—ã—á–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∫–æ—Ä–∑–∏–Ω—ã
      document.getElementById('restaurantTabs').style.display = 'none';
      document.getElementById('openMenuBtn').style.display = 'none';
      document.getElementById('checkout-bar').style.display = 'none';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ—Ä–∑–∏–Ω"
      document.getElementById('cartItems').innerHTML = `
        <div class="too-many-carts">
          <div class="too-many-header">
            <h2>–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∫–æ—Ä–∑–∏–Ω</h2>
            <p>–£–¥–∞–ª–∏—Ç–µ –∫–æ—Ä–∑–∏–Ω—É, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –Ω–æ–≤—É—é –≤ –∑–∞–≤–µ–¥–µ–Ω–∏–∏</p>
          </div>
          <div class="carts-list" id="cartsList"></div>
          <div class="too-many-footer">
            <button class="done-btn" onclick="goBack()">–ì–æ—Ç–æ–≤–æ</button>
          </div>
        </div>
      `;
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∑–∏–Ω
      loadCartsList(restIds);
    }
    
    async function loadCartsList(restIds) {
      try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
        const resR = await fetch(api + '/restaurants/_bulk?ids=' + encodeURIComponent(restIds.join(',')) + (uid ? ('&uid=' + uid) : ''), { headers });
        const rests = resR.ok ? await resR.json() : await (await fetch(api + '/restaurants/_by-ids?ids=' + encodeURIComponent(restIds.join(',')) + (uid ? ('&uid=' + uid) : ''), { headers })).json();
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º
        const restaurantItems = {};
        restIds.forEach(restId => {
          restaurantItems[restId] = cart.items.filter(item => {
            const dish = dishesMap.get(item.dish_id);
            return dish && dish.restaurant_id === restId;
          });
        });
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∑–∏–Ω
        const cartsList = document.getElementById('cartsList');
        cartsList.innerHTML = '';
        
        restIds.forEach(restId => {
          const restaurant = rests.find(r => r.id === restId);
          const items = restaurantItems[restId] || [];
          
          if (restaurant && items.length > 0) {
            const cartCard = document.createElement('div');
            cartCard.className = 'cart-card';
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
            const itemImages = items.slice(0, 3).map(item => {
              const dish = dishesMap.get(item.dish_id);
              return dish?.image || 'https://via.placeholder.com/60x60?text=No+Image';
            });
            
            cartCard.innerHTML = `
              <div class="cart-card-content">
                <div class="cart-card-name">${restaurant.name}</div>
                <div class="cart-card-items">
                  ${itemImages.map(img => `<img src="${img}" alt="–¢–æ–≤–∞—Ä" class="cart-item-thumb" />`).join('')}
                </div>
              </div>
              <button class="cart-card-delete" onclick="deleteRestaurantCart(${restId})">üóëÔ∏è</button>
            `;
            
            cartsList.appendChild(cartCard);
          }
        });
      } catch (error) {
        console.error('Error loading carts list:', error);
      }
    }
    
    async function deleteRestaurantCart(restaurantId) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É —ç—Ç–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞?')) {
        try {
          const response = await fetch(api + '/cart/clear?restaurant_id=' + restaurantId + (uid ? ('&uid=' + uid) : ''), { method: 'POST', headers });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —ç—Ç–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ cart
          cart.items = cart.items.filter(item => {
            const dish = dishesMap.get(item.dish_id);
            return dish && dish.restaurant_id !== restaurantId;
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
          restIdsCached = restIdsCached.filter(id => id !== restaurantId);
          
          // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ —Å—Ç–∞–ª–∞ –ø—É—Å—Ç–æ–π, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
          if (!cart.items || cart.items.length === 0) {
            redirectToRestaurant(restaurantId);
          } else {
            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
            if (activeRestaurantId === restaurantId && restIdsCached.length > 0) {
              activeRestaurantId = restIdsCached[0];
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderRestaurantTabs();
            renderCartItems();
            updateCheckoutBar();
          }
        } catch (error) {
          console.error('Error deleting restaurant cart:', error);
        }
      }
    }

    function renderRestaurantTabs() {
      const tabs = document.getElementById('restaurantTabs');
      tabs.innerHTML = '';
      
      console.log('Rendering restaurant tabs...');
      console.log('Restaurant IDs cached:', restIdsCached);
      console.log('Restaurants map:', restaurantsMap);
      
      restIdsCached.forEach(id => {
        const r = restaurantsMap.get(id);
        if (!r) {
          console.log('Restaurant not found for ID:', id);
          return;
        }
        
        console.log('Rendering tab for restaurant:', r);
        
        const total = calcTotalForRestaurant(id);
        const deliveryTime = r.delivery_time_minutes 
          ? `${r.delivery_time_minutes} –º–∏–Ω`
          : '60 –º–∏–Ω';
        
        const tab = document.createElement('button');
        tab.className = 'restaurant-tab' + (id === activeRestaurantId ? ' active' : '');
        tab.onclick = () => {
          activeRestaurantId = id;
          renderRestaurantTabs();
          renderCartItems();
          updateCheckoutBar();
        };
        
        tab.innerHTML = `
          <div class="restaurant-tab-name">${r.name}</div>
          <div class="restaurant-tab-info">
            <span class="restaurant-tab-price">${total} ‚ÇΩ</span>
            <span class="restaurant-tab-time">${deliveryTime}</span>
          </div>
        `;
        
        tabs.appendChild(tab);
      });
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º checkout-bar –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–∞–±–æ–≤
      document.getElementById('checkout-bar').style.display = 'block';
    }

    function renderCartItems() {
      const root = document.getElementById('cartItems');
      root.innerHTML = '';
      
      console.log('Rendering cart items...');
      console.log('Cart:', cart);
      console.log('Active restaurant ID:', activeRestaurantId);
      console.log('Dishes map:', dishesMap);
      
      const items = cart.items.filter(it => {
        const d = dishesMap.get(it.dish_id);
        return d && d.restaurant_id === activeRestaurantId;
      });
      
      console.log('Filtered items for active restaurant:', items);
      
      if (items.length === 0) {
        root.innerHTML = '<div class="empty-cart"><div class="empty-cart-text">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ</div></div>';
        return;
      }
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –±–ª—é–¥–∞ –ø–æ dish_id –∏ chosen_options
      const groupedItems = new Map();
      
      items.forEach(it => {
        const d = dishesMap.get(it.dish_id);
        if (!d) {
          console.log('Dish not found for item:', it);
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –¥–ª—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏: dish_id + –æ–ø—Ü–∏–∏
        const optionsKey = (it.chosen_options || []).sort().join(',');
        const groupKey = `${it.dish_id}_${optionsKey}`;
        
        if (groupedItems.has(groupKey)) {
          // –ï—Å–ª–∏ —Ç–∞–∫–æ–µ –±–ª—é–¥–æ —Å —Ç–∞–∫–∏–º–∏ –∂–µ –æ–ø—Ü–∏—è–º–∏ —É–∂–µ –µ—Å—Ç—å, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
          const existing = groupedItems.get(groupKey);
          existing.qty += it.qty;
          existing.itemIds.push(it.id); // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        } else {
          // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
          groupedItems.set(groupKey, {
            dish_id: it.dish_id,
            chosen_options: it.chosen_options || [],
            qty: it.qty,
            itemIds: [it.id],
            dish: d
          });
        }
      });
      
      console.log('Grouped items:', groupedItems);
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –±–ª—é–¥–∞
      groupedItems.forEach(group => {
        const d = group.dish;
        const chosen = group.chosen_options.map(id => optionsMap.get(id)).filter(Boolean);
        const delta = chosen.reduce((s, o) => s + (o.price_delta || 0), 0);
        const unitPrice = (d.price || 0) + delta;
        const totalPrice = unitPrice * group.qty;
        
        const optsLabel = chosen.length ? chosen.map(o => o.name).join(', ') : '';
        const weight = d.weight ? `${d.weight} –≥` : '';
        
        const el = document.createElement('div');
        el.className = 'cart-item';
        
        el.innerHTML = `
          <img src="${d.image || 'https://via.placeholder.com/80x80?text=No+Image'}" alt="${d.name}" class="cart-item-image" />
          <div class="cart-item-content">
            <div class="cart-item-header">
              <div class="cart-item-name">${d.name}</div>
              <div class="cart-item-controls">
                <button class="qty-btn" data-act="dec">‚àí</button>
                <span class="qty-display">${group.qty}</span>
                <button class="qty-btn plus" data-act="inc">+</button>
            </div>
            </div>
            <div class="cart-item-description">${optsLabel}</div>
            <div class="cart-item-price">${totalPrice} ‚ÇΩ</div>
            <div class="cart-item-weight">${weight}</div>
          </div>
        `;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
        el.querySelector('[data-act="inc"]').onclick = () => {
          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ
          updateQty(group.itemIds[0], group.qty + 1);
        };
        
        el.querySelector('[data-act="dec"]').onclick = () => {
          if (group.qty <= 1) {
            // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ 1 –∏–ª–∏ –º–µ–Ω—å—à–µ, —É–¥–∞–ª—è–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≥—Ä—É–ø–ø—ã
            group.itemIds.forEach(itemId => deleteItem(itemId));
          } else {
            // –ò–Ω–∞—á–µ —É–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ
            updateQty(group.itemIds[0], group.qty - 1);
          }
        };
        
        root.appendChild(el);
      });
      
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º checkout-bar –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤
      document.getElementById('checkout-bar').style.display = 'block';
    }

    function calcTotalForRestaurant(restaurantId) {
      return cart.items.reduce((sum, it) => {
        const d = dishesMap.get(it.dish_id);
        if (!d || d.restaurant_id !== restaurantId) return sum;
        const chosen = (it.chosen_options || []).map(id => optionsMap.get(id)).filter(Boolean);
        const delta = chosen.reduce((s, o) => s + (o.price_delta || 0), 0);
        return sum + (d.price + delta) * it.qty;
      }, 0);
    }

    function updateCheckoutBar() {
      const total = calcTotalForRestaurant(activeRestaurantId);
      const restaurant = restaurantsMap.get(activeRestaurantId);
      const minOrderAmount = restaurant?.delivery_min_sum || 0;
      
      document.getElementById('totalSum').textContent = `–ò—Ç–æ–≥–æ ${total} ‚ÇΩ`;
      
      const checkoutBtn = document.getElementById('checkoutBtn');
      
      if (total <= 0) {
        checkoutBtn.disabled = true;
        checkoutBtn.textContent = '–î–∞–ª–µ–µ';
        checkoutBtn.className = 'checkout-btn';
      } else if (minOrderAmount > 0 && total < minOrderAmount) {
        // –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π —Å—É–º–º—ã
        const remaining = minOrderAmount - total;
        checkoutBtn.disabled = true;
        checkoutBtn.textContent = `–î–æ–±–∞–≤—å—Ç–µ –µ—â–µ –Ω–∞ ${remaining} ‚ÇΩ`;
        checkoutBtn.className = 'checkout-btn min-order-warning';
      } else {
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = '–î–∞–ª–µ–µ';
        checkoutBtn.className = 'checkout-btn';
      }
      
    }

    async function updateQty(itemId, qty) {
      try {
        const response = await fetch(api + '/cart/items/' + itemId + '?qty=' + qty + (uid ? ('&uid=' + uid) : ''), { method: 'PATCH', headers });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç cart
        const item = cart.items.find(i => i.id === itemId);
        if (item) {
          item.qty = qty;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        renderRestaurantTabs();
        renderCartItems();
        updateCheckoutBar();
      } catch (error) {
        console.error('Error updating quantity:', error);
      }
    }


    function openMenu() {
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      location.href = '/static/restaurant.html?id=' + activeRestaurantId + '&' + p.toString();
    }

    function proceedToCheckout() {
      const total = calcTotalForRestaurant(activeRestaurantId);
      const restaurant = restaurantsMap.get(activeRestaurantId);
      const minOrderAmount = restaurant?.delivery_min_sum || 0;
      
      if (minOrderAmount > 0 && total < minOrderAmount) {
        alert(`–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –∑–∞–∫–∞–∑–∞: ${minOrderAmount} ‚ÇΩ. –î–æ–±–∞–≤—å—Ç–µ –µ—â–µ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ ${minOrderAmount - total} ‚ÇΩ`);
        return;
      }
      
      const p = new URLSearchParams(location.search);
      if (!p.get('ngrok-skip-browser-warning')) p.set('ngrok-skip-browser-warning', '1');
      p.set('r', String(activeRestaurantId));
      location.href = '/static/checkout.html?' + p.toString();
    }

    function goBack() {
      // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞—è, –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ø–∏—Å–∫—É —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
      if (!cart.items || cart.items.length === 0) {
        redirectToRestaurants();
        return;
      }
      
      // –ü—ã—Ç–∞–µ–º—Å—è –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
      if (window.history.length > 1) {
        // –ï—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞–∑–∞–¥
        window.history.back();
      } else if (document.referrer && document.referrer.includes('/static/')) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ –µ—Å—Ç—å referrer, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        location.href = document.referrer;
      } else {
        // –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ –∏–¥–µ–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
        const params = new URLSearchParams(location.search);
        if (!params.get('ngrok-skip-browser-warning')) params.set('ngrok-skip-browser-warning', '1');
        location.href = '/static/index.html?' + params.toString();
      }
    }

    async function deleteItem(itemId) {
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
        const itemToDelete = cart.items.find(item => item.id === itemId);
        const dishToDelete = itemToDelete ? dishesMap.get(itemToDelete.dish_id) : null;
        const restaurantIdToDelete = dishToDelete ? dishToDelete.restaurant_id : null;
        
        // –£–¥–∞–ª—è–µ–º –±–ª—é–¥–æ —á–µ—Ä–µ–∑ API
        const response = await fetch(api + '/cart/items/' + itemId + (uid ? ('?uid=' + uid) : ''), { 
          method: 'DELETE', 
          headers 
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ cart
        cart.items = cart.items.filter(item => item.id !== itemId);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ (—É–¥–∞–ª—è–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã –±–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤)
        const remainingRestIds = new Set();
        cart.items.forEach(item => {
          const dish = dishesMap.get(item.dish_id);
          if (dish) {
            remainingRestIds.add(dish.restaurant_id);
          }
        });
        restIdsCached = Array.from(remainingRestIds);
        
        // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ —Å—Ç–∞–ª–∞ –ø—É—Å—Ç–æ–π, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        if (!cart.items || cart.items.length === 0) {
          if (restaurantIdToDelete) {
            redirectToRestaurant(restaurantIdToDelete);
          } else {
            redirectToRestaurants();
          }
        } else {
          // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –≤—Å–µ —Ç–æ–≤–∞—Ä—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
          if (!restIdsCached.includes(activeRestaurantId) && restIdsCached.length > 0) {
            activeRestaurantId = restIdsCached[0];
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
          renderRestaurantTabs();
          renderCartItems();
          updateCheckoutBar();
        }
      } catch (error) {
        console.error('Error deleting item:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–ª—é–¥–∞');
      }
    }

    async function clearCart() {
      if (!activeRestaurantId) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã');
        return;
      }
      
      const restaurant = restaurantsMap.get(activeRestaurantId);
      const restaurantName = restaurant ? restaurant.name : '—ç—Ç–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞';
      
      if (confirm(`–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É ${restaurantName}?`)) {
        try {
          // –û—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ —á–µ—Ä–µ–∑ API
          const response = await fetch(api + '/cart/clear?restaurant_id=' + activeRestaurantId + (uid ? ('&uid=' + uid) : ''), { 
            method: 'POST', 
            headers 
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —ç—Ç–æ–≥–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ cart
          cart.items = cart.items.filter(item => {
            const dish = dishesMap.get(item.dish_id);
            return dish && dish.restaurant_id !== activeRestaurantId;
          });
          
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
          restIdsCached = restIdsCached.filter(id => id !== activeRestaurantId);
          
          // –ï—Å–ª–∏ –∫–æ—Ä–∑–∏–Ω–∞ —Å—Ç–∞–ª–∞ –ø—É—Å—Ç–æ–π, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
          if (!cart.items || cart.items.length === 0) {
            redirectToRestaurant(activeRestaurantId);
          } else {
            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
            if (restIdsCached.length > 0) {
              activeRestaurantId = restIdsCached[0];
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            renderRestaurantTabs();
            renderCartItems();
            updateCheckoutBar();
          }
        } catch (error) {
          console.error('Error clearing restaurant cart:', error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ—Ä–∑–∏–Ω—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞');
        }
      }
    }
    
    function switchToNextRestaurant() {
      // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–ª–∏—Å—å –≤ –∫–æ—Ä–∑–∏–Ω–µ
      const remainingRestIds = [...new Set(cart.items.map(i => {
        const dish = dishesMap.get(i.dish_id);
        return dish ? dish.restaurant_id : null;
      }))].filter(Boolean);
      
      if (remainingRestIds.length === 0) {
        redirectToRestaurants();
        return;
      }
      
      // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –≤ —Å–ø–∏—Å–∫–µ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
      const currentIndex = remainingRestIds.indexOf(activeRestaurantId);
      
      let nextRestaurantId;
      if (currentIndex === -1) {
        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
        nextRestaurantId = remainingRestIds[0];
      } else {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–∞–≤—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –Ω–∞ –ª–µ–≤—ã–π
        if (currentIndex < remainingRestIds.length - 1) {
          nextRestaurantId = remainingRestIds[currentIndex + 1];
        } else if (currentIndex > 0) {
          nextRestaurantId = remainingRestIds[currentIndex - 1];
        } else {
          // –û—Å—Ç–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–µ—Å—Ç–æ—Ä–∞–Ω
          nextRestaurantId = remainingRestIds[0];
        }
      }
      
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω
      activeRestaurantId = nextRestaurantId;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º URL
      const url = new URL(location.href);
      url.searchParams.set('r', String(activeRestaurantId));
      history.replaceState({}, '', url.toString());
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      renderRestaurantTabs();
      renderCartItems();
      updateCheckoutBar();
    }
    
    

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    load();
    
    
  </script>
  
</body>
</html>

