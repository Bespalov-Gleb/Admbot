<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ê–¥–º–∏–Ω–∫–∞</title>
  <link rel="stylesheet" href="/static/admin.css?v=26" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="container">
    <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
    
    <!-- Quick Actions Grid -->
    <div class="admin-grid">
      <div class="admin-section">
        <h3 id="quickActionsToggle" style="cursor: pointer; user-select: none;">
          <span id="quickActionsIcon">‚ñº</span> –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
        </h3>
        <div id="quickActionsContent">
          <div class="form-group">
            <label>–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω</label>
            <input id="rname" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"/>
            <button id="addR">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
          </div>
          
          <div class="form-group">
            <label>–°–æ–∑–¥–∞—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω —Å –∞–¥–º–∏–Ω–æ–º</label>
            <input id="newRestName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"/>
            <input id="newRestUsername" placeholder="@username –∏–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"/>
            <button id="createRestWithAdmin">üë• –°–æ–∑–¥–∞—Ç—å —Å –∞–¥–º–∏–Ω–æ–º</button>
            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
              üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –ï—Å–ª–∏ username –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. 
              ID –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å, –ø–æ–ø—Ä–æ—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É /start
            </div>
          </div>
          
          <div class="form-group">
            <label>–†–∞—Å—Å—ã–ª–∫–∞</label>
            <button id="openBroadcastModal" class="broadcast-btn">üì¢ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</button>
          </div>
          
        </div>
      </div>
      
      <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ–Ω—é -->
      <div class="admin-section">
        <h3>üçΩÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</h3>
        <div class="menu-admin-content">
          <p class="menu-admin-description">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –±–ª—é–¥ –¥–ª—è –≤—Å–µ—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</p>
          <button id="openMenuAdmin" class="menu-admin-btn-large">–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä –º–µ–Ω—é</button>
        </div>
      </div>
      
      <div class="admin-section">
        <h3 id="usersToggle" style="cursor: pointer; user-select: none;">
          <span id="usersIcon">‚ñ∂</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
        </h3>
        <div id="usersContent" style="display: none;">
          <div class="form-group">
            <label>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ @username</label>
            <input id="uidInput" placeholder="123456 –∏–ª–∏ @username"/>
          </div>
          <div class="form-row">
            <button id="blk">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="unblk">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div class="form-group">
            <label>–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</label>
            <div class="restaurant-selector">
              <input id="restaurantSearch" placeholder="–ü–æ–∏—Å–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞..." class="restaurant-search"/>
              <div id="restaurantDropdown" class="restaurant-dropdown" style="display: none;">
                <div id="restaurantList" class="restaurant-list"></div>
              </div>
              <div id="selectedRestaurant" class="selected-restaurant" style="display: none;">
                <span class="selected-name"></span>
                <button type="button" class="clear-selection" onclick="clearRestaurantSelection()">√ó</button>
              </div>
            </div>
            <button id="bindRA" class="bind-admin-btn" disabled>üëë –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
          </div>
          <button id="uload">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <div id="ulist"></div>
        </div>
      </div>
       
       <div class="admin-section">
         <h3 id="systemToggle" style="cursor: pointer; user-select: none;">
          <span id="systemIcon">‚ñ∂</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã
        </h3>
        <div id="systemContent" style="display: none;">
          <div class="form-group">
            <label>–ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–¥–º–∏–Ω–∫—É</label>
            <div class="form-row">
              <input id="adminCodeInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ"/>
              <button id="updateAdminCode">üîê –û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
              üí° –¢–µ–∫—É—â–µ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ: <span id="currentAdminCode">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            </div>
          </div>
        </div>
      </div>
       
       
      <div class="admin-section">
        <h3 id="collectionsToggle" style="cursor: pointer; user-select: none;">
          <span id="collectionsIcon">‚ñ∂</span> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∞–º–∏
        </h3>
        <div id="collectionsContent" style="display: none;">
          <div class="form-group">
            <button id="createCollectionBtn" class="create-collection-btn">üìö –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É</button>
            <button id="loadCollections" class="refresh-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          </div>
          <div id="collectionsList"></div>
        </div>
      </div>
    </div>

    <!-- Restaurants Section -->
    <div class="admin-section">
      <h3 id="restaurantsToggle" style="cursor: pointer; user-select: none;">
        <span id="restaurantsIcon">‚ñ∂</span> –†–µ—Å—Ç–æ—Ä–∞–Ω—ã
      </h3>
      <div id="restaurantsContent" style="display: none;">
        <div id="list"></div>
      </div>
    </div>

    <!-- Statistics Section -->
    <div class="admin-section">
      <h3 id="statsToggle" style="cursor: pointer; user-select: none;">
        <span id="statsIcon">‚ñ∂</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      </h3>
      <div id="statsContent" style="display: none;">
        <div class="form-row">
          <button id="statsRefresh">üìä –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        </div>
        <div id="statsGlobal"></div>
        
        <div class="form-group">
          <label>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É</label>
          <div class="form-row">
            <select id="statsRest"></select>
            <button id="statsLoad">üìà –ü–æ–∫–∞–∑–∞—Ç—å</button>
          </div>
        </div>
        <div id="statsByRest"></div>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="admin-section">
      <h3 id="reviewsToggle" style="cursor: pointer; user-select: none;">
        <span id="reviewsIcon">‚ñ∂</span> –û—Ç–∑—ã–≤—ã –æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö
      </h3>
      <div id="reviewsContent" style="display: none;">
        <div class="form-group">
          <label>–§–∏–ª—å—Ç—Ä –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É</label>
          <div class="form-row">
            <select id="revRest"></select>
            <button id="revLoad">üìù –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
          </div>
        </div>
        <div id="reviews"></div>
      </div>
    </div>

  </div>
  <script>
    const api = location.origin + '/api';
    const tg = window.Telegram?.WebApp;
    const q = new URLSearchParams(location.search);
    const uid = tg?.initDataUnsafe?.user?.id || Number(q.get('uid')) || 0;
    console.log('DEBUG: uid =', uid);
    console.log('DEBUG: tg?.initDataUnsafe?.user?.id =', tg?.initDataUnsafe?.user?.id);
    console.log('DEBUG: q.get("uid") =', q.get('uid'));
    const headers = uid ? { 'X-Telegram-User-Id': String(uid), 'Content-Type': 'application/json' } : { 'Content-Type': 'application/json' };
    console.log('DEBUG: headers =', headers);

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    function showMessage(text, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      
      // –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      const container = document.querySelector('.container');
      container.insertBefore(messageDiv, container.firstChild);
      
      // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 5000);
    }

    async function load() {
      const res = await fetch(api + '/admin/restaurants', { headers });
      if (!res.ok) { alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞'); return; }
      const rs = await res.json();
      const root = document.getElementById('list');
      root.innerHTML='';
      rs.forEach(r => {
        const el = document.createElement('div');
        el.className = 'restaurant';
        el.innerHTML = `
          <div class="restaurant-item">
            <div class="restaurant-info">
              <div class="title">#${r.id} ${r.name}</div>
              <div class="meta">
                <span class="status-${r.is_enabled ? 'on' : 'off'}">‚óè ${r.is_enabled ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</span>
              </div>
              <div class="meta">
                <label>–ú–∏–Ω. –∑–∞–∫–∞–∑:</label>
                <input data-field="delivery_min_sum" value="${r.delivery_min_sum}" style="width:80px"/>
                <label>–î–æ—Å—Ç–∞–≤–∫–∞:</label>
                <input data-field="delivery_fee" value="${r.delivery_fee}" style="width:80px"/>
                <label>–í—Ä–µ–º—è (–º–∏–Ω):</label>
                <input data-field="delivery_time_minutes" value="${r.delivery_time_minutes}" style="width:80px"/>
              </div>
              <div class="meta">
                <label>–ê–¥—Ä–µ—Å:</label>
                <input data-field="address" value="${r.address}" style="width:70%"/>
              </div>
              <div class="meta">
                <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                <input data-field="phone" value="${r.phone}" style="width:50%"/>
              </div>
              <div class="meta">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                <input data-field="description" value="${r.description||''}" style="width:80%"/>
              </div>
            </div>
            <div class="restaurant-actions">
              <button data-act="save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button data-act="toggle">${r.is_enabled ? 'üî¥ –í—ã–∫–ª—é—á–∏—Ç—å' : 'üü¢ –í–∫–ª—é—á–∏—Ç—å'}</button>
              <button data-act="del">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>`;
        el.querySelector('[data-act="save"]').onclick = async () => {
          const body = {};
          el.querySelectorAll('input[data-field]').forEach(inp => {
            const key = inp.getAttribute('data-field');
            let val = (inp.value || '').trim();
            if (['delivery_min_sum','delivery_fee','delivery_time_minutes'].includes(key)) {
              const n = parseInt(val, 10);
              if (!Number.isNaN(n)) val = n; else return;
            }
            body[key] = val;
          });
          const res = await fetch(api + '/admin/restaurants/' + r.id, { method:'PATCH', headers, body: JSON.stringify(body) });
          if (!res.ok) { alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); return; }
          const data = await res.json().catch(()=>({}));
          // –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ "—Å–ª–µ—Ç–∞–µ—Ç"
          if (data.restaurant) Object.assign(r, data.restaurant);
          load();
        };
        el.querySelector('[data-act="toggle"]').onclick = async () => {
          await fetch(api + '/admin/restaurants/' + r.id + '/status?enabled=' + (!r.is_enabled), { method:'PATCH', headers });
          load();
        };
        el.querySelector('[data-act="del"]').onclick = async () => {
          if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω #' + r.id + '?')) return;
          await fetch(api + '/admin/restaurants/' + r.id, { method:'DELETE', headers });
          load();
        };
        root.appendChild(el);
      });
    }

    document.getElementById('addR').onclick = async () => {
      const name = document.getElementById('rname').value.trim();
      if (!name) return;
      await fetch(api + '/admin/restaurants', { method:'POST', headers, body: JSON.stringify({ name }) });
      document.getElementById('rname').value='';
      load();
    };
    
    document.getElementById('createRestWithAdmin').onclick = async () => {
      const name = document.getElementById('newRestName').value.trim();
      const username = document.getElementById('newRestUsername').value.trim();
      if (!name || !username) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –∏ username –∞–¥–º–∏–Ω–∞', 'error');
        return;
      }
      
      const button = document.getElementById('createRestWithAdmin');
      const originalText = button.textContent;
      button.textContent = '‚è≥ –°–æ–∑–¥–∞–Ω–∏–µ...';
      button.disabled = true;
      
      try {
        // –°–æ–∑–¥–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω
        const restRes = await fetch(api + '/admin/restaurants', { 
          method:'POST', 
          headers, 
          body: JSON.stringify({ name }) 
        });
        if (!restRes.ok) {
          showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞', 'error');
          return;
        }
        const restaurant = await restRes.json();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–µ–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —á–∏—Å–ª–æ–º (ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        let userData;
        if (/^\d+$/.test(username)) {
          // –≠—Ç–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
          userData = { user_id: parseInt(username) };
        } else {
          // –≠—Ç–æ username, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å ID
          const userRes = await fetch(api + '/admin/users/resolve-username?username=' + encodeURIComponent(username), { 
            method:'GET', 
            headers 
          });
          if (!userRes.ok) {
            showMessage('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞–ª —Å –±–æ—Ç–æ–º', 'error');
            return;
          }
          userData = await userRes.json();
        }
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
        const bindRes = await fetch(api + '/admin/users/bind-admin?user_id=' + userData.user_id + '&restaurant_id=' + restaurant.id, { 
          method:'POST', 
          headers 
        });
        if (!bindRes.ok) {
          showMessage('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞', 'error');
          return;
        }
        
        showMessage(`‚úÖ –†–µ—Å—Ç–æ—Ä–∞–Ω "${name}" —Å–æ–∑–¥–∞–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} –Ω–∞–∑–Ω–∞—á–µ–Ω –µ–≥–æ –∞–¥–º–∏–Ω–æ–º`, 'success');
        document.getElementById('newRestName').value = '';
        document.getElementById('newRestUsername').value = '';
        load();
        loadUsers();
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞: ' + error.message, 'error');
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    };

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
    document.getElementById('openMenuAdmin').onclick = () => {
      const uid = tg?.initDataUnsafe?.user?.id || Number(q.get('uid')) || 0;
      const url = `/static/admin-menu.html?uid=${uid}`;
      window.open(url, '_blank');
    };

    async function loadUsers() {
      const res = await fetch(api + '/admin/users?t=' + Date.now(), { headers });
      if (!res.ok) return;
      const us = await res.json();
      const root = document.getElementById('ulist');
      root.innerHTML = '';
      us.forEach(u => {
        const el = document.createElement('div');
        el.className = 'restaurant';
        el.innerHTML = `
          <div class="restaurant-item">
            <div class="restaurant-info">
              <div class="title">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${u.id}${u.username ? `<span class="username">@${u.username}</span>` : ''}</div>
              <div class="meta">
                <span class="status-${u.is_blocked ? 'off' : 'on'}">‚óè ${u.is_blocked ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ê–∫—Ç–∏–≤–µ–Ω'}</span>
                ${u.restaurant_admin_of ? `üëë –ê–¥–º–∏–Ω —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ #${u.restaurant_admin_of}` : ''}
              </div>
              ${u.username ? `<div class="meta"><span class="username-info">@${u.username}</span></div>` : ''}
              ${u.name ? `<div class="meta">–ò–º—è: ${u.name}</div>` : ''}
              ${u.phone ? `<div class="meta">–¢–µ–ª–µ—Ñ–æ–Ω: ${u.phone}</div>` : ''}
            </div>
          </div>`;
        root.appendChild(el);
      });
    }

    async function resolveUserId(input) {
      const value = input.trim();
      if (/^\d+$/.test(value)) {
        return parseInt(value);
      } else if (value.startsWith('@')) {
        const res = await fetch(api + '/admin/users/resolve-username?username=' + encodeURIComponent(value), { headers });
        if (!res.ok) {
          throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username –Ω–µ –Ω–∞–π–¥–µ–Ω');
        }
        const data = await res.json();
        return data.user_id;
      } else {
        throw new Error('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ @username');
      }
    }

    document.getElementById('blk').onclick = async () => {
      try {
        const input = (document.getElementById('uidInput').value||'').trim();
        if (!input) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username');
        const id = await resolveUserId(input);
        await fetch(api + '/admin/users/block?user_id=' + id + '&block=true', { method:'POST', headers });
        loadUsers();
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        alert(error.message);
      }
    };
    document.getElementById('unblk').onclick = async () => {
      try {
        const input = (document.getElementById('uidInput').value||'').trim();
        if (!input) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username');
        const id = await resolveUserId(input);
        await fetch(api + '/admin/users/block?user_id=' + id + '&block=false', { method:'POST', headers });
        loadUsers();
        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        alert(error.message);
      }
    };
    document.getElementById('uload').onclick = loadUsers;
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞–º–∏
    let allRestaurants = [];
    let selectedRestaurantId = null;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
    async function loadRestaurants() {
      try {
        const res = await fetch(api + '/admin/restaurants', { headers });
        if (res.ok) {
          allRestaurants = await res.json();
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤:', error);
      }
    }

    // –ü–æ–∏—Å–∫ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
    function searchRestaurants(query) {
      if (!query.trim()) {
        return allRestaurants;
      }
      return allRestaurants.filter(restaurant => 
        restaurant.name.toLowerCase().includes(query.toLowerCase())
      );
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
    function showRestaurantDropdown(restaurants) {
      const dropdown = document.getElementById('restaurantDropdown');
      const list = document.getElementById('restaurantList');
      
      if (restaurants.length === 0) {
        list.innerHTML = '<div class="restaurant-item" style="color: #64748b; cursor: default;">–†–µ—Å—Ç–æ—Ä–∞–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
      } else {
        list.innerHTML = restaurants.map(restaurant => `
          <div class="restaurant-item" onclick="selectRestaurant(${restaurant.id}, '${restaurant.name}')">
            <div class="restaurant-name">${restaurant.name}</div>
            <div class="restaurant-id">ID: ${restaurant.id}</div>
          </div>
        `).join('');
      }
      
      dropdown.style.display = 'block';
    }

    // –í—ã–±–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    function selectRestaurant(id, name) {
      selectedRestaurantId = id;
      document.getElementById('restaurantSearch').value = '';
      document.getElementById('restaurantDropdown').style.display = 'none';
      document.getElementById('selectedRestaurant').style.display = 'flex';
      document.querySelector('.selected-name').textContent = name;
      document.getElementById('bindRA').disabled = false;
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
    function clearRestaurantSelection() {
      selectedRestaurantId = null;
      document.getElementById('selectedRestaurant').style.display = 'none';
      document.getElementById('bindRA').disabled = true;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('restaurantSearch').addEventListener('input', (e) => {
      const query = e.target.value;
      const restaurants = searchRestaurants(query);
      showRestaurantDropdown(restaurants);
    });

    document.getElementById('restaurantSearch').addEventListener('focus', () => {
      if (allRestaurants.length > 0) {
        showRestaurantDropdown(allRestaurants);
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', (e) => {
      const selector = document.querySelector('.restaurant-selector');
      if (!selector.contains(e.target)) {
        document.getElementById('restaurantDropdown').style.display = 'none';
      }
    });

    document.getElementById('bindRA').onclick = async () => {
      try {
        const input = (document.getElementById('uidInput').value||'').trim();
        if (!input) return alert('–í–≤–µ–¥–∏—Ç–µ ID –∏–ª–∏ @username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        if (!selectedRestaurantId) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω');
        
        const id = await resolveUserId(input);
        await fetch(api + '/admin/users/bind-admin?user_id=' + id + '&restaurant_id=' + selectedRestaurantId, { method:'POST', headers });
        
        const restaurantName = document.querySelector('.selected-name').textContent;
        alert(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–æ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ "${restaurantName}"`);
        loadUsers();
        clearRestaurantSelection();
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      }
    };

    load();
    loadUsers();
    loadRestaurants();

    async function loadStatsGlobal() {
      const res = await fetch(api + '/admin/stats?t=' + Date.now(), { headers });
      if (!res.ok) return;
      const s = await res.json();
      const el = document.getElementById('statsGlobal');
      el.innerHTML = `
        <div class="stats-card">
          <div class="title">üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
          <div class="meta">–°–µ–≥–æ–¥–Ω—è: ${s.today.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.today.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.today.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.today.modified}</div>
          <div class="meta">–ú–µ—Å—è—Ü: ${s.month.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.month.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.month.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.month.modified}</div>
        </div>`;
    }

    async function populateRestaurantsSelect() {
      const res = await fetch(api + '/admin/restaurants?t=' + Date.now(), { headers });
      if (!res.ok) return;
      const rs = await res.json();
      const sel1 = document.getElementById('statsRest');
      const sel2 = document.getElementById('revRest');
      sel1.innerHTML = '';
      sel2.innerHTML = '<option value="">–í—Å–µ</option>';
      rs.forEach(r => {
        const o1 = document.createElement('option'); o1.value = r.id; o1.textContent = `#${r.id} ${r.name}`; sel1.appendChild(o1);
        const o2 = document.createElement('option'); o2.value = r.id; o2.textContent = `#${r.id} ${r.name}`; sel2.appendChild(o2);
      });
    }

    async function loadStatsByRestaurant() {
      const rid = Number(document.getElementById('statsRest').value);
      if (!rid) { document.getElementById('statsByRest').textContent = ''; return; }
      const res = await fetch(api + '/admin/stats/by-restaurant?restaurant_id=' + rid + '&t=' + Date.now(), { headers });
      if (!res.ok) return;
      const s = await res.json();
      document.getElementById('statsByRest').innerHTML = `
        <div class="stats-card">
          <div class="title">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ #${rid}</div>
          <div class="meta">–°–µ–≥–æ–¥–Ω—è: ${s.today.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.today.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.today.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.today.modified}</div>
          <div class="meta">–ú–µ—Å—è—Ü: ${s.month.orders} –∑–∞–∫–∞–∑–æ–≤ –Ω–∞ —Å—É–º–º—É ${s.month.sum} ‚ÇΩ</div>
          <div class="meta">–û—Ç–º–µ–Ω–µ–Ω–æ: ${s.month.cancelled} | –ò–∑–º–µ–Ω–µ–Ω–æ: ${s.month.modified}</div>
        </div>`;
    }

    async function loadReviews() {
      const rid = document.getElementById('revRest').value;
      const url = rid ? (api + '/admin/reviews?restaurant_id=' + rid + '&t=' + Date.now()) : (api + '/admin/reviews?t=' + Date.now());
      const res = await fetch(url, { headers });
      if (!res.ok) return;
      const data = await res.json();
      // fetch restaurants to map id -> name
      const rs = await (await fetch(api + '/admin/restaurants?t=' + Date.now(), { headers })).json();
      const idToName = new Map(rs.map(r => [r.id, r.name]));
      const root = document.getElementById('reviews');
      root.innerHTML = '';
      if (!data.length) { root.innerHTML = '<div class="meta">–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤</div>'; return; }
      data.forEach(r => {
        const el = document.createElement('div');
        el.className = 'review-item';
        const rname = idToName.get(r.restaurant_id) || ('–†–µ—Å—Ç–æ—Ä–∞–Ω ' + r.restaurant_id);
        el.innerHTML = `
          <div class="title">‚≠ê ${r.rating}/5 ¬∑ ${rname}</div>
          <div class="meta">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${r.user_id} ¬∑ üì¶ –ó–∞–∫–∞–∑ #${r.order_id}</div>
          <div class="meta">üí¨ ${(r.comment||'').replace(/</g,'&lt;')}</div>
          <button data-id="${r.id}" style="margin-top: 8px;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>`;
        el.querySelector('button').onclick = async () => {
          await fetch(api + '/admin/reviews/' + r.id, { method:'DELETE', headers });
          loadReviews();
        };
        root.appendChild(el);
      });
    }

    // Admin Code Management
    async function loadAdminCode() {
      try {
        const res = await fetch(api + '/admin/admin-code', { headers });
        if (res.ok) {
          const data = await res.json();
          const currentCodeEl = document.getElementById('currentAdminCode');
          currentCodeEl.textContent = data.admin_code || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        }
      } catch (error) {
        console.error('Error loading admin code:', error);
      }
    }

    document.getElementById('updateAdminCode').onclick = async () => {
      const newCode = document.getElementById('adminCodeInput').value.trim();
      if (!newCode) {
        showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ', 'error');
        return;
      }
      
      const button = document.getElementById('updateAdminCode');
      const originalText = button.textContent;
      button.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
      button.disabled = true;
      
      try {
        const res = await fetch(api + '/admin/admin-code', { 
          method: 'POST', 
          headers, 
          body: JSON.stringify({ admin_code: newCode }) 
        });
        
        if (res.ok) {
          showMessage('‚úÖ –ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
          document.getElementById('adminCodeInput').value = '';
          loadAdminCode();
        } else {
          const error = await res.json();
          showMessage('‚ùå –û—à–∏–±–∫–∞: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
        }
      } catch (error) {
        showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
      } finally {
        button.textContent = originalText;
        button.disabled = false;
      }
    };

    document.getElementById('statsLoad').onclick = loadStatsByRestaurant;
    document.getElementById('statsRefresh').onclick = loadStatsGlobal;
    document.getElementById('revLoad').onclick = loadReviews;

    // Collections Management
    async function loadCollections() {
      try {
        const res = await fetch(api + '/collections', { headers });
        if (!res.ok) return;
        const collections = await res.json();
        
        const root = document.getElementById('collectionsList');
        root.innerHTML = '';
        
        if (!collections.length) {
          root.innerHTML = '<div class="meta">–ù–µ—Ç –ø–æ–¥–±–æ—Ä–æ–∫</div>';
          return;
        }
        
        collections.forEach(collection => {
          const el = document.createElement('div');
          el.className = 'collection-item';
          const typeIcon = collection.kind === 'restaurants' ? 'üçΩÔ∏è' : 'üçï';
          const typeName = collection.kind === 'restaurants' ? '–†–µ—Å—Ç–æ—Ä–∞–Ω—ã' : '–ë–ª—é–¥–∞';
          
          el.innerHTML = `
            <div class="title">${typeIcon} ${collection.name}</div>
            <div class="meta">–¢–∏–ø: ${typeName} | –≠–ª–µ–º–µ–Ω—Ç–æ–≤: ${collection.items_count} | –°—Ç–∞—Ç—É—Å: ${collection.is_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω–∞' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω–∞'}</div>
            <div class="form-row" style="margin-top: 8px;">
              <button data-id="${collection.id}" data-act="toggle">${collection.is_enabled ? '‚ùå –í—ã–∫–ª—é—á–∏—Ç—å' : '‚úÖ –í–∫–ª—é—á–∏—Ç—å'}</button>
              <button data-id="${collection.id}" data-act="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
              <button data-id="${collection.id}" data-act="items">üìã –≠–ª–µ–º–µ–Ω—Ç—ã</button>
              <button data-id="${collection.id}" data-act="del">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `;
          
          el.querySelector('[data-act="toggle"]').onclick = async () => {
            await fetch(api + '/collections/' + collection.id, { 
              method: 'PATCH', 
              headers, 
              body: JSON.stringify({ is_enabled: !collection.is_enabled }) 
            });
            loadCollections();
          };
          
          el.querySelector('[data-act="edit"]').onclick = () => {
            showEditCollectionModal(collection);
          };
          
          el.querySelector('[data-act="items"]').onclick = () => {
            showCollectionItemsModal(collection.id, collection.name);
          };
          
          el.querySelector('[data-act="del"]').onclick = async () => {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–¥–±–æ—Ä–∫—É "${collection.name}"?`)) return;
            await fetch(api + '/collections/' + collection.id, { method: 'DELETE', headers });
            loadCollections();
          };
          
          root.appendChild(el);
        });
      } catch (error) {
        console.error('Error loading collections:', error);
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–¥–±–æ—Ä–æ–∫', 'error');
      }
    }

         function showEditCollectionModal(collection) {
       const modal = document.createElement('div');
       modal.className = 'modal';
       modal.innerHTML = `
         <div class="modal-content">
           <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É</h3>
           <div class="form-group">
             <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
             <input id="editName" value="${collection.name}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏"/>
           </div>
           <div class="form-group">
             <label>–¢–∏–ø –ø–æ–¥–±–æ—Ä–∫–∏:</label>
             <div class="collection-type-selector">
               <div class="type-option">
                 <input type="radio" id="editTypeRestaurants" name="editCollectionType" value="restaurants" ${collection.kind === 'restaurants' ? 'checked' : ''}>
                 <label for="editTypeRestaurants">üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω—ã</label>
               </div>
               <div class="type-option">
                 <input type="radio" id="editTypeDishes" name="editCollectionType" value="dishes" ${collection.kind === 'dishes' ? 'checked' : ''}>
                 <label for="editTypeDishes">üçï –ë–ª—é–¥–∞</label>
               </div>
             </div>
           </div>
           <div class="form-group">
             <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
             <div class="file-upload">
               <input type="file" id="editImageFile" accept="image/*" />
               <div class="file-upload-label">
                 –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
               </div>
             </div>
             <input id="editImage" value="${collection.image}" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤—ã—à–µ"/>
             <div id="editImagePreview" style="margin-top: 8px;">
               ${collection.image ? `<img src="${collection.image}" class="image-preview" />` : ''}
             </div>
           </div>
           <div class="form-group">
             <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
             <input id="editSortOrder" type="number" value="${collection.sort_order}" placeholder="0"/>
           </div>
           <div class="form-row">
             <button id="saveEdit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             <button id="cancelEdit">‚ùå –û—Ç–º–µ–Ω–∞</button>
           </div>
         </div>
       `;
      
             document.body.appendChild(modal);
       
       // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏
       document.getElementById('editImageFile').addEventListener('change', async function() {
         const file = this.files[0];
         if (!file) return;
         
         if (!file.type.startsWith('image/')) {
           showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           return;
         }
         
         const formData = new FormData();
         formData.append('image', file);
         
         try {
           const response = await fetch(api + '/collections/upload-image', {
             method: 'POST',
             headers: { 'X-Telegram-User-Id': uid },
             body: formData
           });
           
           if (response.ok) {
             const result = await response.json();
             document.getElementById('editImage').value = result.image_url;
             
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
             const preview = document.getElementById('editImagePreview');
             preview.innerHTML = `<img src="${result.image_url}" class="image-preview" />`;
             
             showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
           } else {
             showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           }
         } catch (error) {
           console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
           showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
         }
       });
       
       document.getElementById('saveEdit').onclick = async () => {
        const name = document.getElementById('editName').value.trim();
        const kind = document.querySelector('input[name="editCollectionType"]:checked').value;
        const image = document.getElementById('editImage').value.trim();
        const sort_order = parseInt(document.getElementById('editSortOrder').value) || 0;
        
        if (!name) {
          showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
          return;
        }
        
        try {
          await fetch(api + '/collections/' + collection.id, {
            method: 'PATCH',
            headers,
            body: JSON.stringify({ name, kind, image, sort_order })
          });
          document.body.removeChild(modal);
          loadCollections();
          showMessage('–ü–æ–¥–±–æ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
        } catch (error) {
          showMessage('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
        }
      };
      
      document.getElementById('cancelEdit').onclick = () => {
        document.body.removeChild(modal);
      };
    }

    function showCollectionItemsModal(collectionId, collectionName) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <h3>–≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–¥–±–æ—Ä–∫–∏: ${collectionName}</h3>
          <div class="form-group">
            <label>–î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</label>
            <select id="itemType">
              <option value="restaurant">–†–µ—Å—Ç–æ—Ä–∞–Ω</option>
              <option value="dish">–ë–ª—é–¥–æ</option>
            </select>
            <select id="restaurantSelect" style="display: none;">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>
            </select>
            <div id="dishSelectContainer" style="display: none;">
              <label>–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–æ</label>
              <select id="dishSelect">
                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>
              </select>
            </div>
            <input id="itemTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"/>
            <input id="itemSubtitle" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫"/>
            <div class="form-group">
              <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
              <div class="file-upload">
                <input type="file" id="itemImageFile" accept="image/*" />
                <div class="file-upload-label">
                  –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                </div>
              </div>
              <input id="itemImage" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤—ã—à–µ"/>
              <div id="imagePreview" style="margin-top: 8px;"></div>
            </div>
            <div class="form-row">
              <button id="addItem">‚ûï –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç</button>
              <button id="loadItems">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
          </div>
          <div id="itemsList"></div>
          <div class="form-row">
            <button id="closeItems">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
      document.getElementById('itemType').addEventListener('change', onItemTypeChange);
      
      // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–ø–∞–¥–∞—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏
      async function loadRestaurants() {
        try {
          const res = await fetch(api + '/collections/restaurants', { headers });
          if (!res.ok) return;
          const restaurants = await res.json();
          
          const select = document.getElementById('restaurantSelect');
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>';
          
          restaurants.forEach(restaurant => {
            const option = document.createElement('option');
            option.value = restaurant.id;
            option.textContent = restaurant.name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error loading restaurants:', error);
        }
      }
      
      async function loadDishes(restaurantId) {
        try {
          console.log('loadDishes called with restaurantId:', restaurantId);
          const url = restaurantId 
            ? api + '/collections/dishes?restaurant_id=' + restaurantId
            : api + '/collections/dishes';
          
          console.log('Fetching dishes from:', url);
          const res = await fetch(url, { headers });
          if (!res.ok) {
            console.error('Failed to load dishes, status:', res.status);
            return;
          }
          const dishes = await res.json();
          console.log('Loaded dishes:', dishes);
          
          const select = document.getElementById('dishSelect');
          console.log('dishSelect element:', select);
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–æ</option>';
          
          dishes.forEach(dish => {
            const option = document.createElement('option');
            option.value = dish.id;
            option.textContent = `${dish.name} (${dish.restaurant_name}) - ${dish.price} ‚ÇΩ`;
            select.appendChild(option);
          });
          console.log('Dishes loaded into select');
        } catch (error) {
          console.error('Error loading dishes:', error);
        }
      }
      
      function onItemTypeChange() {
        const itemType = document.getElementById('itemType').value;
        const restaurantSelect = document.getElementById('restaurantSelect');
        const dishSelectContainer = document.getElementById('dishSelectContainer');
        const dishSelect = document.getElementById('dishSelect');
        
        console.log('onItemTypeChange called with type:', itemType);
        console.log('restaurantSelect:', restaurantSelect);
        console.log('dishSelectContainer:', dishSelectContainer);
        console.log('dishSelect:', dishSelect);
        
        if (!dishSelect) {
          console.error('dishSelect element not found!');
          return;
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–µ–ª–µ–∫—Ç—ã
        restaurantSelect.style.display = 'none';
        dishSelectContainer.style.display = 'none';
        
        if (itemType === 'restaurant') {
          restaurantSelect.style.display = 'block';
          loadRestaurants();
          // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
          restaurantSelect.onchange = null;
        } else if (itemType === 'dish') {
          restaurantSelect.style.display = 'block';
          dishSelectContainer.style.display = 'block';
          console.log('Setting dishSelectContainer display to block');
          loadRestaurants();
          // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –±–ª—é–¥
          dishSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>';
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –¥–ª—è –±–ª—é–¥
          restaurantSelect.onchange = function() {
            console.log('Restaurant changed to:', this.value);
            const dishSelect = document.getElementById('dishSelect');
            if (this.value) {
              loadDishes(this.value);
            } else {
              dishSelect.innerHTML = '<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>';
            }
          };
        }
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
      document.getElementById('itemImageFile').addEventListener('change', async function() {
        const file = this.files[0];
        if (!file) return;
        
        if (!file.type.startsWith('image/')) {
          showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
          return;
        }
        
        const formData = new FormData();
        formData.append('image', file);
        
        try {
          const response = await fetch(api + '/collections/upload-image', {
            method: 'POST',
            headers: { 'X-Telegram-User-Id': uid },
            body: formData
          });
          
          if (response.ok) {
            const result = await response.json();
            document.getElementById('itemImage').value = result.image_url;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `<img src="${result.image_url}" class="image-preview" />`;
            
            showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
          } else {
            showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
          showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
        }
      });
      
      async function loadItems() {
        try {
          const res = await fetch(api + '/collections/' + collectionId + '/items', { headers });
          if (!res.ok) return;
          const items = await res.json();
          
          const root = document.getElementById('itemsList');
          root.innerHTML = '';
          
          if (!items.length) {
            root.innerHTML = '<div class="meta">–ù–µ—Ç —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>';
            return;
          }
          
          items.forEach(item => {
            const el = document.createElement('div');
            el.className = 'item-element';
            el.innerHTML = `
              <div class="title">${item.title}</div>
              <div class="meta">${item.subtitle || '–ë–µ–∑ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞'} | –¢–∏–ø: ${item.item_type} | ID: ${item.item_id}</div>
              <div class="meta">–°—Ç–∞—Ç—É—Å: ${item.is_enabled ? '‚úÖ –í–∫–ª—é—á–µ–Ω' : '‚ùå –í—ã–∫–ª—é—á–µ–Ω'} | –ü–æ—Ä—è–¥–æ–∫: ${item.sort_order}</div>
              <div class="form-row" style="margin-top: 8px;">
                <button data-id="${item.id}" data-act="toggle">${item.is_enabled ? '‚ùå –í—ã–∫–ª—é—á–∏—Ç—å' : '‚úÖ –í–∫–ª—é—á–∏—Ç—å'}</button>
                <button data-id="${item.id}" data-act="edit">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                <button data-id="${item.id}" data-act="del">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              </div>
            `;
            
            el.querySelector('[data-act="toggle"]').onclick = async () => {
              await fetch(api + '/collections/' + collectionId + '/items/' + item.id, {
                method: 'PATCH',
                headers,
                body: JSON.stringify({ is_enabled: !item.is_enabled })
              });
              loadItems();
            };
            
            el.querySelector('[data-act="edit"]').onclick = () => {
              showEditItemModal(collectionId, item, loadItems);
            };
            
            el.querySelector('[data-act="del"]').onclick = async () => {
              if (!confirm(`–£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç "${item.title}"?`)) return;
              await fetch(api + '/collections/' + collectionId + '/items/' + item.id, { method: 'DELETE', headers });
              loadItems();
            };
            
            root.appendChild(el);
          });
        } catch (error) {
          console.error('Error loading items:', error);
          showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤', 'error');
        }
      }
      
      document.getElementById('addItem').onclick = async () => {
        const item_type = document.getElementById('itemType').value;
        let item_id = 0;
        
        if (item_type === 'restaurant') {
          item_id = parseInt(document.getElementById('restaurantSelect').value);
        } else if (item_type === 'dish') {
          item_id = parseInt(document.getElementById('dishSelect').value);
        }
        
        const title = document.getElementById('itemTitle').value.trim();
        const subtitle = document.getElementById('itemSubtitle').value.trim();
        const image = document.getElementById('itemImage').value.trim();
        
        if (!item_id || !title) {
          showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∏ –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫', 'error');
          return;
        }
        
        try {
          await fetch(api + '/collections/' + collectionId + '/items', {
            method: 'POST',
            headers,
            body: JSON.stringify({ collection_id: collectionId, item_type, item_id, title, subtitle, image })
          });
          
          // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
          document.getElementById('restaurantSelect').value = '';
          document.getElementById('dishSelect').value = '';
          document.getElementById('itemTitle').value = '';
          document.getElementById('itemSubtitle').value = '';
          document.getElementById('itemImage').value = '';
          
          loadItems();
          showMessage('–≠–ª–µ–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        } catch (error) {
          showMessage('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞', 'error');
        }
      };
      
      document.getElementById('loadItems').onclick = loadItems;
      document.getElementById('closeItems').onclick = () => {
        document.body.removeChild(modal);
      };
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      onItemTypeChange();
      loadItems();
    }

         function showEditItemModal(collectionId, item, reloadCallback) {
       const modal = document.createElement('div');
       modal.className = 'modal';
       modal.innerHTML = `
         <div class="modal-content">
           <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç</h3>
           <div class="form-group">
             <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
             <input id="editItemTitle" value="${item.title}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫"/>
           </div>
           <div class="form-group">
             <label>–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫</label>
             <input id="editItemSubtitle" value="${item.subtitle}" placeholder="–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫"/>
           </div>
           <div class="form-group">
             <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
             <div class="file-upload">
               <input type="file" id="editItemImageFile" accept="image/*" />
               <div class="file-upload-label">
                 –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
               </div>
             </div>
             <input id="editItemImage" value="${item.image}" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤—ã—à–µ"/>
             <div id="editItemImagePreview" style="margin-top: 8px;">
               ${item.image ? `<img src="${item.image}" class="image-preview" />` : ''}
             </div>
           </div>
           <div class="form-group">
             <label>–ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</label>
             <input id="editItemSortOrder" type="number" value="${item.sort_order}" placeholder="0"/>
           </div>
           <div class="form-row">
             <button id="saveItemEdit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
             <button id="cancelItemEdit">‚ùå –û—Ç–º–µ–Ω–∞</button>
           </div>
         </div>
       `;
      
             document.body.appendChild(modal);
       
       // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
       document.getElementById('editItemImageFile').addEventListener('change', async function() {
         const file = this.files[0];
         if (!file) return;
         
         if (!file.type.startsWith('image/')) {
           showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           return;
         }
         
         const formData = new FormData();
         formData.append('image', file);
         
         try {
           const response = await fetch(api + '/collections/upload-image', {
             method: 'POST',
             headers: { 'X-Telegram-User-Id': uid },
             body: formData
           });
           
           if (response.ok) {
             const result = await response.json();
             document.getElementById('editItemImage').value = result.image_url;
             
             // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
             const preview = document.getElementById('editItemImagePreview');
             preview.innerHTML = `<img src="${result.image_url}" class="image-preview" />`;
             
             showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
           } else {
             showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
           }
         } catch (error) {
           console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
           showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
         }
       });
       
       document.getElementById('saveItemEdit').onclick = async () => {
        const title = document.getElementById('editItemTitle').value.trim();
        const subtitle = document.getElementById('editItemSubtitle').value.trim();
        const image = document.getElementById('editItemImage').value.trim();
        const sort_order = parseInt(document.getElementById('editItemSortOrder').value) || 0;
        
        if (!title) {
          showMessage('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫', 'error');
          return;
        }
        
        try {
          await fetch(api + '/collections/' + collectionId + '/items/' + item.id, {
            method: 'PATCH',
            headers,
            body: JSON.stringify({ title, subtitle, image, sort_order })
          });
          document.body.removeChild(modal);
          reloadCallback();
          showMessage('–≠–ª–µ–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        } catch (error) {
          showMessage('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞', 'error');
        }
      };
      
      document.getElementById('cancelItemEdit').onclick = () => {
        document.body.removeChild(modal);
      };
    }




    // Event listeners for collections
    document.getElementById('createCollectionBtn').onclick = () => {
      showCreateCollectionModal();
    };
    
    document.getElementById('loadCollections').onclick = loadCollections;

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏
    function showCreateCollectionModal() {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <h3>‚ú® –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É</h3>
          
          <div class="form-group">
            <label>üìù –ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏</label>
            <input id="newCollectionName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏" style="padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; width: 100%; transition: all 0.2s ease;" />
          </div>
          
          <div class="form-group">
            <label>üéØ –¢–∏–ø –ø–æ–¥–±–æ—Ä–∫–∏:</label>
            <div class="collection-type-selector">
              <div class="type-option">
                <input type="radio" id="newTypeRestaurants" name="newCollectionType" value="restaurants" checked>
                <label for="newTypeRestaurants">üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω—ã</label>
              </div>
              <div class="type-option">
                <input type="radio" id="newTypeDishes" name="newCollectionType" value="dishes">
                <label for="newTypeDishes">üçï –ë–ª—é–¥–∞</label>
              </div>
            </div>
          </div>
          
          <div id="restaurantSelector" class="restaurant-selector" style="display: none;">
            <label>üè™ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω:</label>
            <select id="collectionRestaurantSelect">
              <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤...</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>üìã –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã:</label>
            <div id="itemsSelector" class="items-container">
              <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
          </div>
          
          <div class="form-row" style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
            <button id="saveNewCollection" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);">
              ‚ú® –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–±–æ—Ä–∫—É
            </button>
            <button id="cancelNewCollection" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);">
              ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
      setTimeout(() => {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞
        loadItemsForCollection();
      }, 100);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞
      document.querySelectorAll('input[name="newCollectionType"]').forEach(radio => {
        radio.addEventListener('change', handleTypeChange);
      });
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞
      document.getElementById('collectionRestaurantSelect').addEventListener('change', loadItemsForCollection);
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      document.getElementById('saveNewCollection').onclick = async () => {
        const name = document.getElementById('newCollectionName').value.trim();
        const type = document.querySelector('input[name="newCollectionType"]:checked').value;
        const selectedItems = getSelectedItems();
        
        if (!name) {
          showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
          return;
        }
        
        if (selectedItems.length === 0) {
          showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç', 'error');
          return;
        }
        
        try {
          // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–±–æ—Ä–∫—É
          const collectionResponse = await fetch(api + '/collections', {
            method: 'POST',
            headers,
            body: JSON.stringify({ 
              name, 
              kind: type
            })
          });
          
          if (!collectionResponse.ok) {
            throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏');
          }
          
          const collectionResult = await collectionResponse.json();
          const collectionId = collectionResult.id;
          
          // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –ø–æ–¥–±–æ—Ä–∫—É
          for (const item of selectedItems) {
            await fetch(api + '/collections/' + collectionId + '/items', {
              method: 'POST',
              headers,
              body: JSON.stringify({
                collection_id: collectionId,
                item_type: type === 'restaurants' ? 'restaurant' : 'dish',
                item_id: item.id,
                title: item.name,
                subtitle: item.subtitle || '',
                image: item.image || '',
                link_url: item.link_url || ''
              })
            });
          }
          
          document.body.removeChild(modal);
          loadCollections();
          showMessage('–ü–æ–¥–±–æ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', 'success');
        } catch (error) {
          showMessage('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–±–æ—Ä–∫–∏', 'error');
        }
      };
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–º–µ–Ω—ã
      document.getElementById('cancelNewCollection').onclick = () => {
        document.body.removeChild(modal);
      };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ –ø–æ–¥–±–æ—Ä–∫–∏
    async function handleTypeChange() {
      const type = document.querySelector('input[name="newCollectionType"]:checked').value;
      const restaurantSelector = document.getElementById('restaurantSelector');
      const itemsContainer = document.getElementById('itemsSelector');
      
      if (type === 'dishes') {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –¥–ª—è –±–ª—é–¥
        restaurantSelector.style.display = 'block';
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è DOM
        setTimeout(async () => {
          await loadRestaurantsForSelector();
        }, 100);
        itemsContainer.innerHTML = '<div class="loading">‚è≥ –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥...</div>';
      } else {
        // –°–∫—Ä—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞ –¥–ª—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤
        restaurantSelector.style.display = 'none';
        loadItemsForCollection();
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤ –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞
    async function loadRestaurantsForSelector() {
      const select = document.getElementById('collectionRestaurantSelect');
      select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤...</option>';
      
      try {
        console.log('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã —Å URL:', api + '/collections/restaurants');
        console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏:', headers);
        
        const response = await fetch(api + '/collections/restaurants', { headers });
        console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
        
        if (response.ok) {
          const restaurants = await response.json();
          console.log('–ü–æ–ª—É—á–µ–Ω—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã:', restaurants);
          console.log('–≠–ª–µ–º–µ–Ω—Ç select:', select);
          
          if (select) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω</option>';
            console.log('–û—á–∏—Å—Ç–∏–ª–∏ select, –¥–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã...');
            
            restaurants.forEach((restaurant, index) => {
              const option = document.createElement('option');
              option.value = restaurant.id;
              option.textContent = restaurant.name;
              select.appendChild(option);
              console.log(`–î–æ–±–∞–≤–ª–µ–Ω —Ä–µ—Å—Ç–æ—Ä–∞–Ω ${index + 1}:`, restaurant.name);
            });
            
            console.log('–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ select:', select.innerHTML);
            
            if (restaurants.length === 0) {
              select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</option>';
            }
          } else {
            console.error('–≠–ª–µ–º–µ–Ω—Ç select –Ω–µ –Ω–∞–π–¥–µ–Ω!');
          }
        } else {
          const errorText = await response.text();
          console.error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status, errorText);
          select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</option>';
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤:', error);
        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</option>';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø–æ–¥–±–æ—Ä–∫–∏
    async function loadItemsForCollection() {
      const type = document.querySelector('input[name="newCollectionType"]:checked').value;
      const container = document.getElementById('itemsSelector');
      
      console.log('loadItemsForCollection –≤—ã–∑–≤–∞–Ω–∞ —Å —Ç–∏–ø–æ–º:', type);
      console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä:', container);
      
      container.innerHTML = '<div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
      
      try {
        let items = [];
        
        if (type === 'restaurants') {
          const response = await fetch(api + '/collections/restaurants', { headers });
          if (response.ok) {
            items = await response.json();
          }
        } else {
          const selectedRestaurantId = document.getElementById('collectionRestaurantSelect').value;
          if (!selectedRestaurantId) {
            container.innerHTML = '<div class="meta">‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—Å—Ç–æ—Ä–∞–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥</div>';
            return;
          }
          
          const response = await fetch(api + '/collections/dishes?restaurant_id=' + selectedRestaurantId, { headers });
          if (response.ok) {
            items = await response.json();
          }
        }
        
        container.innerHTML = '';
        
        if (items.length === 0) {
          container.innerHTML = '<div class="meta">üì≠ –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>';
          return;
        }
        
        items.forEach((item, index) => {
          const itemEl = document.createElement('div');
          itemEl.className = 'collection-item-selector';
          itemEl.style.animationDelay = `${index * 0.1}s`;
          itemEl.innerHTML = `
            <div class="item-content">
              <input type="checkbox" id="item_${item.id}" value="${item.id}" data-item='${JSON.stringify(item)}' onchange="toggleItemSelection(this)">
              <label for="item_${item.id}" class="item-label">
                <div class="item-image">
                  ${item.image ? `<img src="${item.image}" alt="${item.name}">` : '<div class="no-image">üì∑</div>'}
                </div>
                <div class="item-info">
                  <div class="item-name">${item.name}</div>
                  ${item.subtitle ? `<div class="item-subtitle">${item.subtitle}</div>` : ''}
                </div>
              </label>
            </div>
            <div class="item-upload">
              <input type="file" id="upload_${item.id}" accept="image/*" style="display: none;" onchange="uploadItemImage(${item.id}, this)">
              <button type="button" onclick="event.stopPropagation(); document.getElementById('upload_${item.id}').click()" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ">üì∑</button>
            </div>
          `;
          
          // –î–µ–ª–∞–µ–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–π
          itemEl.addEventListener('click', (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
              const checkbox = itemEl.querySelector('input[type="checkbox"]');
              checkbox.checked = !checkbox.checked;
              toggleItemSelection(checkbox);
            }
          });
          
          container.appendChild(itemEl);
        });
      } catch (error) {
        container.innerHTML = '<div class="error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤</div>';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
    function toggleItemSelection(checkbox) {
      const itemSelector = checkbox.closest('.collection-item-selector');
      if (checkbox.checked) {
        itemSelector.classList.add('selected');
      } else {
        itemSelector.classList.remove('selected');
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    function getSelectedItems() {
      const selected = [];
      document.querySelectorAll('#itemsSelector input[type="checkbox"]:checked').forEach(checkbox => {
        const itemData = JSON.parse(checkbox.dataset.item);
        selected.push(itemData);
      });
      return selected;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
    async function uploadItemImage(itemId, fileInput) {
      const file = fileInput.files[0];
      if (!file) return;
      
      try {
        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch(api + '/collections/upload-image', {
          method: 'POST',
          headers: { 'X-Telegram-User-Id': String(uid) },
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
          const itemEl = document.querySelector(`#item_${itemId}`).closest('.collection-item-selector');
          const imgEl = itemEl.querySelector('.item-image img');
          if (imgEl) {
            imgEl.src = result.image_url;
          } else {
            itemEl.querySelector('.item-image').innerHTML = `<img src="${result.image_url}" alt="">`;
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç–∞
          const checkbox = document.querySelector(`#item_${itemId}`);
          const itemData = JSON.parse(checkbox.dataset.item);
          itemData.image = result.image_url;
          checkbox.dataset.item = JSON.stringify(itemData);
          
          showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
        } else {
          showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
        }
      } catch (error) {
        showMessage('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'error');
      }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π
    function toggleSection(contentId, iconId) {
      const content = document.getElementById(contentId);
      const icon = document.getElementById(iconId);
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
      } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–µ–∫—Ü–∏–π
    document.getElementById('quickActionsToggle').onclick = () => {
      toggleSection('quickActionsContent', 'quickActionsIcon');
    };
    
    document.getElementById('usersToggle').onclick = () => {
      toggleSection('usersContent', 'usersIcon');
    };
    
    document.getElementById('systemToggle').onclick = () => {
      toggleSection('systemContent', 'systemIcon');
    };
    
    document.getElementById('collectionsToggle').onclick = () => {
      toggleSection('collectionsContent', 'collectionsIcon');
    };
    
    document.getElementById('restaurantsToggle').onclick = () => {
      toggleSection('restaurantsContent', 'restaurantsIcon');
    };
    
    document.getElementById('statsToggle').onclick = () => {
      toggleSection('statsContent', 'statsIcon');
    };
    
    document.getElementById('reviewsToggle').onclick = () => {
      toggleSection('reviewsContent', 'reviewsIcon');
    };
    

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–∞—Å—Å—ã–ª–∫–∏
    function openBroadcastModal() {
      console.log('openBroadcastModal called');
      const modal = document.getElementById('broadcastModal');
      const textInput = document.getElementById('broadcastText');
      
      if (modal) {
        modal.style.display = 'flex';
        console.log('Modal opened');
      } else {
        console.error('Broadcast modal not found!');
      }
      
      if (textInput) {
        textInput.focus();
        console.log('Text input focused');
      } else {
        console.error('Broadcast text input not found!');
      }
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–¥–∏–∞ –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      const broadcastMediaInput = document.getElementById('broadcastMedia');
      console.log('broadcastMediaInput found:', !!broadcastMediaInput);
      
      if (broadcastMediaInput) {
        // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        broadcastMediaInput.removeEventListener('change', handleMediaChange);
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        broadcastMediaInput.addEventListener('change', handleMediaChange);
        console.log('Media input handler attached');
      } else {
        console.error('broadcastMediaInput not found!');
      }
    }
    
    function handleMediaChange(e) {
      console.log('File input changed');
      const file = e.target.files[0];
      console.log('Selected file:', file);
      
      if (file) {
        console.log('File type:', file.type);
        const reader = new FileReader();
        reader.onload = function(e) {
          console.log('FileReader loaded');
          const preview = document.getElementById('mediaPreview');
          const img = document.getElementById('mediaPreviewImg');
          
          console.log('Media preview elements:', { 
            preview: !!preview, 
            img: !!img,
            previewElement: preview,
            imgElement: img
          });
          
          if (preview && img) {
            if (file.type.startsWith('image/')) {
              console.log('Setting image preview');
              img.src = e.target.result;
              preview.style.display = 'block';
              console.log('Image preview shown, display:', preview.style.display);
            } else if (file.type.startsWith('video/')) {
              console.log('Setting video preview');
              img.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgcng9IjMiIGZpbGw9IiM2NDcyOGIiLz48cG9seWdvbiBwb2ludHM9IjEwLDggMTYsMTIgMTAsMTYiIGZpbGw9IndoaXRlIi8+PC9zdmc+';
              preview.style.display = 'block';
              console.log('Video preview shown, display:', preview.style.display);
            }
          } else {
            console.error('Media preview elements not found!');
            console.log('Available elements with mediaPreview:', document.querySelectorAll('[id*="mediaPreview"]'));
          }
        };
        reader.readAsDataURL(file);
      } else {
        console.log('No file selected');
      }
    }

    function closeBroadcastModal() {
      document.getElementById('broadcastModal').style.display = 'none';
      // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
      document.getElementById('broadcastText').value = '';
      document.getElementById('broadcastMedia').value = '';
      document.getElementById('mediaPreview').style.display = 'none';
      document.querySelector('input[name="recipients"][value="all"]').checked = true;
    }

    function removeMedia() {
      document.getElementById('broadcastMedia').value = '';
      document.getElementById('mediaPreview').style.display = 'none';
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –º–µ–¥–∏–∞ –±—É–¥–µ—Ç –≤ openBroadcastModal

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    const openBroadcastBtn = document.getElementById('openBroadcastModal');
    if (openBroadcastBtn) {
      openBroadcastBtn.onclick = openBroadcastModal;
      console.log('Broadcast button handler attached');
    } else {
      console.error('Broadcast button not found!');
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    const broadcastModal = document.getElementById('broadcastModal');
    if (broadcastModal) {
      broadcastModal.addEventListener('click', function(e) {
        if (e.target === this) {
          closeBroadcastModal();
        }
      });
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && document.getElementById('broadcastModal').style.display === 'flex') {
        closeBroadcastModal();
      }
    });

    async function sendBroadcast() {
      const text = document.getElementById('broadcastText').value.trim();
      const mediaFile = document.getElementById('broadcastMedia').files[0];
      const recipients = document.querySelector('input[name="recipients"]:checked').value;

      if (!text && !mediaFile) {
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –º–µ–¥–∏–∞ —Ñ–∞–π–ª');
        return;
      }

      const sendBtn = document.getElementById('sendBroadcast');
      const originalText = sendBtn.textContent;
      sendBtn.disabled = true;
      sendBtn.textContent = 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞...';

      try {
        const formData = new FormData();
        formData.append('text', text);
        formData.append('recipients', recipients);
        
        if (mediaFile) {
          formData.append('media', mediaFile);
        }

        const response = await fetch(api + '/admin/broadcast-with-media', {
          method: 'POST',
          headers: {
            'X-Telegram-User-Id': String(uid)
          },
          body: formData
        });

        if (!response.ok) {
          const error = await response.json().catch(() => ({ detail: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
          throw new Error(error.detail || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
        }

        const result = await response.json();
        alert(`‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞! –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${result.sent_count || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}`);
        closeBroadcastModal();
      } catch (error) {
        alert('–û—à–∏–±–∫–∞: ' + error.message);
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = originalText;
      }
    }

    // –ø–µ—Ä–≤–∏—á–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    load();
    loadUsers();
    loadStatsGlobal();
    populateRestaurantsSelect().then(() => { loadStatsByRestaurant(); });
    loadReviews();
    loadAdminCode();
    loadCollections();
    
  </script>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ -->
  <div id="broadcastModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üì¢ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</h3>
        <button class="modal-close" onclick="closeBroadcastModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</label>
          <textarea id="broadcastText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..." rows="4"></textarea>
        </div>
        
        <div class="form-group">
          <label>–ú–µ–¥–∏–∞ —Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
          <div class="media-upload">
            <input type="file" id="broadcastMedia" accept="image/*,video/*" style="display: none;">
            <button type="button" class="media-upload-btn" onclick="document.getElementById('broadcastMedia').click()">
              üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ
            </button>
            <div id="mediaPreview" class="media-preview" style="display: none;">
              <img id="mediaPreviewImg" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
              <button type="button" class="remove-media" onclick="removeMedia()">√ó</button>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:</label>
          <div class="recipients-options">
            <label class="radio-option">
              <span>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
              <input type="radio" name="recipients" value="all" checked>
            </label>
            <label class="radio-option">
              <span>–¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ</span>
              <input type="radio" name="recipients" value="active">
            </label>
            <label class="radio-option">
              <span>–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤</span>
              <input type="radio" name="recipients" value="admins">
            </label>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn-secondary" onclick="closeBroadcastModal()">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn-primary" id="sendBroadcast" onclick="sendBroadcast()">
          üì¢ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
        </button>
      </div>
    </div>
  </div>
</body>
</html>

